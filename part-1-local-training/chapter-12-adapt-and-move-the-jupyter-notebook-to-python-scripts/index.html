<!doctype html><html lang=en class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Workshop AI Days@HES-SO Machine Learning Operations - MLOps"><meta name=author content="Swiss AI Center contributors"><link href=https://swiss-ai-center.github.io/workshop-mlops/part-1-local-training/chapter-12-adapt-and-move-the-jupyter-notebook-to-python-scripts/ rel=canonical><link href=../chapter-11-run-a-simple-ml-experiment-with-jupyter-notebook/ rel=prev><link href=../chapter-13-initialize-git-and-dvc-for-local-training/ rel=next><link rel=icon href=../../assets/images/favicon.svg><meta name=generator content="mkdocs-1.6.1, mkdocs-material-9.5.42"><title>Chapter 1.2 - Adapt and move the Jupyter Notebook to Python scripts - AI Days@HES-SO Workshop MLOps</title><link rel=stylesheet href=../../assets/stylesheets/main.0253249f.min.css><link rel=stylesheet href=../../assets/stylesheets/palette.06af60db.min.css><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback"><style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style><link rel=stylesheet href=../../assets/stylesheets/extra.css><script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script><meta property=og:type content=website><meta property=og:title content="Chapter 1.2 - Adapt and move the Jupyter Notebook to Python scripts - AI Days@HES-SO Workshop MLOps"><meta property=og:description content="Workshop AI Days@HES-SO Machine Learning Operations - MLOps"><meta property=og:image content=https://swiss-ai-center.github.io/workshop-mlops/assets/images/social/part-1-local-training/chapter-12-adapt-and-move-the-jupyter-notebook-to-python-scripts.png><meta property=og:image:type content=image/png><meta property=og:image:width content=1200><meta property=og:image:height content=630><meta content=https://swiss-ai-center.github.io/workshop-mlops/part-1-local-training/chapter-12-adapt-and-move-the-jupyter-notebook-to-python-scripts/ property=og:url><meta name=twitter:card content=summary_large_image><meta name=twitter:title content="Chapter 1.2 - Adapt and move the Jupyter Notebook to Python scripts - AI Days@HES-SO Workshop MLOps"><meta name=twitter:description content="Workshop AI Days@HES-SO Machine Learning Operations - MLOps"><meta name=twitter:image content=https://swiss-ai-center.github.io/workshop-mlops/assets/images/social/part-1-local-training/chapter-12-adapt-and-move-the-jupyter-notebook-to-python-scripts.png><link href=../../assets/stylesheets/glightbox.min.css rel=stylesheet><style>
    html.glightbox-open { overflow: initial; height: 100%; }
    .gslide-title { margin-top: 0px; user-select: text; }
    .gslide-desc { color: #666; user-select: text; }
    .gslide-image img { background: white; }
    .gscrollbar-fixer { padding-right: 15px; }
    .gdesc-inner { font-size: 0.75rem; }
    body[data-md-color-scheme="slate"] .gdesc-inner { background: var(--md-default-bg-color);}
    body[data-md-color-scheme="slate"] .gslide-title { color: var(--md-default-fg-color);}
    body[data-md-color-scheme="slate"] .gslide-desc { color: var(--md-default-fg-color);}</style><script src=../../assets/javascripts/glightbox.min.js></script></head> <body dir=ltr data-md-color-scheme=default data-md-color-primary=indigo data-md-color-accent=indigo> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#chapter-12-adapt-and-move-the-jupyter-notebook-to-python-scripts class=md-skip> Skip to content </a> </div> <div data-md-component=announce> </div> <header class="md-header md-header--shadow md-header--lifted" data-md-component=header> <nav class="md-header__inner md-grid" aria-label=Header> <a href=../.. title="AI Days@HES-SO Workshop MLOps" class="md-header__button md-logo" aria-label="AI Days@HES-SO Workshop MLOps" data-md-component=logo> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M18.6 6.62c-1.44 0-2.8.56-3.77 1.53L7.8 14.39c-.64.64-1.49.99-2.4.99C3.53 15.38 2 13.87 2 12s1.53-3.38 3.4-3.38c.91 0 1.76.35 2.44 1.03l1.13 1 1.53-1.34L9.22 8.2A5.37 5.37 0 0 0 5.4 6.62C2.42 6.62 0 9.04 0 12s2.42 5.38 5.4 5.38c1.44 0 2.8-.56 3.77-1.53l7.03-6.24c.64-.64 1.49-.99 2.4-.99 1.87 0 3.4 1.51 3.4 3.38s-1.53 3.38-3.4 3.38c-.9 0-1.76-.35-2.44-1.03L15 13.34l-1.5 1.34 1.28 1.12a5.39 5.39 0 0 0 3.82 1.57c2.98 0 5.4-2.41 5.4-5.37 0-3-2.42-5.38-5.4-5.38"/></svg> </a> <label class="md-header__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg> </label> <div class=md-header__title data-md-component=header-title> <div class=md-header__ellipsis> <div class=md-header__topic> <span class=md-ellipsis> AI Days@HES-SO Workshop MLOps </span> </div> <div class=md-header__topic data-md-component=header-topic> <span class=md-ellipsis> Chapter 1.2 - Adapt and move the Jupyter Notebook to Python scripts </span> </div> </div> </div> <form class=md-header__option data-md-component=palette> <input class=md-option data-md-color-media=(prefers-color-scheme) data-md-color-scheme=default data-md-color-primary=indigo data-md-color-accent=indigo aria-label="Switch to light mode" type=radio name=__palette id=__palette_0> <label class="md-header__button md-icon" title="Switch to light mode" for=__palette_1 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="m14.3 16-.7-2h-3.2l-.7 2H7.8L11 7h2l3.2 9zM20 8.69V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12zm-9.15 3.96h2.3L12 9z"/></svg> </label> <input class=md-option data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme=default data-md-color-primary=indigo data-md-color-accent=indigo aria-label="Switch to dark mode" type=radio name=__palette id=__palette_1> <label class="md-header__button md-icon" title="Switch to dark mode" for=__palette_2 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg> </label> <input class=md-option data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme=slate data-md-color-primary=indigo data-md-color-accent=indigo aria-label="Switch to system preference" type=radio name=__palette id=__palette_2> <label class="md-header__button md-icon" title="Switch to system preference" for=__palette_0 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg> </label> </form> <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script> <label class="md-header__button md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg> </label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query aria-label=Search placeholder=Search autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query required> <label class="md-search__icon md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg> </label> <nav class=md-search__options aria-label=Search> <button type=reset class="md-search__icon md-icon" title=Clear aria-label=Clear tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg> </button> </nav> <div class=md-search__suggest data-md-component=search-suggest></div> </form> <div class=md-search__output> <div class=md-search__scrollwrap tabindex=0 data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> Initializing search </div> <ol class=md-search-result__list role=presentation></ol> </div> </div> </div> </div> </div> </nav> <nav class=md-tabs aria-label=Tabs data-md-component=tabs> <div class=md-grid> <ul class=md-tabs__list> <li class=md-tabs__item> <a href=../../syllabus/ class=md-tabs__link> 🏁 Introduction </a> </li> <li class="md-tabs__item md-tabs__item--active"> <a href=../introduction/ class=md-tabs__link> 🏠 Local training </a> </li> <li class=md-tabs__item> <a href=../../part-2-model-evaluation/introduction/ class=md-tabs__link> 📊 Model evaluation </a> </li> <li class=md-tabs__item> <a href=../../part-3-serve-and-deploy-the-model/introduction/ class=md-tabs__link> 🚚 Serve the model </a> </li> <li class=md-tabs__item> <a href=../../conclusion/ class=md-tabs__link> 🪄 Conclusion </a> </li> </ul> </div> </nav> </header> <div class=md-container data-md-component=container> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary md-nav--lifted" aria-label=Navigation data-md-level=0> <label class=md-nav__title for=__drawer> <a href=../.. title="AI Days@HES-SO Workshop MLOps" class="md-nav__button md-logo" aria-label="AI Days@HES-SO Workshop MLOps" data-md-component=logo> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M18.6 6.62c-1.44 0-2.8.56-3.77 1.53L7.8 14.39c-.64.64-1.49.99-2.4.99C3.53 15.38 2 13.87 2 12s1.53-3.38 3.4-3.38c.91 0 1.76.35 2.44 1.03l1.13 1 1.53-1.34L9.22 8.2A5.37 5.37 0 0 0 5.4 6.62C2.42 6.62 0 9.04 0 12s2.42 5.38 5.4 5.38c1.44 0 2.8-.56 3.77-1.53l7.03-6.24c.64-.64 1.49-.99 2.4-.99 1.87 0 3.4 1.51 3.4 3.38s-1.53 3.38-3.4 3.38c-.9 0-1.76-.35-2.44-1.03L15 13.34l-1.5 1.34 1.28 1.12a5.39 5.39 0 0 0 3.82 1.57c2.98 0 5.4-2.41 5.4-5.37 0-3-2.42-5.38-5.4-5.38"/></svg> </a> AI Days@HES-SO Workshop MLOps </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_1> <label class=md-nav__link for=__nav_1 id=__nav_1_label tabindex=0> <span class=md-ellipsis> 🏁 Introduction </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_1_label aria-expanded=false> <label class=md-nav__title for=__nav_1> <span class="md-nav__icon md-icon"></span> 🏁 Introduction </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../syllabus/ class=md-nav__link> <span class=md-ellipsis> Syllabus </span> </a> </li> <li class=md-nav__item> <a href=../../concept/ class=md-nav__link> <span class=md-ellipsis> Concept </span> </a> </li> <li class=md-nav__item> <a href=../../tools/ class=md-nav__link> <span class=md-ellipsis> Tools </span> </a> </li> <li class=md-nav__item> <a href=../../wsl2/ class=md-nav__link> <span class=md-ellipsis> Installing WSL 2 </span> </a> </li> <li class=md-nav__item> <a href=../../commands/ class=md-nav__link> <span class=md-ellipsis> Commands </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2 checked> <label class=md-nav__link for=__nav_2 id=__nav_2_label tabindex> <span class=md-ellipsis> 🏠 Local training </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_2_label aria-expanded=true> <label class=md-nav__title for=__nav_2> <span class="md-nav__icon md-icon"></span> 🏠 Local training </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../introduction/ class=md-nav__link> <span class=md-ellipsis> Introduction </span> </a> </li> <li class=md-nav__item> <a href=../chapter-11-run-a-simple-ml-experiment-with-jupyter-notebook/ class=md-nav__link> <span class=md-ellipsis> Chapter 1.1 - Run a simple ML experiment with Jupyter Notebook </span> </a> </li> <li class="md-nav__item md-nav__item--active"> <input class="md-nav__toggle md-toggle" type=checkbox id=__toc> <label class="md-nav__link md-nav__link--active" for=__toc> <span class=md-ellipsis> Chapter 1.2 - Adapt and move the Jupyter Notebook to Python scripts </span> <span class="md-nav__icon md-icon"></span> </label> <a href=./ class="md-nav__link md-nav__link--active"> <span class=md-ellipsis> Chapter 1.2 - Adapt and move the Jupyter Notebook to Python scripts </span> </a> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#introduction class=md-nav__link> <span class=md-ellipsis> Introduction </span> </a> </li> <li class=md-nav__item> <a href=#steps class=md-nav__link> <span class=md-ellipsis> Steps </span> </a> <nav class=md-nav aria-label=Steps> <ul class=md-nav__list> <li class=md-nav__item> <a href=#set-up-a-new-project-directory class=md-nav__link> <span class=md-ellipsis> Set up a new project directory </span> </a> </li> <li class=md-nav__item> <a href=#set-up-the-dataset class=md-nav__link> <span class=md-ellipsis> Set up the dataset </span> </a> </li> <li class=md-nav__item> <a href=#set-up-a-python-environment class=md-nav__link> <span class=md-ellipsis> Set up a Python environment </span> </a> </li> <li class=md-nav__item> <a href=#split-the-jupyter-notebook-into-scripts class=md-nav__link> <span class=md-ellipsis> Split the Jupyter Notebook into scripts </span> </a> <nav class=md-nav aria-label="Split the Jupyter Notebook into scripts"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#move-the-parameters-to-its-own-file class=md-nav__link> <span class=md-ellipsis> Move the parameters to its own file </span> </a> </li> <li class=md-nav__item> <a href=#move-the-preparation-step-to-its-own-file class=md-nav__link> <span class=md-ellipsis> Move the preparation step to its own file </span> </a> </li> <li class=md-nav__item> <a href=#move-the-train-step-to-its-own-file class=md-nav__link> <span class=md-ellipsis> Move the train step to its own file </span> </a> </li> <li class=md-nav__item> <a href=#move-the-evaluate-step-to-its-own-file class=md-nav__link> <span class=md-ellipsis> Move the evaluate step to its own file </span> </a> </li> <li class=md-nav__item> <a href=#create-the-seed-helper-function class=md-nav__link> <span class=md-ellipsis> Create the seed helper function </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#create-a-readmemd-file class=md-nav__link> <span class=md-ellipsis> Create a README.md file </span> </a> </li> <li class=md-nav__item> <a href=#check-the-results class=md-nav__link> <span class=md-ellipsis> Check the results </span> </a> </li> <li class=md-nav__item> <a href=#run-the-experiment class=md-nav__link> <span class=md-ellipsis> Run the experiment </span> </a> </li> <li class=md-nav__item> <a href=#check-the-results_1 class=md-nav__link> <span class=md-ellipsis> Check the results </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#summary class=md-nav__link> <span class=md-ellipsis> Summary </span> </a> </li> <li class=md-nav__item> <a href=#state-of-the-mlops-process class=md-nav__link> <span class=md-ellipsis> State of the MLOps process </span> </a> </li> <li class=md-nav__item> <a href=#sources class=md-nav__link> <span class=md-ellipsis> Sources </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../chapter-13-initialize-git-and-dvc-for-local-training/ class=md-nav__link> <span class=md-ellipsis> Chapter 1.3 - Initialize Git and DVC for local training </span> </a> </li> <li class=md-nav__item> <a href=../conclusion/ class=md-nav__link> <span class=md-ellipsis> Conclusion </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_3> <label class=md-nav__link for=__nav_3 id=__nav_3_label tabindex=0> <span class=md-ellipsis> 📊 Model evaluation </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_3_label aria-expanded=false> <label class=md-nav__title for=__nav_3> <span class="md-nav__icon md-icon"></span> 📊 Model evaluation </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../part-2-model-evaluation/introduction/ class=md-nav__link> <span class=md-ellipsis> Introduction </span> </a> </li> <li class=md-nav__item> <a href=../../part-2-model-evaluation/chapter-21-reproduce-the-ml-experiment-with-dvc/ class=md-nav__link> <span class=md-ellipsis> Chapter 2.1 - Reproduce the ML experiment with DVC </span> </a> </li> <li class=md-nav__item> <a href=../../part-2-model-evaluation/chapter-22-track-model-evolution-with-dvc/ class=md-nav__link> <span class=md-ellipsis> Chapter 2.2 - Track model evolution with DVC </span> </a> </li> <li class=md-nav__item> <a href=../../part-2-model-evaluation/conclusion/ class=md-nav__link> <span class=md-ellipsis> Conclusion </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_4> <label class=md-nav__link for=__nav_4 id=__nav_4_label tabindex=0> <span class=md-ellipsis> 🚚 Serve the model </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_4_label aria-expanded=false> <label class=md-nav__title for=__nav_4> <span class="md-nav__icon md-icon"></span> 🚚 Serve the model </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../part-3-serve-and-deploy-the-model/introduction/ class=md-nav__link> <span class=md-ellipsis> Introduction </span> </a> </li> <li class=md-nav__item> <a href=../../part-3-serve-and-deploy-the-model/chapter-31-save-and-load-the-model-with-bentoml/ class=md-nav__link> <span class=md-ellipsis> Chapter 3.1 - Save and load the model with BentoML </span> </a> </li> <li class=md-nav__item> <a href=../../part-3-serve-and-deploy-the-model/chapter-32-serve-the-model-locally-with-bentoml/ class=md-nav__link> <span class=md-ellipsis> Chapter 3.2 - Serve the model locally with BentoML </span> </a> </li> <li class=md-nav__item> <a href=../../part-3-serve-and-deploy-the-model/chapter-33-build-and-publish-the-model-with-bentoml-and-docker-locally/ class=md-nav__link> <span class=md-ellipsis> Chapter 3.3 - Build and publish the model with BentoML and Docker locally </span> </a> </li> <li class=md-nav__item> <a href=../../part-3-serve-and-deploy-the-model/conclusion/ class=md-nav__link> <span class=md-ellipsis> Conclusion </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_5> <label class=md-nav__link for=__nav_5 id=__nav_5_label tabindex=0> <span class=md-ellipsis> 🪄 Conclusion </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_5_label aria-expanded=false> <label class=md-nav__title for=__nav_5> <span class="md-nav__icon md-icon"></span> 🪄 Conclusion </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../conclusion/ class=md-nav__link> <span class=md-ellipsis> Conclusion </span> </a> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=sidebar data-md-type=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#introduction class=md-nav__link> <span class=md-ellipsis> Introduction </span> </a> </li> <li class=md-nav__item> <a href=#steps class=md-nav__link> <span class=md-ellipsis> Steps </span> </a> <nav class=md-nav aria-label=Steps> <ul class=md-nav__list> <li class=md-nav__item> <a href=#set-up-a-new-project-directory class=md-nav__link> <span class=md-ellipsis> Set up a new project directory </span> </a> </li> <li class=md-nav__item> <a href=#set-up-the-dataset class=md-nav__link> <span class=md-ellipsis> Set up the dataset </span> </a> </li> <li class=md-nav__item> <a href=#set-up-a-python-environment class=md-nav__link> <span class=md-ellipsis> Set up a Python environment </span> </a> </li> <li class=md-nav__item> <a href=#split-the-jupyter-notebook-into-scripts class=md-nav__link> <span class=md-ellipsis> Split the Jupyter Notebook into scripts </span> </a> <nav class=md-nav aria-label="Split the Jupyter Notebook into scripts"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#move-the-parameters-to-its-own-file class=md-nav__link> <span class=md-ellipsis> Move the parameters to its own file </span> </a> </li> <li class=md-nav__item> <a href=#move-the-preparation-step-to-its-own-file class=md-nav__link> <span class=md-ellipsis> Move the preparation step to its own file </span> </a> </li> <li class=md-nav__item> <a href=#move-the-train-step-to-its-own-file class=md-nav__link> <span class=md-ellipsis> Move the train step to its own file </span> </a> </li> <li class=md-nav__item> <a href=#move-the-evaluate-step-to-its-own-file class=md-nav__link> <span class=md-ellipsis> Move the evaluate step to its own file </span> </a> </li> <li class=md-nav__item> <a href=#create-the-seed-helper-function class=md-nav__link> <span class=md-ellipsis> Create the seed helper function </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#create-a-readmemd-file class=md-nav__link> <span class=md-ellipsis> Create a README.md file </span> </a> </li> <li class=md-nav__item> <a href=#check-the-results class=md-nav__link> <span class=md-ellipsis> Check the results </span> </a> </li> <li class=md-nav__item> <a href=#run-the-experiment class=md-nav__link> <span class=md-ellipsis> Run the experiment </span> </a> </li> <li class=md-nav__item> <a href=#check-the-results_1 class=md-nav__link> <span class=md-ellipsis> Check the results </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#summary class=md-nav__link> <span class=md-ellipsis> Summary </span> </a> </li> <li class=md-nav__item> <a href=#state-of-the-mlops-process class=md-nav__link> <span class=md-ellipsis> State of the MLOps process </span> </a> </li> <li class=md-nav__item> <a href=#sources class=md-nav__link> <span class=md-ellipsis> Sources </span> </a> </li> </ul> </nav> </div> </div> </div> <div class=md-content data-md-component=content> <article class="md-content__inner md-typeset"> <a href=blob/main/docs/part-1-local-training/chapter-12-adapt-and-move-the-jupyter-notebook-to-python-scripts.md title="Edit this page" class="md-content__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M10 20H6V4h7v5h5v3.1l2-2V8l-6-6H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h4zm10.2-7c.1 0 .3.1.4.2l1.3 1.3c.2.2.2.6 0 .8l-1 1-2.1-2.1 1-1c.1-.1.2-.2.4-.2m0 3.9L14.1 23H12v-2.1l6.1-6.1z"/></svg> </a> <a href=blob/main/docs/part-1-local-training/chapter-12-adapt-and-move-the-jupyter-notebook-to-python-scripts.md title="View source of this page" class="md-content__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M17 18c.56 0 1 .44 1 1s-.44 1-1 1-1-.44-1-1 .44-1 1-1m0-3c-2.73 0-5.06 1.66-6 4 .94 2.34 3.27 4 6 4s5.06-1.66 6-4c-.94-2.34-3.27-4-6-4m0 6.5a2.5 2.5 0 0 1-2.5-2.5 2.5 2.5 0 0 1 2.5-2.5 2.5 2.5 0 0 1 2.5 2.5 2.5 2.5 0 0 1-2.5 2.5M9.27 20H6V4h7v5h5v4.07c.7.08 1.36.25 2 .49V8l-6-6H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h4.5a8.2 8.2 0 0 1-1.23-2"/></svg> </a> <h1 id=chapter-12-adapt-and-move-the-jupyter-notebook-to-python-scripts>Chapter 1.2 - Adapt and move the Jupyter Notebook to Python scripts<a class=headerlink href=#chapter-12-adapt-and-move-the-jupyter-notebook-to-python-scripts title="Permanent link">&para;</a></h1> <h2 id=introduction>Introduction<a class=headerlink href=#introduction title="Permanent link">&para;</a></h2> <p>Jupyter Notebooks provide an interactive environment where code can be executed and results can be visualized. They combine code, text explanations, visualizations, and media in a single document, making it a flexible tool to document a ML experiment.</p> <p>However, they have severe limitations, such as challenges with reproducibility, scalability, experiment tracking, and standardization. Integrating Jupyter Notebooks into <a href=../../tools/ ><span class=twemoji><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="m14.25.18.9.2.73.26.59.3.45.32.34.34.25.34.16.33.1.3.04.26.02.2-.01.13V8.5l-.05.63-.13.55-.21.46-.26.38-.3.31-.33.25-.35.19-.35.14-.33.1-.3.07-.26.04-.21.02H8.77l-.69.05-.59.14-.5.22-.41.27-.33.32-.27.35-.2.36-.15.37-.1.35-.07.32-.04.27-.02.21v3.06H3.17l-.21-.03-.28-.07-.32-.12-.35-.18-.36-.26-.36-.36-.35-.46-.32-.59-.28-.73-.21-.88-.14-1.05-.05-1.23.06-1.22.16-1.04.24-.87.32-.71.36-.57.4-.44.42-.33.42-.24.4-.16.36-.1.32-.05.24-.01h.16l.06.01h8.16v-.83H6.18l-.01-2.75-.02-.37.05-.34.11-.31.17-.28.25-.26.31-.23.38-.2.44-.18.51-.15.58-.12.64-.1.71-.06.77-.04.84-.02 1.27.05zm-6.3 1.98-.23.33-.08.41.08.41.23.34.33.22.41.09.41-.09.33-.22.23-.34.08-.41-.08-.41-.23-.33-.33-.22-.41-.09-.41.09zm13.09 3.95.28.06.32.12.35.18.36.27.36.35.35.47.32.59.28.73.21.88.14 1.04.05 1.23-.06 1.23-.16 1.04-.24.86-.32.71-.36.57-.4.45-.42.33-.42.24-.4.16-.36.09-.32.05-.24.02-.16-.01h-8.22v.82h5.84l.01 2.76.02.36-.05.34-.11.31-.17.29-.25.25-.31.24-.38.2-.44.17-.51.15-.58.13-.64.09-.71.07-.77.04-.84.01-1.27-.04-1.07-.14-.9-.2-.73-.25-.59-.3-.45-.33-.34-.34-.25-.34-.16-.33-.1-.3-.04-.25-.02-.2.01-.13v-5.34l.05-.64.13-.54.21-.46.26-.38.3-.32.33-.24.35-.2.35-.14.33-.1.3-.06.26-.04.21-.02.13-.01h5.84l.69-.05.59-.14.5-.21.41-.28.33-.32.27-.35.2-.36.15-.36.1-.35.07-.32.04-.28.02-.21V6.07h2.09l.14.01zm-6.47 14.25-.23.33-.08.41.08.41.23.33.33.23.41.08.41-.08.33-.23.23-.33.08-.41-.08-.41-.23-.33-.33-.23-.41-.08-.41.08z"/></svg></span> Python</a> scripts suitable for running ML experiments in a more modular and reproducible manner can help address these issues and enhance the overall ML development process.</p> <p><a href=../../tools/ ><span class=twemoji><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="m14.25.18.9.2.73.26.59.3.45.32.34.34.25.34.16.33.1.3.04.26.02.2-.01.13V8.5l-.05.63-.13.55-.21.46-.26.38-.3.31-.33.25-.35.19-.35.14-.33.1-.3.07-.26.04-.21.02H8.77l-.69.05-.59.14-.5.22-.41.27-.33.32-.27.35-.2.36-.15.37-.1.35-.07.32-.04.27-.02.21v3.06H3.17l-.21-.03-.28-.07-.32-.12-.35-.18-.36-.26-.36-.36-.35-.46-.32-.59-.28-.73-.21-.88-.14-1.05-.05-1.23.06-1.22.16-1.04.24-.87.32-.71.36-.57.4-.44.42-.33.42-.24.4-.16.36-.1.32-.05.24-.01h.16l.06.01h8.16v-.83H6.18l-.01-2.75-.02-.37.05-.34.11-.31.17-.28.25-.26.31-.23.38-.2.44-.18.51-.15.58-.12.64-.1.71-.06.77-.04.84-.02 1.27.05zm-6.3 1.98-.23.33-.08.41.08.41.23.34.33.22.41.09.41-.09.33-.22.23-.34.08-.41-.08-.41-.23-.33-.33-.22-.41-.09-.41.09zm13.09 3.95.28.06.32.12.35.18.36.27.36.35.35.47.32.59.28.73.21.88.14 1.04.05 1.23-.06 1.23-.16 1.04-.24.86-.32.71-.36.57-.4.45-.42.33-.42.24-.4.16-.36.09-.32.05-.24.02-.16-.01h-8.22v.82h5.84l.01 2.76.02.36-.05.34-.11.31-.17.29-.25.25-.31.24-.38.2-.44.17-.51.15-.58.13-.64.09-.71.07-.77.04-.84.01-1.27-.04-1.07-.14-.9-.2-.73-.25-.59-.3-.45-.33-.34-.34-.25-.34-.16-.33-.1-.3-.04-.25-.02-.2.01-.13v-5.34l.05-.64.13-.54.21-.46.26-.38.3-.32.33-.24.35-.2.35-.14.33-.1.3-.06.26-.04.21-.02.13-.01h5.84l.69-.05.59-.14.5-.21.41-.28.33-.32.27-.35.2-.36.15-.36.1-.35.07-.32.04-.28.02-.21V6.07h2.09l.14.01zm-6.47 14.25-.23.33-.08.41.08.41.23.33.33.23.41.08.41-.08.33-.23.23-.33.08-.41-.08-.41-.23-.33-.33-.23-.41-.08-.41.08z"/></svg></span> pip</a> is the standard package manager for Python. It is used to install and manage dependencies in a Python environment.</p> <p>In this chapter, you will learn how to:</p> <ol> <li>Set up a Python environment using pip</li> <li>Adapt the content of the Jupyter Notebook into Python scripts</li> <li>Launch the experiment locally</li> </ol> <p>The following diagram illustrates the control flow of the experiment at the end of this chapter:</p> <pre class=mermaid><code>flowchart LR
    subgraph workspaceGraph[WORKSPACE]
        prepare[prepare.py] --&gt; train
        train[train.py] --&gt; evaluate[evaluate.py]
        params[params.yaml] -.- prepare
        params -.- train
        data[data/raw] --&gt; prepare
    end
    style data opacity:0.4,color:#7f7f7f80</code></pre> <p>Let's get started!</p> <h2 id=steps>Steps<a class=headerlink href=#steps title="Permanent link">&para;</a></h2> <h3 id=set-up-a-new-project-directory>Set up a new project directory<a class=headerlink href=#set-up-a-new-project-directory title="Permanent link">&para;</a></h3> <p>For the rest of the guide, you will work in a new directory. This will allow you to use the Jupyter Notebook directory as a reference.</p> <p>Start by ensuring you have left the virtual environment created in the previous chapter:</p> <div class=highlight><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>Execute the following command(s) in a terminal</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-0-1>1</a></span>
<span class=normal><a href=#__codelineno-0-2>2</a></span></pre></div></td><td class=code><div><pre><span></span><code><a id=__codelineno-0-1 name=__codelineno-0-1></a><span class=c1># Deactivate the virtual environment</span>
<a id=__codelineno-0-2 name=__codelineno-0-2></a>deactivate
</code></pre></div></td></tr></table></div> <p>Next, exit from the current directory and create a new one:</p> <div class=highlight><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>Execute the following command(s) in a terminal</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-1-1>1</a></span>
<span class=normal><a href=#__codelineno-1-2>2</a></span>
<span class=normal><a href=#__codelineno-1-3>3</a></span>
<span class=normal><a href=#__codelineno-1-4>4</a></span>
<span class=normal><a href=#__codelineno-1-5>5</a></span>
<span class=normal><a href=#__codelineno-1-6>6</a></span>
<span class=normal><a href=#__codelineno-1-7>7</a></span>
<span class=normal><a href=#__codelineno-1-8>8</a></span></pre></div></td><td class=code><div><pre><span></span><code><a id=__codelineno-1-1 name=__codelineno-1-1></a><span class=c1># Move back to the root directory</span>
<a id=__codelineno-1-2 name=__codelineno-1-2></a><span class=nb>cd</span><span class=w> </span>..
<a id=__codelineno-1-3 name=__codelineno-1-3></a>
<a id=__codelineno-1-4 name=__codelineno-1-4></a><span class=c1># Create the new working directory</span>
<a id=__codelineno-1-5 name=__codelineno-1-5></a>mkdir<span class=w> </span>a-guide-to-mlops
<a id=__codelineno-1-6 name=__codelineno-1-6></a>
<a id=__codelineno-1-7 name=__codelineno-1-7></a><span class=c1># Switch to the new working directory</span>
<a id=__codelineno-1-8 name=__codelineno-1-8></a><span class=nb>cd</span><span class=w> </span>a-guide-to-mlops
</code></pre></div></td></tr></table></div> <h3 id=set-up-the-dataset>Set up the dataset<a class=headerlink href=#set-up-the-dataset title="Permanent link">&para;</a></h3> <p>You will use the same dataset as in the previous chapter. Copy the <code>data</code> folder from the previous chapter to your new directory:</p> <div class=highlight><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>Execute the following command(s) in a terminal</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-2-1>1</a></span>
<span class=normal><a href=#__codelineno-2-2>2</a></span></pre></div></td><td class=code><div><pre><span></span><code><a id=__codelineno-2-1 name=__codelineno-2-1></a><span class=c1># Copy the data folder from the previous chapter</span>
<a id=__codelineno-2-2 name=__codelineno-2-2></a>cp<span class=w> </span>-r<span class=w> </span>../a-guide-to-mlops-jupyter-notebook/data<span class=w> </span>.
</code></pre></div></td></tr></table></div> <h3 id=set-up-a-python-environment>Set up a Python environment<a class=headerlink href=#set-up-a-python-environment title="Permanent link">&para;</a></h3> <p>Firstly, create the virtual environment:</p> <details class=tip> <summary>Not familiar with virtual environments? Read this!</summary> <p><strong>What are virtual environments?</strong></p> <p>Python <strong>virtual environments</strong> are essential tools for managing dependencies and isolating project environments. They allow developers to create separate, self-contained environments for different projects, ensuring that each project has its own set of dependencies <strong>without interfering</strong> with one another.</p> <p>This is particularly important when working on multiple projects with different versions of libraries or packages.</p> <p><strong>How do virtual environments work?</strong></p> <p>Virtual environments work by creating a local directory that contains a Python interpreter and a copy of the desired Python packages. When activated, the virtual environment modifies the system's PATH variable to prioritize the interpreter and packages within the local directory.</p> <p>This ensures that when running Python commands, the system uses the specific interpreter and packages from the virtual environment, effectively isolating the project from the global Python installation.</p> <p><strong>How to manage virtual environments?</strong></p> <ul> <li>Create a virtual environment: <code class=highlight>python3.12<span class=w> </span>-m<span class=w> </span>venv<span class=w> </span>.venv</code></li> <li>Activate the virtual environment: <code class=highlight><span class=nb>source</span><span class=w> </span>.venv/bin/activate</code></li> <li>Deactivate the virtual environment: <code class=highlight>deactivate</code></li> </ul> <p><strong><em>Conclusion</em></strong></p> <p>Virtual environments are essential for dependency management and environment isolation. They ensure stability, reproducibility, and clean project separation. By using virtual environments, you achieve smoother collaboration, easier debugging, and reliable deployment.</p> </details> <div class=highlight><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>Execute the following command(s) in a terminal</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-3-1>1</a></span>
<span class=normal><a href=#__codelineno-3-2>2</a></span>
<span class=normal><a href=#__codelineno-3-3>3</a></span>
<span class=normal><a href=#__codelineno-3-4>4</a></span>
<span class=normal><a href=#__codelineno-3-5>5</a></span></pre></div></td><td class=code><div><pre><span></span><code><a id=__codelineno-3-1 name=__codelineno-3-1></a><span class=c1># Create the environment</span>
<a id=__codelineno-3-2 name=__codelineno-3-2></a>python3.12<span class=w> </span>-m<span class=w> </span>venv<span class=w> </span>.venv
<a id=__codelineno-3-3 name=__codelineno-3-3></a>
<a id=__codelineno-3-4 name=__codelineno-3-4></a><span class=c1># Activate the environment</span>
<a id=__codelineno-3-5 name=__codelineno-3-5></a><span class=nb>source</span><span class=w> </span>.venv/bin/activate
</code></pre></div></td></tr></table></div> <p>Create a <code>requirements.txt</code> file to list the dependencies:</p> <div class=highlight><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>requirements.txt</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-4-1>1</a></span>
<span class=normal><a href=#__codelineno-4-2>2</a></span>
<span class=normal><a href=#__codelineno-4-3>3</a></span></pre></div></td><td class=code><div><pre><span></span><code><a id=__codelineno-4-1 name=__codelineno-4-1></a>tensorflow==2.17.1
<a id=__codelineno-4-2 name=__codelineno-4-2></a>matplotlib==3.9.3
<a id=__codelineno-4-3 name=__codelineno-4-3></a>pyyaml==6.0.2
</code></pre></div></td></tr></table></div> <p>Install the dependencies:</p> <div class=highlight><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>Execute the following command(s) in a terminal</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-5-1>1</a></span>
<span class=normal><a href=#__codelineno-5-2>2</a></span></pre></div></td><td class=code><div><pre><span></span><code><a id=__codelineno-5-1 name=__codelineno-5-1></a><span class=c1># Install the dependencies</span>
<a id=__codelineno-5-2 name=__codelineno-5-2></a>pip<span class=w> </span>install<span class=w> </span>--requirement<span class=w> </span>requirements.txt
</code></pre></div></td></tr></table></div> <p>Create a freeze file to list the dependencies with their versions to ensure that transitive dependencies are also listed. This will help with reproducibility:</p> <details class=tip> <summary>Not familiar with freezing dependencies? Read this!</summary> <p>When working on Python projects, managing dependencies is crucial for maintaining a stable and reproducible development environment.</p> <p><strong>Understanding requirements.txt</strong></p> <p>The requirements.txt file is a commonly used approach to specify project dependencies. It lists all the high-level dependencies required for your project, including their specific versions. Each line in the file typically follows the format: <code>package_name==version</code>.</p> <p><strong>Freezing dependencies</strong></p> <p>Freezing dependencies refers to fixing the versions of all transitive dependencies, ensuring that the same versions are installed consistently across different environments. This is crucial for reproducibility, as it guarantees that everyone working on the project has the exact same dependencies.</p> <p><strong>Separating high-level and transitive dependencies</strong></p> <p>To better control and manage your project's dependencies, it's beneficial to separate high-level dependencies from transitive dependencies. This approach allows for clearer identification of the core functionality packages and their required versions, ensuring a more focused and stable development environment.</p> <ul> <li> <p><code>requirements.txt</code>: This file contains the high-level dependencies explicitly required by your project. It should include packages necessary for your project's core functionality while excluding packages that are indirectly required by other dependencies. By isolating the high-level dependencies, you maintain a clear distinction between the essential packages and the ones brought in transitively.</p> </li> <li> <p><code>requirements-freeze.txt</code>: This file includes all the transitive dependencies required by the high-level dependencies. It ensures that all the packages needed for the project, including their versions, are recorded in a separate file. This separation allows for a more flexible and controlled approach when updating transitive dependencies while maintaining the reproducibility of your project.</p> </li> </ul> <p><strong>How to update dependencies</strong></p> <p>When updating dependencies, it is essential to primarily modify the high-level <code>requirements.txt</code> file with the desired versions or new packages. Then, generate an updated <code>requirements-freeze.txt</code> file to capture the updated transitive dependencies accurately.</p> <p><strong>Conclusion</strong></p> <p>Prioritizing stability and reproducibility in your project's dependency management is crucial for minimizing compatibility issues, avoiding unexpected bugs, and ensuring a smooth and reliable development process.</p> <p>By using separate requirements files for high-level and transitive dependencies, you gain better visibility and control over the dependencies required by your project. This approach promotes a stable and reproducible development environment while allowing you to update specific packages and their versions when needed. By following these practices, you can ensure the long-term success of your Python projects.</p> </details> <div class=highlight><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>Execute the following command(s) in a terminal</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-6-1>1</a></span>
<span class=normal><a href=#__codelineno-6-2>2</a></span></pre></div></td><td class=code><div><pre><span></span><code><a id=__codelineno-6-1 name=__codelineno-6-1></a><span class=c1># Freeze the dependencies</span>
<a id=__codelineno-6-2 name=__codelineno-6-2></a>pip<span class=w> </span>freeze<span class=w> </span>--local<span class=w> </span>--all<span class=w> </span>&gt;<span class=w> </span>requirements-freeze.txt
</code></pre></div></td></tr></table></div> <ul> <li>The <code>--local</code> flag ensures that if a virtualenv has global access, it will not output globally-installed packages.</li> <li>The <code>--all</code> flag ensures that it does not skip these packages in the output: <code>setuptools</code>, <code>wheel</code>, <code>pip</code>, <code>distribute</code>.</li> </ul> <h3 id=split-the-jupyter-notebook-into-scripts>Split the Jupyter Notebook into scripts<a class=headerlink href=#split-the-jupyter-notebook-into-scripts title="Permanent link">&para;</a></h3> <p>You will split the Jupyter Notebook in a codebase made of separate Python scripts with well defined role. These scripts will be able to be called on the command line, making it ideal for automation tasks.</p> <p>The following table describes the files that you will create in this codebase:</p> <table> <thead> <tr> <th><strong>File</strong></th> <th><strong>Description</strong></th> <th><strong>Input</strong></th> <th><strong>Output</strong></th> </tr> </thead> <tbody> <tr> <td><code>params.yaml</code></td> <td>The parameters to run the ML experiment</td> <td>-</td> <td>-</td> </tr> <tr> <td><code>src/prepare.py</code></td> <td>Prepare the dataset to run the ML experiment</td> <td>The dataset to prepare in <code>data/raw</code> directory</td> <td>The prepared data in <code>data/prepared</code> directory</td> </tr> <tr> <td><code>src/train.py</code></td> <td>Train the ML model</td> <td>The prepared dataset</td> <td>The model trained with the dataset</td> </tr> <tr> <td><code>src/evaluate.py</code></td> <td>Evaluate the ML model using scikit-learn</td> <td>The model to evaluate</td> <td>The results of the model evaluation in <code>evaluation</code> directory</td> </tr> <tr> <td><code>src/utils/seed.py</code></td> <td>Util function to fix the seed</td> <td>-</td> <td>-</td> </tr> </tbody> </table> <h4 id=move-the-parameters-to-its-own-file>Move the parameters to its own file<a class=headerlink href=#move-the-parameters-to-its-own-file title="Permanent link">&para;</a></h4> <p>Let's split the parameters to run the ML experiment with in a distinct file:</p> <div class=highlight><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>params.yaml</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-7-1> 1</a></span>
<span class=normal><a href=#__codelineno-7-2> 2</a></span>
<span class=normal><a href=#__codelineno-7-3> 3</a></span>
<span class=normal><a href=#__codelineno-7-4> 4</a></span>
<span class=normal><a href=#__codelineno-7-5> 5</a></span>
<span class=normal><a href=#__codelineno-7-6> 6</a></span>
<span class=normal><a href=#__codelineno-7-7> 7</a></span>
<span class=normal><a href=#__codelineno-7-8> 8</a></span>
<span class=normal><a href=#__codelineno-7-9> 9</a></span>
<span class=normal><a href=#__codelineno-7-10>10</a></span>
<span class=normal><a href=#__codelineno-7-11>11</a></span>
<span class=normal><a href=#__codelineno-7-12>12</a></span>
<span class=normal><a href=#__codelineno-7-13>13</a></span></pre></div></td><td class=code><div><pre><span></span><code><a id=__codelineno-7-1 name=__codelineno-7-1></a><span class=nt>prepare</span><span class=p>:</span>
<a id=__codelineno-7-2 name=__codelineno-7-2></a><span class=w>  </span><span class=nt>seed</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">77</span>
<a id=__codelineno-7-3 name=__codelineno-7-3></a><span class=w>  </span><span class=nt>split</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">0.2</span>
<a id=__codelineno-7-4 name=__codelineno-7-4></a><span class=w>  </span><span class=nt>image_size</span><span class=p>:</span><span class=w> </span><span class="p p-Indicator">[</span><span class=nv>32</span><span class="p p-Indicator">,</span><span class=w> </span><span class=nv>32</span><span class="p p-Indicator">]</span>
<a id=__codelineno-7-5 name=__codelineno-7-5></a><span class=w>  </span><span class=nt>grayscale</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">True</span>
<a id=__codelineno-7-6 name=__codelineno-7-6></a>
<a id=__codelineno-7-7 name=__codelineno-7-7></a><span class=nt>train</span><span class=p>:</span>
<a id=__codelineno-7-8 name=__codelineno-7-8></a><span class=w>  </span><span class=nt>seed</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">77</span>
<a id=__codelineno-7-9 name=__codelineno-7-9></a><span class=w>  </span><span class=nt>lr</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">0.0001</span>
<a id=__codelineno-7-10 name=__codelineno-7-10></a><span class=w>  </span><span class=nt>epochs</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">5</span>
<a id=__codelineno-7-11 name=__codelineno-7-11></a><span class=w>  </span><span class=nt>conv_size</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">32</span>
<a id=__codelineno-7-12 name=__codelineno-7-12></a><span class=w>  </span><span class=nt>dense_size</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">64</span>
<a id=__codelineno-7-13 name=__codelineno-7-13></a><span class=w>  </span><span class=nt>output_classes</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">11</span>
</code></pre></div></td></tr></table></div> <h4 id=move-the-preparation-step-to-its-own-file>Move the preparation step to its own file<a class=headerlink href=#move-the-preparation-step-to-its-own-file title="Permanent link">&para;</a></h4> <p>The <code>src/prepare.py</code> script will prepare the dataset. Let's take this opportunity to refactor the code to make it more modular and explicit using functions:</p> <div class=highlight><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>src/prepare.py</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-8-1> 1</a></span>
<span class=normal><a href=#__codelineno-8-2> 2</a></span>
<span class=normal><a href=#__codelineno-8-3> 3</a></span>
<span class=normal><a href=#__codelineno-8-4> 4</a></span>
<span class=normal><a href=#__codelineno-8-5> 5</a></span>
<span class=normal><a href=#__codelineno-8-6> 6</a></span>
<span class=normal><a href=#__codelineno-8-7> 7</a></span>
<span class=normal><a href=#__codelineno-8-8> 8</a></span>
<span class=normal><a href=#__codelineno-8-9> 9</a></span>
<span class=normal><a href=#__codelineno-8-10>10</a></span>
<span class=normal><a href=#__codelineno-8-11>11</a></span>
<span class=normal><a href=#__codelineno-8-12>12</a></span>
<span class=normal><a href=#__codelineno-8-13>13</a></span>
<span class=normal><a href=#__codelineno-8-14>14</a></span>
<span class=normal><a href=#__codelineno-8-15>15</a></span>
<span class=normal><a href=#__codelineno-8-16>16</a></span>
<span class=normal><a href=#__codelineno-8-17>17</a></span>
<span class=normal><a href=#__codelineno-8-18>18</a></span>
<span class=normal><a href=#__codelineno-8-19>19</a></span>
<span class=normal><a href=#__codelineno-8-20>20</a></span>
<span class=normal><a href=#__codelineno-8-21>21</a></span>
<span class=normal><a href=#__codelineno-8-22>22</a></span>
<span class=normal><a href=#__codelineno-8-23>23</a></span>
<span class=normal><a href=#__codelineno-8-24>24</a></span>
<span class=normal><a href=#__codelineno-8-25>25</a></span>
<span class=normal><a href=#__codelineno-8-26>26</a></span>
<span class=normal><a href=#__codelineno-8-27>27</a></span>
<span class=normal><a href=#__codelineno-8-28>28</a></span>
<span class=normal><a href=#__codelineno-8-29>29</a></span>
<span class=normal><a href=#__codelineno-8-30>30</a></span>
<span class=normal><a href=#__codelineno-8-31>31</a></span>
<span class=normal><a href=#__codelineno-8-32>32</a></span>
<span class=normal><a href=#__codelineno-8-33>33</a></span>
<span class=normal><a href=#__codelineno-8-34>34</a></span>
<span class=normal><a href=#__codelineno-8-35>35</a></span>
<span class=normal><a href=#__codelineno-8-36>36</a></span>
<span class=normal><a href=#__codelineno-8-37>37</a></span>
<span class=normal><a href=#__codelineno-8-38>38</a></span>
<span class=normal><a href=#__codelineno-8-39>39</a></span>
<span class=normal><a href=#__codelineno-8-40>40</a></span>
<span class=normal><a href=#__codelineno-8-41>41</a></span>
<span class=normal><a href=#__codelineno-8-42>42</a></span>
<span class=normal><a href=#__codelineno-8-43>43</a></span>
<span class=normal><a href=#__codelineno-8-44>44</a></span>
<span class=normal><a href=#__codelineno-8-45>45</a></span>
<span class=normal><a href=#__codelineno-8-46>46</a></span>
<span class=normal><a href=#__codelineno-8-47>47</a></span>
<span class=normal><a href=#__codelineno-8-48>48</a></span>
<span class=normal><a href=#__codelineno-8-49>49</a></span>
<span class=normal><a href=#__codelineno-8-50>50</a></span>
<span class=normal><a href=#__codelineno-8-51>51</a></span>
<span class=normal><a href=#__codelineno-8-52>52</a></span>
<span class=normal><a href=#__codelineno-8-53>53</a></span>
<span class=normal><a href=#__codelineno-8-54>54</a></span>
<span class=normal><a href=#__codelineno-8-55>55</a></span>
<span class=normal><a href=#__codelineno-8-56>56</a></span>
<span class=normal><a href=#__codelineno-8-57>57</a></span>
<span class=normal><a href=#__codelineno-8-58>58</a></span>
<span class=normal><a href=#__codelineno-8-59>59</a></span>
<span class=normal><a href=#__codelineno-8-60>60</a></span>
<span class=normal><a href=#__codelineno-8-61>61</a></span>
<span class=normal><a href=#__codelineno-8-62>62</a></span>
<span class=normal><a href=#__codelineno-8-63>63</a></span>
<span class=normal><a href=#__codelineno-8-64>64</a></span>
<span class=normal><a href=#__codelineno-8-65>65</a></span>
<span class=normal><a href=#__codelineno-8-66>66</a></span>
<span class=normal><a href=#__codelineno-8-67>67</a></span>
<span class=normal><a href=#__codelineno-8-68>68</a></span>
<span class=normal><a href=#__codelineno-8-69>69</a></span>
<span class=normal><a href=#__codelineno-8-70>70</a></span>
<span class=normal><a href=#__codelineno-8-71>71</a></span>
<span class=normal><a href=#__codelineno-8-72>72</a></span>
<span class=normal><a href=#__codelineno-8-73>73</a></span>
<span class=normal><a href=#__codelineno-8-74>74</a></span>
<span class=normal><a href=#__codelineno-8-75>75</a></span>
<span class=normal><a href=#__codelineno-8-76>76</a></span>
<span class=normal><a href=#__codelineno-8-77>77</a></span>
<span class=normal><a href=#__codelineno-8-78>78</a></span>
<span class=normal><a href=#__codelineno-8-79>79</a></span>
<span class=normal><a href=#__codelineno-8-80>80</a></span>
<span class=normal><a href=#__codelineno-8-81>81</a></span>
<span class=normal><a href=#__codelineno-8-82>82</a></span>
<span class=normal><a href=#__codelineno-8-83>83</a></span>
<span class=normal><a href=#__codelineno-8-84>84</a></span></pre></div></td><td class=code><div><pre><span></span><code><a id=__codelineno-8-1 name=__codelineno-8-1></a><span class=kn>import</span> <span class=nn>json</span>
<a id=__codelineno-8-2 name=__codelineno-8-2></a><span class=kn>import</span> <span class=nn>sys</span>
<a id=__codelineno-8-3 name=__codelineno-8-3></a><span class=kn>from</span> <span class=nn>pathlib</span> <span class=kn>import</span> <span class=n>Path</span>
<a id=__codelineno-8-4 name=__codelineno-8-4></a><span class=kn>from</span> <span class=nn>typing</span> <span class=kn>import</span> <span class=n>List</span>
<a id=__codelineno-8-5 name=__codelineno-8-5></a>
<a id=__codelineno-8-6 name=__codelineno-8-6></a><span class=kn>import</span> <span class=nn>matplotlib.pyplot</span> <span class=k>as</span> <span class=nn>plt</span>
<a id=__codelineno-8-7 name=__codelineno-8-7></a><span class=kn>import</span> <span class=nn>tensorflow</span> <span class=k>as</span> <span class=nn>tf</span>
<a id=__codelineno-8-8 name=__codelineno-8-8></a><span class=kn>import</span> <span class=nn>yaml</span>
<a id=__codelineno-8-9 name=__codelineno-8-9></a>
<a id=__codelineno-8-10 name=__codelineno-8-10></a><span class=kn>from</span> <span class=nn>utils.seed</span> <span class=kn>import</span> <span class=n>set_seed</span>
<a id=__codelineno-8-11 name=__codelineno-8-11></a>
<a id=__codelineno-8-12 name=__codelineno-8-12></a>
<a id=__codelineno-8-13 name=__codelineno-8-13></a><span class=k>def</span> <span class=nf>get_preview_plot</span><span class=p>(</span><span class=n>ds</span><span class=p>:</span> <span class=n>tf</span><span class=o>.</span><span class=n>data</span><span class=o>.</span><span class=n>Dataset</span><span class=p>,</span> <span class=n>labels</span><span class=p>:</span> <span class=n>List</span><span class=p>[</span><span class=nb>str</span><span class=p>])</span> <span class=o>-&gt;</span> <span class=n>plt</span><span class=o>.</span><span class=n>Figure</span><span class=p>:</span>
<a id=__codelineno-8-14 name=__codelineno-8-14></a><span class=w>    </span><span class=sd>&quot;&quot;&quot;Plot a preview of the prepared dataset&quot;&quot;&quot;</span>
<a id=__codelineno-8-15 name=__codelineno-8-15></a>    <span class=n>fig</span> <span class=o>=</span> <span class=n>plt</span><span class=o>.</span><span class=n>figure</span><span class=p>(</span><span class=n>figsize</span><span class=o>=</span><span class=p>(</span><span class=mi>10</span><span class=p>,</span> <span class=mi>5</span><span class=p>),</span> <span class=n>tight_layout</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
<a id=__codelineno-8-16 name=__codelineno-8-16></a>    <span class=k>for</span> <span class=n>images</span><span class=p>,</span> <span class=n>label_idxs</span> <span class=ow>in</span> <span class=n>ds</span><span class=o>.</span><span class=n>take</span><span class=p>(</span><span class=mi>1</span><span class=p>):</span>
<a id=__codelineno-8-17 name=__codelineno-8-17></a>        <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>10</span><span class=p>):</span>
<a id=__codelineno-8-18 name=__codelineno-8-18></a>            <span class=n>plt</span><span class=o>.</span><span class=n>subplot</span><span class=p>(</span><span class=mi>2</span><span class=p>,</span> <span class=mi>5</span><span class=p>,</span> <span class=n>i</span> <span class=o>+</span> <span class=mi>1</span><span class=p>)</span>
<a id=__codelineno-8-19 name=__codelineno-8-19></a>            <span class=n>plt</span><span class=o>.</span><span class=n>imshow</span><span class=p>(</span><span class=n>images</span><span class=p>[</span><span class=n>i</span><span class=p>]</span><span class=o>.</span><span class=n>numpy</span><span class=p>()</span><span class=o>.</span><span class=n>astype</span><span class=p>(</span><span class=s2>&quot;uint8&quot;</span><span class=p>),</span> <span class=n>cmap</span><span class=o>=</span><span class=s2>&quot;gray&quot;</span><span class=p>)</span>
<a id=__codelineno-8-20 name=__codelineno-8-20></a>            <span class=n>plt</span><span class=o>.</span><span class=n>title</span><span class=p>(</span><span class=n>labels</span><span class=p>[</span><span class=n>label_idxs</span><span class=p>[</span><span class=n>i</span><span class=p>]</span><span class=o>.</span><span class=n>numpy</span><span class=p>()])</span>
<a id=__codelineno-8-21 name=__codelineno-8-21></a>            <span class=n>plt</span><span class=o>.</span><span class=n>axis</span><span class=p>(</span><span class=s2>&quot;off&quot;</span><span class=p>)</span>
<a id=__codelineno-8-22 name=__codelineno-8-22></a>
<a id=__codelineno-8-23 name=__codelineno-8-23></a>    <span class=k>return</span> <span class=n>fig</span>
<a id=__codelineno-8-24 name=__codelineno-8-24></a>
<a id=__codelineno-8-25 name=__codelineno-8-25></a>
<a id=__codelineno-8-26 name=__codelineno-8-26></a><span class=k>def</span> <span class=nf>main</span><span class=p>()</span> <span class=o>-&gt;</span> <span class=kc>None</span><span class=p>:</span>
<a id=__codelineno-8-27 name=__codelineno-8-27></a>    <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>sys</span><span class=o>.</span><span class=n>argv</span><span class=p>)</span> <span class=o>!=</span> <span class=mi>3</span><span class=p>:</span>
<a id=__codelineno-8-28 name=__codelineno-8-28></a>        <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Arguments error. Usage:</span><span class=se>\n</span><span class=s2>&quot;</span><span class=p>)</span>
<a id=__codelineno-8-29 name=__codelineno-8-29></a>        <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;</span><span class=se>\t</span><span class=s2>python3 prepare.py &lt;raw-dataset-folder&gt; &lt;prepared-dataset-folder&gt;</span><span class=se>\n</span><span class=s2>&quot;</span><span class=p>)</span>
<a id=__codelineno-8-30 name=__codelineno-8-30></a>        <span class=n>exit</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
<a id=__codelineno-8-31 name=__codelineno-8-31></a>
<a id=__codelineno-8-32 name=__codelineno-8-32></a>    <span class=c1># Load parameters</span>
<a id=__codelineno-8-33 name=__codelineno-8-33></a>    <span class=n>prepare_params</span> <span class=o>=</span> <span class=n>yaml</span><span class=o>.</span><span class=n>safe_load</span><span class=p>(</span><span class=nb>open</span><span class=p>(</span><span class=s2>&quot;params.yaml&quot;</span><span class=p>))[</span><span class=s2>&quot;prepare&quot;</span><span class=p>]</span>
<a id=__codelineno-8-34 name=__codelineno-8-34></a>
<a id=__codelineno-8-35 name=__codelineno-8-35></a>    <span class=n>raw_dataset_folder</span> <span class=o>=</span> <span class=n>Path</span><span class=p>(</span><span class=n>sys</span><span class=o>.</span><span class=n>argv</span><span class=p>[</span><span class=mi>1</span><span class=p>])</span>
<a id=__codelineno-8-36 name=__codelineno-8-36></a>    <span class=n>prepared_dataset_folder</span> <span class=o>=</span> <span class=n>Path</span><span class=p>(</span><span class=n>sys</span><span class=o>.</span><span class=n>argv</span><span class=p>[</span><span class=mi>2</span><span class=p>])</span>
<a id=__codelineno-8-37 name=__codelineno-8-37></a>    <span class=n>seed</span> <span class=o>=</span> <span class=n>prepare_params</span><span class=p>[</span><span class=s2>&quot;seed&quot;</span><span class=p>]</span>
<a id=__codelineno-8-38 name=__codelineno-8-38></a>    <span class=n>split</span> <span class=o>=</span> <span class=n>prepare_params</span><span class=p>[</span><span class=s2>&quot;split&quot;</span><span class=p>]</span>
<a id=__codelineno-8-39 name=__codelineno-8-39></a>    <span class=n>image_size</span> <span class=o>=</span> <span class=n>prepare_params</span><span class=p>[</span><span class=s2>&quot;image_size&quot;</span><span class=p>]</span>
<a id=__codelineno-8-40 name=__codelineno-8-40></a>    <span class=n>grayscale</span> <span class=o>=</span> <span class=n>prepare_params</span><span class=p>[</span><span class=s2>&quot;grayscale&quot;</span><span class=p>]</span>
<a id=__codelineno-8-41 name=__codelineno-8-41></a>
<a id=__codelineno-8-42 name=__codelineno-8-42></a>    <span class=c1># Set seed for reproducibility</span>
<a id=__codelineno-8-43 name=__codelineno-8-43></a>    <span class=n>set_seed</span><span class=p>(</span><span class=n>seed</span><span class=p>)</span>
<a id=__codelineno-8-44 name=__codelineno-8-44></a>
<a id=__codelineno-8-45 name=__codelineno-8-45></a>    <span class=c1># Read data</span>
<a id=__codelineno-8-46 name=__codelineno-8-46></a>    <span class=n>ds_train</span><span class=p>,</span> <span class=n>ds_test</span> <span class=o>=</span> <span class=n>tf</span><span class=o>.</span><span class=n>keras</span><span class=o>.</span><span class=n>utils</span><span class=o>.</span><span class=n>image_dataset_from_directory</span><span class=p>(</span>
<a id=__codelineno-8-47 name=__codelineno-8-47></a>        <span class=n>raw_dataset_folder</span><span class=p>,</span>
<a id=__codelineno-8-48 name=__codelineno-8-48></a>        <span class=n>labels</span><span class=o>=</span><span class=s2>&quot;inferred&quot;</span><span class=p>,</span>
<a id=__codelineno-8-49 name=__codelineno-8-49></a>        <span class=n>label_mode</span><span class=o>=</span><span class=s2>&quot;int&quot;</span><span class=p>,</span>
<a id=__codelineno-8-50 name=__codelineno-8-50></a>        <span class=n>color_mode</span><span class=o>=</span><span class=s2>&quot;grayscale&quot;</span> <span class=k>if</span> <span class=n>grayscale</span> <span class=k>else</span> <span class=s2>&quot;rgb&quot;</span><span class=p>,</span>
<a id=__codelineno-8-51 name=__codelineno-8-51></a>        <span class=n>batch_size</span><span class=o>=</span><span class=mi>32</span><span class=p>,</span>
<a id=__codelineno-8-52 name=__codelineno-8-52></a>        <span class=n>image_size</span><span class=o>=</span><span class=n>image_size</span><span class=p>,</span>
<a id=__codelineno-8-53 name=__codelineno-8-53></a>        <span class=n>shuffle</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span>
<a id=__codelineno-8-54 name=__codelineno-8-54></a>        <span class=n>seed</span><span class=o>=</span><span class=n>seed</span><span class=p>,</span>
<a id=__codelineno-8-55 name=__codelineno-8-55></a>        <span class=n>validation_split</span><span class=o>=</span><span class=n>split</span><span class=p>,</span>
<a id=__codelineno-8-56 name=__codelineno-8-56></a>        <span class=n>subset</span><span class=o>=</span><span class=s2>&quot;both&quot;</span><span class=p>,</span>
<a id=__codelineno-8-57 name=__codelineno-8-57></a>    <span class=p>)</span>
<a id=__codelineno-8-58 name=__codelineno-8-58></a>    <span class=n>labels</span> <span class=o>=</span> <span class=n>ds_train</span><span class=o>.</span><span class=n>class_names</span>
<a id=__codelineno-8-59 name=__codelineno-8-59></a>
<a id=__codelineno-8-60 name=__codelineno-8-60></a>    <span class=k>if</span> <span class=ow>not</span> <span class=n>prepared_dataset_folder</span><span class=o>.</span><span class=n>exists</span><span class=p>():</span>
<a id=__codelineno-8-61 name=__codelineno-8-61></a>        <span class=n>prepared_dataset_folder</span><span class=o>.</span><span class=n>mkdir</span><span class=p>(</span><span class=n>parents</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
<a id=__codelineno-8-62 name=__codelineno-8-62></a>
<a id=__codelineno-8-63 name=__codelineno-8-63></a>    <span class=c1># Save the preview plot</span>
<a id=__codelineno-8-64 name=__codelineno-8-64></a>    <span class=n>preview_plot</span> <span class=o>=</span> <span class=n>get_preview_plot</span><span class=p>(</span><span class=n>ds_train</span><span class=p>,</span> <span class=n>labels</span><span class=p>)</span>
<a id=__codelineno-8-65 name=__codelineno-8-65></a>    <span class=n>preview_plot</span><span class=o>.</span><span class=n>savefig</span><span class=p>(</span><span class=n>prepared_dataset_folder</span> <span class=o>/</span> <span class=s2>&quot;preview.png&quot;</span><span class=p>)</span>
<a id=__codelineno-8-66 name=__codelineno-8-66></a>
<a id=__codelineno-8-67 name=__codelineno-8-67></a>    <span class=c1># Normalize the data</span>
<a id=__codelineno-8-68 name=__codelineno-8-68></a>    <span class=n>normalization_layer</span> <span class=o>=</span> <span class=n>tf</span><span class=o>.</span><span class=n>keras</span><span class=o>.</span><span class=n>layers</span><span class=o>.</span><span class=n>Rescaling</span><span class=p>(</span>
<a id=__codelineno-8-69 name=__codelineno-8-69></a>        <span class=mf>1.0</span> <span class=o>/</span> <span class=mi>255</span>
<a id=__codelineno-8-70 name=__codelineno-8-70></a>    <span class=p>)</span>
<a id=__codelineno-8-71 name=__codelineno-8-71></a>    <span class=n>ds_train</span> <span class=o>=</span> <span class=n>ds_train</span><span class=o>.</span><span class=n>map</span><span class=p>(</span><span class=k>lambda</span> <span class=n>x</span><span class=p>,</span> <span class=n>y</span><span class=p>:</span> <span class=p>(</span><span class=n>normalization_layer</span><span class=p>(</span><span class=n>x</span><span class=p>),</span> <span class=n>y</span><span class=p>))</span>
<a id=__codelineno-8-72 name=__codelineno-8-72></a>    <span class=n>ds_test</span> <span class=o>=</span> <span class=n>ds_test</span><span class=o>.</span><span class=n>map</span><span class=p>(</span><span class=k>lambda</span> <span class=n>x</span><span class=p>,</span> <span class=n>y</span><span class=p>:</span> <span class=p>(</span><span class=n>normalization_layer</span><span class=p>(</span><span class=n>x</span><span class=p>),</span> <span class=n>y</span><span class=p>))</span>
<a id=__codelineno-8-73 name=__codelineno-8-73></a>
<a id=__codelineno-8-74 name=__codelineno-8-74></a>    <span class=c1># Save the prepared dataset</span>
<a id=__codelineno-8-75 name=__codelineno-8-75></a>    <span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=n>prepared_dataset_folder</span> <span class=o>/</span> <span class=s2>&quot;labels.json&quot;</span><span class=p>,</span> <span class=s2>&quot;w&quot;</span><span class=p>)</span> <span class=k>as</span> <span class=n>f</span><span class=p>:</span>
<a id=__codelineno-8-76 name=__codelineno-8-76></a>        <span class=n>json</span><span class=o>.</span><span class=n>dump</span><span class=p>(</span><span class=n>labels</span><span class=p>,</span> <span class=n>f</span><span class=p>)</span>
<a id=__codelineno-8-77 name=__codelineno-8-77></a>    <span class=n>tf</span><span class=o>.</span><span class=n>data</span><span class=o>.</span><span class=n>Dataset</span><span class=o>.</span><span class=n>save</span><span class=p>(</span><span class=n>ds_train</span><span class=p>,</span> <span class=nb>str</span><span class=p>(</span><span class=n>prepared_dataset_folder</span> <span class=o>/</span> <span class=s2>&quot;train&quot;</span><span class=p>))</span>
<a id=__codelineno-8-78 name=__codelineno-8-78></a>    <span class=n>tf</span><span class=o>.</span><span class=n>data</span><span class=o>.</span><span class=n>Dataset</span><span class=o>.</span><span class=n>save</span><span class=p>(</span><span class=n>ds_test</span><span class=p>,</span> <span class=nb>str</span><span class=p>(</span><span class=n>prepared_dataset_folder</span> <span class=o>/</span> <span class=s2>&quot;test&quot;</span><span class=p>))</span>
<a id=__codelineno-8-79 name=__codelineno-8-79></a>
<a id=__codelineno-8-80 name=__codelineno-8-80></a>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;</span><span class=se>\n</span><span class=s2>Dataset saved at </span><span class=si>{</span><span class=n>prepared_dataset_folder</span><span class=o>.</span><span class=n>absolute</span><span class=p>()</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<a id=__codelineno-8-81 name=__codelineno-8-81></a>
<a id=__codelineno-8-82 name=__codelineno-8-82></a>
<a id=__codelineno-8-83 name=__codelineno-8-83></a><span class=k>if</span> <span class=vm>__name__</span> <span class=o>==</span> <span class=s2>&quot;__main__&quot;</span><span class=p>:</span>
<a id=__codelineno-8-84 name=__codelineno-8-84></a>    <span class=n>main</span><span class=p>()</span>
</code></pre></div></td></tr></table></div> <h4 id=move-the-train-step-to-its-own-file>Move the train step to its own file<a class=headerlink href=#move-the-train-step-to-its-own-file title="Permanent link">&para;</a></h4> <p>The <code>src/train.py</code> script will train the ML model. Let's take this opportunity to refactor the code to make it more modular and explicit using functions:</p> <div class=highlight><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>src/train.py</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-9-1> 1</a></span>
<span class=normal><a href=#__codelineno-9-2> 2</a></span>
<span class=normal><a href=#__codelineno-9-3> 3</a></span>
<span class=normal><a href=#__codelineno-9-4> 4</a></span>
<span class=normal><a href=#__codelineno-9-5> 5</a></span>
<span class=normal><a href=#__codelineno-9-6> 6</a></span>
<span class=normal><a href=#__codelineno-9-7> 7</a></span>
<span class=normal><a href=#__codelineno-9-8> 8</a></span>
<span class=normal><a href=#__codelineno-9-9> 9</a></span>
<span class=normal><a href=#__codelineno-9-10>10</a></span>
<span class=normal><a href=#__codelineno-9-11>11</a></span>
<span class=normal><a href=#__codelineno-9-12>12</a></span>
<span class=normal><a href=#__codelineno-9-13>13</a></span>
<span class=normal><a href=#__codelineno-9-14>14</a></span>
<span class=normal><a href=#__codelineno-9-15>15</a></span>
<span class=normal><a href=#__codelineno-9-16>16</a></span>
<span class=normal><a href=#__codelineno-9-17>17</a></span>
<span class=normal><a href=#__codelineno-9-18>18</a></span>
<span class=normal><a href=#__codelineno-9-19>19</a></span>
<span class=normal><a href=#__codelineno-9-20>20</a></span>
<span class=normal><a href=#__codelineno-9-21>21</a></span>
<span class=normal><a href=#__codelineno-9-22>22</a></span>
<span class=normal><a href=#__codelineno-9-23>23</a></span>
<span class=normal><a href=#__codelineno-9-24>24</a></span>
<span class=normal><a href=#__codelineno-9-25>25</a></span>
<span class=normal><a href=#__codelineno-9-26>26</a></span>
<span class=normal><a href=#__codelineno-9-27>27</a></span>
<span class=normal><a href=#__codelineno-9-28>28</a></span>
<span class=normal><a href=#__codelineno-9-29>29</a></span>
<span class=normal><a href=#__codelineno-9-30>30</a></span>
<span class=normal><a href=#__codelineno-9-31>31</a></span>
<span class=normal><a href=#__codelineno-9-32>32</a></span>
<span class=normal><a href=#__codelineno-9-33>33</a></span>
<span class=normal><a href=#__codelineno-9-34>34</a></span>
<span class=normal><a href=#__codelineno-9-35>35</a></span>
<span class=normal><a href=#__codelineno-9-36>36</a></span>
<span class=normal><a href=#__codelineno-9-37>37</a></span>
<span class=normal><a href=#__codelineno-9-38>38</a></span>
<span class=normal><a href=#__codelineno-9-39>39</a></span>
<span class=normal><a href=#__codelineno-9-40>40</a></span>
<span class=normal><a href=#__codelineno-9-41>41</a></span>
<span class=normal><a href=#__codelineno-9-42>42</a></span>
<span class=normal><a href=#__codelineno-9-43>43</a></span>
<span class=normal><a href=#__codelineno-9-44>44</a></span>
<span class=normal><a href=#__codelineno-9-45>45</a></span>
<span class=normal><a href=#__codelineno-9-46>46</a></span>
<span class=normal><a href=#__codelineno-9-47>47</a></span>
<span class=normal><a href=#__codelineno-9-48>48</a></span>
<span class=normal><a href=#__codelineno-9-49>49</a></span>
<span class=normal><a href=#__codelineno-9-50>50</a></span>
<span class=normal><a href=#__codelineno-9-51>51</a></span>
<span class=normal><a href=#__codelineno-9-52>52</a></span>
<span class=normal><a href=#__codelineno-9-53>53</a></span>
<span class=normal><a href=#__codelineno-9-54>54</a></span>
<span class=normal><a href=#__codelineno-9-55>55</a></span>
<span class=normal><a href=#__codelineno-9-56>56</a></span>
<span class=normal><a href=#__codelineno-9-57>57</a></span>
<span class=normal><a href=#__codelineno-9-58>58</a></span>
<span class=normal><a href=#__codelineno-9-59>59</a></span>
<span class=normal><a href=#__codelineno-9-60>60</a></span>
<span class=normal><a href=#__codelineno-9-61>61</a></span>
<span class=normal><a href=#__codelineno-9-62>62</a></span>
<span class=normal><a href=#__codelineno-9-63>63</a></span>
<span class=normal><a href=#__codelineno-9-64>64</a></span>
<span class=normal><a href=#__codelineno-9-65>65</a></span>
<span class=normal><a href=#__codelineno-9-66>66</a></span>
<span class=normal><a href=#__codelineno-9-67>67</a></span>
<span class=normal><a href=#__codelineno-9-68>68</a></span>
<span class=normal><a href=#__codelineno-9-69>69</a></span>
<span class=normal><a href=#__codelineno-9-70>70</a></span>
<span class=normal><a href=#__codelineno-9-71>71</a></span>
<span class=normal><a href=#__codelineno-9-72>72</a></span>
<span class=normal><a href=#__codelineno-9-73>73</a></span>
<span class=normal><a href=#__codelineno-9-74>74</a></span>
<span class=normal><a href=#__codelineno-9-75>75</a></span>
<span class=normal><a href=#__codelineno-9-76>76</a></span>
<span class=normal><a href=#__codelineno-9-77>77</a></span>
<span class=normal><a href=#__codelineno-9-78>78</a></span>
<span class=normal><a href=#__codelineno-9-79>79</a></span>
<span class=normal><a href=#__codelineno-9-80>80</a></span>
<span class=normal><a href=#__codelineno-9-81>81</a></span>
<span class=normal><a href=#__codelineno-9-82>82</a></span>
<span class=normal><a href=#__codelineno-9-83>83</a></span>
<span class=normal><a href=#__codelineno-9-84>84</a></span>
<span class=normal><a href=#__codelineno-9-85>85</a></span>
<span class=normal><a href=#__codelineno-9-86>86</a></span>
<span class=normal><a href=#__codelineno-9-87>87</a></span>
<span class=normal><a href=#__codelineno-9-88>88</a></span>
<span class=normal><a href=#__codelineno-9-89>89</a></span>
<span class=normal><a href=#__codelineno-9-90>90</a></span>
<span class=normal><a href=#__codelineno-9-91>91</a></span></pre></div></td><td class=code><div><pre><span></span><code><a id=__codelineno-9-1 name=__codelineno-9-1></a><span class=kn>import</span> <span class=nn>sys</span>
<a id=__codelineno-9-2 name=__codelineno-9-2></a><span class=kn>from</span> <span class=nn>pathlib</span> <span class=kn>import</span> <span class=n>Path</span>
<a id=__codelineno-9-3 name=__codelineno-9-3></a><span class=kn>from</span> <span class=nn>typing</span> <span class=kn>import</span> <span class=n>Tuple</span>
<a id=__codelineno-9-4 name=__codelineno-9-4></a>
<a id=__codelineno-9-5 name=__codelineno-9-5></a><span class=kn>import</span> <span class=nn>numpy</span> <span class=k>as</span> <span class=nn>np</span>
<a id=__codelineno-9-6 name=__codelineno-9-6></a><span class=kn>import</span> <span class=nn>tensorflow</span> <span class=k>as</span> <span class=nn>tf</span>
<a id=__codelineno-9-7 name=__codelineno-9-7></a><span class=kn>import</span> <span class=nn>yaml</span>
<a id=__codelineno-9-8 name=__codelineno-9-8></a>
<a id=__codelineno-9-9 name=__codelineno-9-9></a><span class=kn>from</span> <span class=nn>utils.seed</span> <span class=kn>import</span> <span class=n>set_seed</span>
<a id=__codelineno-9-10 name=__codelineno-9-10></a>
<a id=__codelineno-9-11 name=__codelineno-9-11></a>
<a id=__codelineno-9-12 name=__codelineno-9-12></a><span class=k>def</span> <span class=nf>get_model</span><span class=p>(</span>
<a id=__codelineno-9-13 name=__codelineno-9-13></a>    <span class=n>image_shape</span><span class=p>:</span> <span class=n>Tuple</span><span class=p>[</span><span class=nb>int</span><span class=p>,</span> <span class=nb>int</span><span class=p>,</span> <span class=nb>int</span><span class=p>],</span>
<a id=__codelineno-9-14 name=__codelineno-9-14></a>    <span class=n>conv_size</span><span class=p>:</span> <span class=nb>int</span><span class=p>,</span>
<a id=__codelineno-9-15 name=__codelineno-9-15></a>    <span class=n>dense_size</span><span class=p>:</span> <span class=nb>int</span><span class=p>,</span>
<a id=__codelineno-9-16 name=__codelineno-9-16></a>    <span class=n>output_classes</span><span class=p>:</span> <span class=nb>int</span><span class=p>,</span>
<a id=__codelineno-9-17 name=__codelineno-9-17></a><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>tf</span><span class=o>.</span><span class=n>keras</span><span class=o>.</span><span class=n>Model</span><span class=p>:</span>
<a id=__codelineno-9-18 name=__codelineno-9-18></a><span class=w>    </span><span class=sd>&quot;&quot;&quot;Create a simple CNN model&quot;&quot;&quot;</span>
<a id=__codelineno-9-19 name=__codelineno-9-19></a>    <span class=n>model</span> <span class=o>=</span> <span class=n>tf</span><span class=o>.</span><span class=n>keras</span><span class=o>.</span><span class=n>models</span><span class=o>.</span><span class=n>Sequential</span><span class=p>(</span>
<a id=__codelineno-9-20 name=__codelineno-9-20></a>        <span class=p>[</span>
<a id=__codelineno-9-21 name=__codelineno-9-21></a>            <span class=n>tf</span><span class=o>.</span><span class=n>keras</span><span class=o>.</span><span class=n>layers</span><span class=o>.</span><span class=n>Conv2D</span><span class=p>(</span>
<a id=__codelineno-9-22 name=__codelineno-9-22></a>                <span class=n>conv_size</span><span class=p>,</span> <span class=p>(</span><span class=mi>3</span><span class=p>,</span> <span class=mi>3</span><span class=p>),</span> <span class=n>activation</span><span class=o>=</span><span class=s2>&quot;relu&quot;</span><span class=p>,</span> <span class=n>input_shape</span><span class=o>=</span><span class=n>image_shape</span>
<a id=__codelineno-9-23 name=__codelineno-9-23></a>            <span class=p>),</span>
<a id=__codelineno-9-24 name=__codelineno-9-24></a>            <span class=n>tf</span><span class=o>.</span><span class=n>keras</span><span class=o>.</span><span class=n>layers</span><span class=o>.</span><span class=n>MaxPooling2D</span><span class=p>((</span><span class=mi>3</span><span class=p>,</span> <span class=mi>3</span><span class=p>)),</span>
<a id=__codelineno-9-25 name=__codelineno-9-25></a>            <span class=n>tf</span><span class=o>.</span><span class=n>keras</span><span class=o>.</span><span class=n>layers</span><span class=o>.</span><span class=n>Flatten</span><span class=p>(),</span>
<a id=__codelineno-9-26 name=__codelineno-9-26></a>            <span class=n>tf</span><span class=o>.</span><span class=n>keras</span><span class=o>.</span><span class=n>layers</span><span class=o>.</span><span class=n>Dense</span><span class=p>(</span><span class=n>dense_size</span><span class=p>,</span> <span class=n>activation</span><span class=o>=</span><span class=s2>&quot;relu&quot;</span><span class=p>),</span>
<a id=__codelineno-9-27 name=__codelineno-9-27></a>            <span class=n>tf</span><span class=o>.</span><span class=n>keras</span><span class=o>.</span><span class=n>layers</span><span class=o>.</span><span class=n>Dense</span><span class=p>(</span><span class=n>output_classes</span><span class=p>),</span>
<a id=__codelineno-9-28 name=__codelineno-9-28></a>        <span class=p>]</span>
<a id=__codelineno-9-29 name=__codelineno-9-29></a>    <span class=p>)</span>
<a id=__codelineno-9-30 name=__codelineno-9-30></a>    <span class=k>return</span> <span class=n>model</span>
<a id=__codelineno-9-31 name=__codelineno-9-31></a>
<a id=__codelineno-9-32 name=__codelineno-9-32></a>
<a id=__codelineno-9-33 name=__codelineno-9-33></a><span class=k>def</span> <span class=nf>main</span><span class=p>()</span> <span class=o>-&gt;</span> <span class=kc>None</span><span class=p>:</span>
<a id=__codelineno-9-34 name=__codelineno-9-34></a>    <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>sys</span><span class=o>.</span><span class=n>argv</span><span class=p>)</span> <span class=o>!=</span> <span class=mi>3</span><span class=p>:</span>
<a id=__codelineno-9-35 name=__codelineno-9-35></a>        <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Arguments error. Usage:</span><span class=se>\n</span><span class=s2>&quot;</span><span class=p>)</span>
<a id=__codelineno-9-36 name=__codelineno-9-36></a>        <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;</span><span class=se>\t</span><span class=s2>python3 train.py &lt;prepared-dataset-folder&gt; &lt;model-folder&gt;</span><span class=se>\n</span><span class=s2>&quot;</span><span class=p>)</span>
<a id=__codelineno-9-37 name=__codelineno-9-37></a>        <span class=n>exit</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
<a id=__codelineno-9-38 name=__codelineno-9-38></a>
<a id=__codelineno-9-39 name=__codelineno-9-39></a>    <span class=c1># Load parameters</span>
<a id=__codelineno-9-40 name=__codelineno-9-40></a>    <span class=n>prepare_params</span> <span class=o>=</span> <span class=n>yaml</span><span class=o>.</span><span class=n>safe_load</span><span class=p>(</span><span class=nb>open</span><span class=p>(</span><span class=s2>&quot;params.yaml&quot;</span><span class=p>))[</span><span class=s2>&quot;prepare&quot;</span><span class=p>]</span>
<a id=__codelineno-9-41 name=__codelineno-9-41></a>    <span class=n>train_params</span> <span class=o>=</span> <span class=n>yaml</span><span class=o>.</span><span class=n>safe_load</span><span class=p>(</span><span class=nb>open</span><span class=p>(</span><span class=s2>&quot;params.yaml&quot;</span><span class=p>))[</span><span class=s2>&quot;train&quot;</span><span class=p>]</span>
<a id=__codelineno-9-42 name=__codelineno-9-42></a>
<a id=__codelineno-9-43 name=__codelineno-9-43></a>    <span class=n>prepared_dataset_folder</span> <span class=o>=</span> <span class=n>Path</span><span class=p>(</span><span class=n>sys</span><span class=o>.</span><span class=n>argv</span><span class=p>[</span><span class=mi>1</span><span class=p>])</span>
<a id=__codelineno-9-44 name=__codelineno-9-44></a>    <span class=n>model_folder</span> <span class=o>=</span> <span class=n>Path</span><span class=p>(</span><span class=n>sys</span><span class=o>.</span><span class=n>argv</span><span class=p>[</span><span class=mi>2</span><span class=p>])</span>
<a id=__codelineno-9-45 name=__codelineno-9-45></a>
<a id=__codelineno-9-46 name=__codelineno-9-46></a>    <span class=n>image_size</span> <span class=o>=</span> <span class=n>prepare_params</span><span class=p>[</span><span class=s2>&quot;image_size&quot;</span><span class=p>]</span>
<a id=__codelineno-9-47 name=__codelineno-9-47></a>    <span class=n>grayscale</span> <span class=o>=</span> <span class=n>prepare_params</span><span class=p>[</span><span class=s2>&quot;grayscale&quot;</span><span class=p>]</span>
<a id=__codelineno-9-48 name=__codelineno-9-48></a>    <span class=n>image_shape</span> <span class=o>=</span> <span class=p>(</span><span class=o>*</span><span class=n>image_size</span><span class=p>,</span> <span class=mi>1</span> <span class=k>if</span> <span class=n>grayscale</span> <span class=k>else</span> <span class=mi>3</span><span class=p>)</span>
<a id=__codelineno-9-49 name=__codelineno-9-49></a>
<a id=__codelineno-9-50 name=__codelineno-9-50></a>    <span class=n>seed</span> <span class=o>=</span> <span class=n>train_params</span><span class=p>[</span><span class=s2>&quot;seed&quot;</span><span class=p>]</span>
<a id=__codelineno-9-51 name=__codelineno-9-51></a>    <span class=n>lr</span> <span class=o>=</span> <span class=n>train_params</span><span class=p>[</span><span class=s2>&quot;lr&quot;</span><span class=p>]</span>
<a id=__codelineno-9-52 name=__codelineno-9-52></a>    <span class=n>epochs</span> <span class=o>=</span> <span class=n>train_params</span><span class=p>[</span><span class=s2>&quot;epochs&quot;</span><span class=p>]</span>
<a id=__codelineno-9-53 name=__codelineno-9-53></a>    <span class=n>conv_size</span> <span class=o>=</span> <span class=n>train_params</span><span class=p>[</span><span class=s2>&quot;conv_size&quot;</span><span class=p>]</span>
<a id=__codelineno-9-54 name=__codelineno-9-54></a>    <span class=n>dense_size</span> <span class=o>=</span> <span class=n>train_params</span><span class=p>[</span><span class=s2>&quot;dense_size&quot;</span><span class=p>]</span>
<a id=__codelineno-9-55 name=__codelineno-9-55></a>    <span class=n>output_classes</span> <span class=o>=</span> <span class=n>train_params</span><span class=p>[</span><span class=s2>&quot;output_classes&quot;</span><span class=p>]</span>
<a id=__codelineno-9-56 name=__codelineno-9-56></a>
<a id=__codelineno-9-57 name=__codelineno-9-57></a>    <span class=c1># Set seed for reproducibility</span>
<a id=__codelineno-9-58 name=__codelineno-9-58></a>    <span class=n>set_seed</span><span class=p>(</span><span class=n>seed</span><span class=p>)</span>
<a id=__codelineno-9-59 name=__codelineno-9-59></a>
<a id=__codelineno-9-60 name=__codelineno-9-60></a>    <span class=c1># Load data</span>
<a id=__codelineno-9-61 name=__codelineno-9-61></a>    <span class=n>ds_train</span> <span class=o>=</span> <span class=n>tf</span><span class=o>.</span><span class=n>data</span><span class=o>.</span><span class=n>Dataset</span><span class=o>.</span><span class=n>load</span><span class=p>(</span><span class=nb>str</span><span class=p>(</span><span class=n>prepared_dataset_folder</span> <span class=o>/</span> <span class=s2>&quot;train&quot;</span><span class=p>))</span>
<a id=__codelineno-9-62 name=__codelineno-9-62></a>    <span class=n>ds_test</span> <span class=o>=</span> <span class=n>tf</span><span class=o>.</span><span class=n>data</span><span class=o>.</span><span class=n>Dataset</span><span class=o>.</span><span class=n>load</span><span class=p>(</span><span class=nb>str</span><span class=p>(</span><span class=n>prepared_dataset_folder</span> <span class=o>/</span> <span class=s2>&quot;test&quot;</span><span class=p>))</span>
<a id=__codelineno-9-63 name=__codelineno-9-63></a>
<a id=__codelineno-9-64 name=__codelineno-9-64></a>    <span class=c1># Define the model</span>
<a id=__codelineno-9-65 name=__codelineno-9-65></a>    <span class=n>model</span> <span class=o>=</span> <span class=n>get_model</span><span class=p>(</span><span class=n>image_shape</span><span class=p>,</span> <span class=n>conv_size</span><span class=p>,</span> <span class=n>dense_size</span><span class=p>,</span> <span class=n>output_classes</span><span class=p>)</span>
<a id=__codelineno-9-66 name=__codelineno-9-66></a>    <span class=n>model</span><span class=o>.</span><span class=n>compile</span><span class=p>(</span>
<a id=__codelineno-9-67 name=__codelineno-9-67></a>        <span class=n>optimizer</span><span class=o>=</span><span class=n>tf</span><span class=o>.</span><span class=n>keras</span><span class=o>.</span><span class=n>optimizers</span><span class=o>.</span><span class=n>Adam</span><span class=p>(</span><span class=n>lr</span><span class=p>),</span>
<a id=__codelineno-9-68 name=__codelineno-9-68></a>        <span class=n>loss</span><span class=o>=</span><span class=n>tf</span><span class=o>.</span><span class=n>keras</span><span class=o>.</span><span class=n>losses</span><span class=o>.</span><span class=n>SparseCategoricalCrossentropy</span><span class=p>(</span><span class=n>from_logits</span><span class=o>=</span><span class=kc>True</span><span class=p>),</span>
<a id=__codelineno-9-69 name=__codelineno-9-69></a>        <span class=n>metrics</span><span class=o>=</span><span class=p>[</span><span class=n>tf</span><span class=o>.</span><span class=n>keras</span><span class=o>.</span><span class=n>metrics</span><span class=o>.</span><span class=n>SparseCategoricalAccuracy</span><span class=p>()],</span>
<a id=__codelineno-9-70 name=__codelineno-9-70></a>    <span class=p>)</span>
<a id=__codelineno-9-71 name=__codelineno-9-71></a>    <span class=n>model</span><span class=o>.</span><span class=n>summary</span><span class=p>()</span>
<a id=__codelineno-9-72 name=__codelineno-9-72></a>
<a id=__codelineno-9-73 name=__codelineno-9-73></a>    <span class=c1># Train the model</span>
<a id=__codelineno-9-74 name=__codelineno-9-74></a>    <span class=n>model</span><span class=o>.</span><span class=n>fit</span><span class=p>(</span>
<a id=__codelineno-9-75 name=__codelineno-9-75></a>        <span class=n>ds_train</span><span class=p>,</span>
<a id=__codelineno-9-76 name=__codelineno-9-76></a>        <span class=n>epochs</span><span class=o>=</span><span class=n>epochs</span><span class=p>,</span>
<a id=__codelineno-9-77 name=__codelineno-9-77></a>        <span class=n>validation_data</span><span class=o>=</span><span class=n>ds_test</span><span class=p>,</span>
<a id=__codelineno-9-78 name=__codelineno-9-78></a>    <span class=p>)</span>
<a id=__codelineno-9-79 name=__codelineno-9-79></a>
<a id=__codelineno-9-80 name=__codelineno-9-80></a>    <span class=c1># Save the model</span>
<a id=__codelineno-9-81 name=__codelineno-9-81></a>    <span class=n>model_folder</span><span class=o>.</span><span class=n>mkdir</span><span class=p>(</span><span class=n>parents</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span> <span class=n>exist_ok</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
<a id=__codelineno-9-82 name=__codelineno-9-82></a>    <span class=n>model_path</span> <span class=o>=</span> <span class=n>model_folder</span> <span class=o>/</span> <span class=s2>&quot;model.keras&quot;</span>
<a id=__codelineno-9-83 name=__codelineno-9-83></a>    <span class=n>model</span><span class=o>.</span><span class=n>save</span><span class=p>(</span><span class=n>model_path</span><span class=p>)</span>
<a id=__codelineno-9-84 name=__codelineno-9-84></a>    <span class=c1># Save the model history</span>
<a id=__codelineno-9-85 name=__codelineno-9-85></a>    <span class=n>np</span><span class=o>.</span><span class=n>save</span><span class=p>(</span><span class=n>model_folder</span> <span class=o>/</span> <span class=s2>&quot;history.npy&quot;</span><span class=p>,</span> <span class=n>model</span><span class=o>.</span><span class=n>history</span><span class=o>.</span><span class=n>history</span><span class=p>)</span>
<a id=__codelineno-9-86 name=__codelineno-9-86></a>
<a id=__codelineno-9-87 name=__codelineno-9-87></a>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;</span><span class=se>\n</span><span class=s2>Model saved at </span><span class=si>{</span><span class=n>model_folder</span><span class=o>.</span><span class=n>absolute</span><span class=p>()</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<a id=__codelineno-9-88 name=__codelineno-9-88></a>
<a id=__codelineno-9-89 name=__codelineno-9-89></a>
<a id=__codelineno-9-90 name=__codelineno-9-90></a><span class=k>if</span> <span class=vm>__name__</span> <span class=o>==</span> <span class=s2>&quot;__main__&quot;</span><span class=p>:</span>
<a id=__codelineno-9-91 name=__codelineno-9-91></a>    <span class=n>main</span><span class=p>()</span>
</code></pre></div></td></tr></table></div> <h4 id=move-the-evaluate-step-to-its-own-file>Move the evaluate step to its own file<a class=headerlink href=#move-the-evaluate-step-to-its-own-file title="Permanent link">&para;</a></h4> <p>The <code>src/evaluate.py</code> script will evaluate the ML model using DVC. Let's take this opportunity to refactor the code to make it more modular and explicit using functions:</p> <div class=highlight><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>src/evaluate.py</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-10-1>  1</a></span>
<span class=normal><a href=#__codelineno-10-2>  2</a></span>
<span class=normal><a href=#__codelineno-10-3>  3</a></span>
<span class=normal><a href=#__codelineno-10-4>  4</a></span>
<span class=normal><a href=#__codelineno-10-5>  5</a></span>
<span class=normal><a href=#__codelineno-10-6>  6</a></span>
<span class=normal><a href=#__codelineno-10-7>  7</a></span>
<span class=normal><a href=#__codelineno-10-8>  8</a></span>
<span class=normal><a href=#__codelineno-10-9>  9</a></span>
<span class=normal><a href=#__codelineno-10-10> 10</a></span>
<span class=normal><a href=#__codelineno-10-11> 11</a></span>
<span class=normal><a href=#__codelineno-10-12> 12</a></span>
<span class=normal><a href=#__codelineno-10-13> 13</a></span>
<span class=normal><a href=#__codelineno-10-14> 14</a></span>
<span class=normal><a href=#__codelineno-10-15> 15</a></span>
<span class=normal><a href=#__codelineno-10-16> 16</a></span>
<span class=normal><a href=#__codelineno-10-17> 17</a></span>
<span class=normal><a href=#__codelineno-10-18> 18</a></span>
<span class=normal><a href=#__codelineno-10-19> 19</a></span>
<span class=normal><a href=#__codelineno-10-20> 20</a></span>
<span class=normal><a href=#__codelineno-10-21> 21</a></span>
<span class=normal><a href=#__codelineno-10-22> 22</a></span>
<span class=normal><a href=#__codelineno-10-23> 23</a></span>
<span class=normal><a href=#__codelineno-10-24> 24</a></span>
<span class=normal><a href=#__codelineno-10-25> 25</a></span>
<span class=normal><a href=#__codelineno-10-26> 26</a></span>
<span class=normal><a href=#__codelineno-10-27> 27</a></span>
<span class=normal><a href=#__codelineno-10-28> 28</a></span>
<span class=normal><a href=#__codelineno-10-29> 29</a></span>
<span class=normal><a href=#__codelineno-10-30> 30</a></span>
<span class=normal><a href=#__codelineno-10-31> 31</a></span>
<span class=normal><a href=#__codelineno-10-32> 32</a></span>
<span class=normal><a href=#__codelineno-10-33> 33</a></span>
<span class=normal><a href=#__codelineno-10-34> 34</a></span>
<span class=normal><a href=#__codelineno-10-35> 35</a></span>
<span class=normal><a href=#__codelineno-10-36> 36</a></span>
<span class=normal><a href=#__codelineno-10-37> 37</a></span>
<span class=normal><a href=#__codelineno-10-38> 38</a></span>
<span class=normal><a href=#__codelineno-10-39> 39</a></span>
<span class=normal><a href=#__codelineno-10-40> 40</a></span>
<span class=normal><a href=#__codelineno-10-41> 41</a></span>
<span class=normal><a href=#__codelineno-10-42> 42</a></span>
<span class=normal><a href=#__codelineno-10-43> 43</a></span>
<span class=normal><a href=#__codelineno-10-44> 44</a></span>
<span class=normal><a href=#__codelineno-10-45> 45</a></span>
<span class=normal><a href=#__codelineno-10-46> 46</a></span>
<span class=normal><a href=#__codelineno-10-47> 47</a></span>
<span class=normal><a href=#__codelineno-10-48> 48</a></span>
<span class=normal><a href=#__codelineno-10-49> 49</a></span>
<span class=normal><a href=#__codelineno-10-50> 50</a></span>
<span class=normal><a href=#__codelineno-10-51> 51</a></span>
<span class=normal><a href=#__codelineno-10-52> 52</a></span>
<span class=normal><a href=#__codelineno-10-53> 53</a></span>
<span class=normal><a href=#__codelineno-10-54> 54</a></span>
<span class=normal><a href=#__codelineno-10-55> 55</a></span>
<span class=normal><a href=#__codelineno-10-56> 56</a></span>
<span class=normal><a href=#__codelineno-10-57> 57</a></span>
<span class=normal><a href=#__codelineno-10-58> 58</a></span>
<span class=normal><a href=#__codelineno-10-59> 59</a></span>
<span class=normal><a href=#__codelineno-10-60> 60</a></span>
<span class=normal><a href=#__codelineno-10-61> 61</a></span>
<span class=normal><a href=#__codelineno-10-62> 62</a></span>
<span class=normal><a href=#__codelineno-10-63> 63</a></span>
<span class=normal><a href=#__codelineno-10-64> 64</a></span>
<span class=normal><a href=#__codelineno-10-65> 65</a></span>
<span class=normal><a href=#__codelineno-10-66> 66</a></span>
<span class=normal><a href=#__codelineno-10-67> 67</a></span>
<span class=normal><a href=#__codelineno-10-68> 68</a></span>
<span class=normal><a href=#__codelineno-10-69> 69</a></span>
<span class=normal><a href=#__codelineno-10-70> 70</a></span>
<span class=normal><a href=#__codelineno-10-71> 71</a></span>
<span class=normal><a href=#__codelineno-10-72> 72</a></span>
<span class=normal><a href=#__codelineno-10-73> 73</a></span>
<span class=normal><a href=#__codelineno-10-74> 74</a></span>
<span class=normal><a href=#__codelineno-10-75> 75</a></span>
<span class=normal><a href=#__codelineno-10-76> 76</a></span>
<span class=normal><a href=#__codelineno-10-77> 77</a></span>
<span class=normal><a href=#__codelineno-10-78> 78</a></span>
<span class=normal><a href=#__codelineno-10-79> 79</a></span>
<span class=normal><a href=#__codelineno-10-80> 80</a></span>
<span class=normal><a href=#__codelineno-10-81> 81</a></span>
<span class=normal><a href=#__codelineno-10-82> 82</a></span>
<span class=normal><a href=#__codelineno-10-83> 83</a></span>
<span class=normal><a href=#__codelineno-10-84> 84</a></span>
<span class=normal><a href=#__codelineno-10-85> 85</a></span>
<span class=normal><a href=#__codelineno-10-86> 86</a></span>
<span class=normal><a href=#__codelineno-10-87> 87</a></span>
<span class=normal><a href=#__codelineno-10-88> 88</a></span>
<span class=normal><a href=#__codelineno-10-89> 89</a></span>
<span class=normal><a href=#__codelineno-10-90> 90</a></span>
<span class=normal><a href=#__codelineno-10-91> 91</a></span>
<span class=normal><a href=#__codelineno-10-92> 92</a></span>
<span class=normal><a href=#__codelineno-10-93> 93</a></span>
<span class=normal><a href=#__codelineno-10-94> 94</a></span>
<span class=normal><a href=#__codelineno-10-95> 95</a></span>
<span class=normal><a href=#__codelineno-10-96> 96</a></span>
<span class=normal><a href=#__codelineno-10-97> 97</a></span>
<span class=normal><a href=#__codelineno-10-98> 98</a></span>
<span class=normal><a href=#__codelineno-10-99> 99</a></span>
<span class=normal><a href=#__codelineno-10-100>100</a></span>
<span class=normal><a href=#__codelineno-10-101>101</a></span>
<span class=normal><a href=#__codelineno-10-102>102</a></span>
<span class=normal><a href=#__codelineno-10-103>103</a></span>
<span class=normal><a href=#__codelineno-10-104>104</a></span>
<span class=normal><a href=#__codelineno-10-105>105</a></span>
<span class=normal><a href=#__codelineno-10-106>106</a></span>
<span class=normal><a href=#__codelineno-10-107>107</a></span>
<span class=normal><a href=#__codelineno-10-108>108</a></span>
<span class=normal><a href=#__codelineno-10-109>109</a></span>
<span class=normal><a href=#__codelineno-10-110>110</a></span>
<span class=normal><a href=#__codelineno-10-111>111</a></span>
<span class=normal><a href=#__codelineno-10-112>112</a></span>
<span class=normal><a href=#__codelineno-10-113>113</a></span>
<span class=normal><a href=#__codelineno-10-114>114</a></span>
<span class=normal><a href=#__codelineno-10-115>115</a></span>
<span class=normal><a href=#__codelineno-10-116>116</a></span>
<span class=normal><a href=#__codelineno-10-117>117</a></span>
<span class=normal><a href=#__codelineno-10-118>118</a></span>
<span class=normal><a href=#__codelineno-10-119>119</a></span>
<span class=normal><a href=#__codelineno-10-120>120</a></span>
<span class=normal><a href=#__codelineno-10-121>121</a></span>
<span class=normal><a href=#__codelineno-10-122>122</a></span>
<span class=normal><a href=#__codelineno-10-123>123</a></span>
<span class=normal><a href=#__codelineno-10-124>124</a></span>
<span class=normal><a href=#__codelineno-10-125>125</a></span>
<span class=normal><a href=#__codelineno-10-126>126</a></span>
<span class=normal><a href=#__codelineno-10-127>127</a></span>
<span class=normal><a href=#__codelineno-10-128>128</a></span>
<span class=normal><a href=#__codelineno-10-129>129</a></span>
<span class=normal><a href=#__codelineno-10-130>130</a></span>
<span class=normal><a href=#__codelineno-10-131>131</a></span>
<span class=normal><a href=#__codelineno-10-132>132</a></span>
<span class=normal><a href=#__codelineno-10-133>133</a></span>
<span class=normal><a href=#__codelineno-10-134>134</a></span>
<span class=normal><a href=#__codelineno-10-135>135</a></span>
<span class=normal><a href=#__codelineno-10-136>136</a></span>
<span class=normal><a href=#__codelineno-10-137>137</a></span>
<span class=normal><a href=#__codelineno-10-138>138</a></span>
<span class=normal><a href=#__codelineno-10-139>139</a></span>
<span class=normal><a href=#__codelineno-10-140>140</a></span>
<span class=normal><a href=#__codelineno-10-141>141</a></span>
<span class=normal><a href=#__codelineno-10-142>142</a></span>
<span class=normal><a href=#__codelineno-10-143>143</a></span>
<span class=normal><a href=#__codelineno-10-144>144</a></span>
<span class=normal><a href=#__codelineno-10-145>145</a></span>
<span class=normal><a href=#__codelineno-10-146>146</a></span>
<span class=normal><a href=#__codelineno-10-147>147</a></span>
<span class=normal><a href=#__codelineno-10-148>148</a></span>
<span class=normal><a href=#__codelineno-10-149>149</a></span>
<span class=normal><a href=#__codelineno-10-150>150</a></span>
<span class=normal><a href=#__codelineno-10-151>151</a></span>
<span class=normal><a href=#__codelineno-10-152>152</a></span>
<span class=normal><a href=#__codelineno-10-153>153</a></span>
<span class=normal><a href=#__codelineno-10-154>154</a></span>
<span class=normal><a href=#__codelineno-10-155>155</a></span>
<span class=normal><a href=#__codelineno-10-156>156</a></span>
<span class=normal><a href=#__codelineno-10-157>157</a></span>
<span class=normal><a href=#__codelineno-10-158>158</a></span>
<span class=normal><a href=#__codelineno-10-159>159</a></span>
<span class=normal><a href=#__codelineno-10-160>160</a></span>
<span class=normal><a href=#__codelineno-10-161>161</a></span></pre></div></td><td class=code><div><pre><span></span><code><a id=__codelineno-10-1 name=__codelineno-10-1></a><span class=kn>import</span> <span class=nn>json</span>
<a id=__codelineno-10-2 name=__codelineno-10-2></a><span class=kn>import</span> <span class=nn>sys</span>
<a id=__codelineno-10-3 name=__codelineno-10-3></a><span class=kn>from</span> <span class=nn>pathlib</span> <span class=kn>import</span> <span class=n>Path</span>
<a id=__codelineno-10-4 name=__codelineno-10-4></a><span class=kn>from</span> <span class=nn>typing</span> <span class=kn>import</span> <span class=n>List</span>
<a id=__codelineno-10-5 name=__codelineno-10-5></a>
<a id=__codelineno-10-6 name=__codelineno-10-6></a><span class=kn>import</span> <span class=nn>matplotlib.pyplot</span> <span class=k>as</span> <span class=nn>plt</span>
<a id=__codelineno-10-7 name=__codelineno-10-7></a><span class=kn>import</span> <span class=nn>numpy</span> <span class=k>as</span> <span class=nn>np</span>
<a id=__codelineno-10-8 name=__codelineno-10-8></a><span class=kn>import</span> <span class=nn>tensorflow</span> <span class=k>as</span> <span class=nn>tf</span>
<a id=__codelineno-10-9 name=__codelineno-10-9></a>
<a id=__codelineno-10-10 name=__codelineno-10-10></a>
<a id=__codelineno-10-11 name=__codelineno-10-11></a><span class=k>def</span> <span class=nf>get_training_plot</span><span class=p>(</span><span class=n>model_history</span><span class=p>:</span> <span class=nb>dict</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>plt</span><span class=o>.</span><span class=n>Figure</span><span class=p>:</span>
<a id=__codelineno-10-12 name=__codelineno-10-12></a><span class=w>    </span><span class=sd>&quot;&quot;&quot;Plot the training and validation loss&quot;&quot;&quot;</span>
<a id=__codelineno-10-13 name=__codelineno-10-13></a>    <span class=n>epochs</span> <span class=o>=</span> <span class=nb>range</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=n>model_history</span><span class=p>[</span><span class=s2>&quot;loss&quot;</span><span class=p>])</span> <span class=o>+</span> <span class=mi>1</span><span class=p>)</span>
<a id=__codelineno-10-14 name=__codelineno-10-14></a>
<a id=__codelineno-10-15 name=__codelineno-10-15></a>    <span class=n>fig</span> <span class=o>=</span> <span class=n>plt</span><span class=o>.</span><span class=n>figure</span><span class=p>(</span><span class=n>figsize</span><span class=o>=</span><span class=p>(</span><span class=mi>10</span><span class=p>,</span> <span class=mi>4</span><span class=p>))</span>
<a id=__codelineno-10-16 name=__codelineno-10-16></a>    <span class=n>plt</span><span class=o>.</span><span class=n>plot</span><span class=p>(</span><span class=n>epochs</span><span class=p>,</span> <span class=n>model_history</span><span class=p>[</span><span class=s2>&quot;loss&quot;</span><span class=p>],</span> <span class=n>label</span><span class=o>=</span><span class=s2>&quot;Training loss&quot;</span><span class=p>)</span>
<a id=__codelineno-10-17 name=__codelineno-10-17></a>    <span class=n>plt</span><span class=o>.</span><span class=n>plot</span><span class=p>(</span><span class=n>epochs</span><span class=p>,</span> <span class=n>model_history</span><span class=p>[</span><span class=s2>&quot;val_loss&quot;</span><span class=p>],</span> <span class=n>label</span><span class=o>=</span><span class=s2>&quot;Validation loss&quot;</span><span class=p>)</span>
<a id=__codelineno-10-18 name=__codelineno-10-18></a>    <span class=n>plt</span><span class=o>.</span><span class=n>xticks</span><span class=p>(</span><span class=n>epochs</span><span class=p>)</span>
<a id=__codelineno-10-19 name=__codelineno-10-19></a>    <span class=n>plt</span><span class=o>.</span><span class=n>title</span><span class=p>(</span><span class=s2>&quot;Training and validation loss&quot;</span><span class=p>)</span>
<a id=__codelineno-10-20 name=__codelineno-10-20></a>    <span class=n>plt</span><span class=o>.</span><span class=n>xlabel</span><span class=p>(</span><span class=s2>&quot;Epochs&quot;</span><span class=p>)</span>
<a id=__codelineno-10-21 name=__codelineno-10-21></a>    <span class=n>plt</span><span class=o>.</span><span class=n>ylabel</span><span class=p>(</span><span class=s2>&quot;Loss&quot;</span><span class=p>)</span>
<a id=__codelineno-10-22 name=__codelineno-10-22></a>    <span class=n>plt</span><span class=o>.</span><span class=n>legend</span><span class=p>()</span>
<a id=__codelineno-10-23 name=__codelineno-10-23></a>    <span class=n>plt</span><span class=o>.</span><span class=n>grid</span><span class=p>(</span><span class=kc>True</span><span class=p>)</span>
<a id=__codelineno-10-24 name=__codelineno-10-24></a>
<a id=__codelineno-10-25 name=__codelineno-10-25></a>    <span class=k>return</span> <span class=n>fig</span>
<a id=__codelineno-10-26 name=__codelineno-10-26></a>
<a id=__codelineno-10-27 name=__codelineno-10-27></a>
<a id=__codelineno-10-28 name=__codelineno-10-28></a><span class=k>def</span> <span class=nf>get_pred_preview_plot</span><span class=p>(</span>
<a id=__codelineno-10-29 name=__codelineno-10-29></a>    <span class=n>model</span><span class=p>:</span> <span class=n>tf</span><span class=o>.</span><span class=n>keras</span><span class=o>.</span><span class=n>Model</span><span class=p>,</span> <span class=n>ds_test</span><span class=p>:</span> <span class=n>tf</span><span class=o>.</span><span class=n>data</span><span class=o>.</span><span class=n>Dataset</span><span class=p>,</span> <span class=n>labels</span><span class=p>:</span> <span class=n>List</span><span class=p>[</span><span class=nb>str</span><span class=p>]</span>
<a id=__codelineno-10-30 name=__codelineno-10-30></a><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>plt</span><span class=o>.</span><span class=n>Figure</span><span class=p>:</span>
<a id=__codelineno-10-31 name=__codelineno-10-31></a><span class=w>    </span><span class=sd>&quot;&quot;&quot;Plot a preview of the predictions&quot;&quot;&quot;</span>
<a id=__codelineno-10-32 name=__codelineno-10-32></a>    <span class=n>fig</span> <span class=o>=</span> <span class=n>plt</span><span class=o>.</span><span class=n>figure</span><span class=p>(</span><span class=n>figsize</span><span class=o>=</span><span class=p>(</span><span class=mi>10</span><span class=p>,</span> <span class=mi>5</span><span class=p>),</span> <span class=n>tight_layout</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
<a id=__codelineno-10-33 name=__codelineno-10-33></a>    <span class=k>for</span> <span class=n>images</span><span class=p>,</span> <span class=n>label_idxs</span> <span class=ow>in</span> <span class=n>ds_test</span><span class=o>.</span><span class=n>take</span><span class=p>(</span><span class=mi>1</span><span class=p>):</span>
<a id=__codelineno-10-34 name=__codelineno-10-34></a>        <span class=n>preds</span> <span class=o>=</span> <span class=n>model</span><span class=o>.</span><span class=n>predict</span><span class=p>(</span><span class=n>images</span><span class=p>)</span>
<a id=__codelineno-10-35 name=__codelineno-10-35></a>        <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>10</span><span class=p>):</span>
<a id=__codelineno-10-36 name=__codelineno-10-36></a>            <span class=n>plt</span><span class=o>.</span><span class=n>subplot</span><span class=p>(</span><span class=mi>2</span><span class=p>,</span> <span class=mi>5</span><span class=p>,</span> <span class=n>i</span> <span class=o>+</span> <span class=mi>1</span><span class=p>)</span>
<a id=__codelineno-10-37 name=__codelineno-10-37></a>            <span class=n>img</span> <span class=o>=</span> <span class=p>(</span><span class=n>images</span><span class=p>[</span><span class=n>i</span><span class=p>]</span><span class=o>.</span><span class=n>numpy</span><span class=p>()</span> <span class=o>*</span> <span class=mi>255</span><span class=p>)</span><span class=o>.</span><span class=n>astype</span><span class=p>(</span><span class=s2>&quot;uint8&quot;</span><span class=p>)</span>
<a id=__codelineno-10-38 name=__codelineno-10-38></a>            <span class=c1># Convert image to rgb if grayscale</span>
<a id=__codelineno-10-39 name=__codelineno-10-39></a>            <span class=k>if</span> <span class=n>img</span><span class=o>.</span><span class=n>shape</span><span class=p>[</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span> <span class=o>==</span> <span class=mi>1</span><span class=p>:</span>
<a id=__codelineno-10-40 name=__codelineno-10-40></a>                <span class=n>img</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>squeeze</span><span class=p>(</span><span class=n>img</span><span class=p>,</span> <span class=n>axis</span><span class=o>=-</span><span class=mi>1</span><span class=p>)</span>
<a id=__codelineno-10-41 name=__codelineno-10-41></a>                <span class=n>img</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>stack</span><span class=p>((</span><span class=n>img</span><span class=p>,)</span> <span class=o>*</span> <span class=mi>3</span><span class=p>,</span> <span class=n>axis</span><span class=o>=-</span><span class=mi>1</span><span class=p>)</span>
<a id=__codelineno-10-42 name=__codelineno-10-42></a>            <span class=n>true_label</span> <span class=o>=</span> <span class=n>labels</span><span class=p>[</span><span class=n>label_idxs</span><span class=p>[</span><span class=n>i</span><span class=p>]</span><span class=o>.</span><span class=n>numpy</span><span class=p>()]</span>
<a id=__codelineno-10-43 name=__codelineno-10-43></a>            <span class=n>pred_label</span> <span class=o>=</span> <span class=n>labels</span><span class=p>[</span><span class=n>np</span><span class=o>.</span><span class=n>argmax</span><span class=p>(</span><span class=n>preds</span><span class=p>[</span><span class=n>i</span><span class=p>])]</span>
<a id=__codelineno-10-44 name=__codelineno-10-44></a>            <span class=c1># Add red border if the prediction is wrong else add green border</span>
<a id=__codelineno-10-45 name=__codelineno-10-45></a>            <span class=n>img</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>pad</span><span class=p>(</span><span class=n>img</span><span class=p>,</span> <span class=n>pad_width</span><span class=o>=</span><span class=p>((</span><span class=mi>1</span><span class=p>,</span> <span class=mi>1</span><span class=p>),</span> <span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=mi>1</span><span class=p>),</span> <span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>)))</span>
<a id=__codelineno-10-46 name=__codelineno-10-46></a>            <span class=k>if</span> <span class=n>true_label</span> <span class=o>!=</span> <span class=n>pred_label</span><span class=p>:</span>
<a id=__codelineno-10-47 name=__codelineno-10-47></a>                <span class=n>img</span><span class=p>[</span><span class=mi>0</span><span class=p>,</span> <span class=p>:,</span> <span class=mi>0</span><span class=p>]</span> <span class=o>=</span> <span class=mi>255</span>  <span class=c1># Top border</span>
<a id=__codelineno-10-48 name=__codelineno-10-48></a>                <span class=n>img</span><span class=p>[</span><span class=o>-</span><span class=mi>1</span><span class=p>,</span> <span class=p>:,</span> <span class=mi>0</span><span class=p>]</span> <span class=o>=</span> <span class=mi>255</span>  <span class=c1># Bottom border</span>
<a id=__codelineno-10-49 name=__codelineno-10-49></a>                <span class=n>img</span><span class=p>[:,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>]</span> <span class=o>=</span> <span class=mi>255</span>  <span class=c1># Left border</span>
<a id=__codelineno-10-50 name=__codelineno-10-50></a>                <span class=n>img</span><span class=p>[:,</span> <span class=o>-</span><span class=mi>1</span><span class=p>,</span> <span class=mi>0</span><span class=p>]</span> <span class=o>=</span> <span class=mi>255</span>  <span class=c1># Right border</span>
<a id=__codelineno-10-51 name=__codelineno-10-51></a>            <span class=k>else</span><span class=p>:</span>
<a id=__codelineno-10-52 name=__codelineno-10-52></a>                <span class=n>img</span><span class=p>[</span><span class=mi>0</span><span class=p>,</span> <span class=p>:,</span> <span class=mi>1</span><span class=p>]</span> <span class=o>=</span> <span class=mi>255</span>
<a id=__codelineno-10-53 name=__codelineno-10-53></a>                <span class=n>img</span><span class=p>[</span><span class=o>-</span><span class=mi>1</span><span class=p>,</span> <span class=p>:,</span> <span class=mi>1</span><span class=p>]</span> <span class=o>=</span> <span class=mi>255</span>
<a id=__codelineno-10-54 name=__codelineno-10-54></a>                <span class=n>img</span><span class=p>[:,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>1</span><span class=p>]</span> <span class=o>=</span> <span class=mi>255</span>
<a id=__codelineno-10-55 name=__codelineno-10-55></a>                <span class=n>img</span><span class=p>[:,</span> <span class=o>-</span><span class=mi>1</span><span class=p>,</span> <span class=mi>1</span><span class=p>]</span> <span class=o>=</span> <span class=mi>255</span>
<a id=__codelineno-10-56 name=__codelineno-10-56></a>
<a id=__codelineno-10-57 name=__codelineno-10-57></a>            <span class=n>plt</span><span class=o>.</span><span class=n>imshow</span><span class=p>(</span><span class=n>img</span><span class=p>)</span>
<a id=__codelineno-10-58 name=__codelineno-10-58></a>            <span class=n>plt</span><span class=o>.</span><span class=n>title</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;True: </span><span class=si>{</span><span class=n>true_label</span><span class=si>}</span><span class=se>\n</span><span class=s2>&quot;</span> <span class=sa>f</span><span class=s2>&quot;Pred: </span><span class=si>{</span><span class=n>pred_label</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<a id=__codelineno-10-59 name=__codelineno-10-59></a>            <span class=n>plt</span><span class=o>.</span><span class=n>axis</span><span class=p>(</span><span class=s2>&quot;off&quot;</span><span class=p>)</span>
<a id=__codelineno-10-60 name=__codelineno-10-60></a>
<a id=__codelineno-10-61 name=__codelineno-10-61></a>    <span class=k>return</span> <span class=n>fig</span>
<a id=__codelineno-10-62 name=__codelineno-10-62></a>
<a id=__codelineno-10-63 name=__codelineno-10-63></a>
<a id=__codelineno-10-64 name=__codelineno-10-64></a><span class=k>def</span> <span class=nf>get_confusion_matrix_plot</span><span class=p>(</span>
<a id=__codelineno-10-65 name=__codelineno-10-65></a>    <span class=n>model</span><span class=p>:</span> <span class=n>tf</span><span class=o>.</span><span class=n>keras</span><span class=o>.</span><span class=n>Model</span><span class=p>,</span> <span class=n>ds_test</span><span class=p>:</span> <span class=n>tf</span><span class=o>.</span><span class=n>data</span><span class=o>.</span><span class=n>Dataset</span><span class=p>,</span> <span class=n>labels</span><span class=p>:</span> <span class=n>List</span><span class=p>[</span><span class=nb>str</span><span class=p>]</span>
<a id=__codelineno-10-66 name=__codelineno-10-66></a><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>plt</span><span class=o>.</span><span class=n>Figure</span><span class=p>:</span>
<a id=__codelineno-10-67 name=__codelineno-10-67></a><span class=w>    </span><span class=sd>&quot;&quot;&quot;Plot the confusion matrix&quot;&quot;&quot;</span>
<a id=__codelineno-10-68 name=__codelineno-10-68></a>    <span class=n>fig</span> <span class=o>=</span> <span class=n>plt</span><span class=o>.</span><span class=n>figure</span><span class=p>(</span><span class=n>figsize</span><span class=o>=</span><span class=p>(</span><span class=mi>6</span><span class=p>,</span> <span class=mi>6</span><span class=p>),</span> <span class=n>tight_layout</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
<a id=__codelineno-10-69 name=__codelineno-10-69></a>    <span class=n>preds</span> <span class=o>=</span> <span class=n>model</span><span class=o>.</span><span class=n>predict</span><span class=p>(</span><span class=n>ds_test</span><span class=p>)</span>
<a id=__codelineno-10-70 name=__codelineno-10-70></a>
<a id=__codelineno-10-71 name=__codelineno-10-71></a>    <span class=n>conf_matrix</span> <span class=o>=</span> <span class=n>tf</span><span class=o>.</span><span class=n>math</span><span class=o>.</span><span class=n>confusion_matrix</span><span class=p>(</span>
<a id=__codelineno-10-72 name=__codelineno-10-72></a>        <span class=n>labels</span><span class=o>=</span><span class=n>tf</span><span class=o>.</span><span class=n>concat</span><span class=p>([</span><span class=n>y</span> <span class=k>for</span> <span class=n>_</span><span class=p>,</span> <span class=n>y</span> <span class=ow>in</span> <span class=n>ds_test</span><span class=p>],</span> <span class=n>axis</span><span class=o>=</span><span class=mi>0</span><span class=p>),</span>
<a id=__codelineno-10-73 name=__codelineno-10-73></a>        <span class=n>predictions</span><span class=o>=</span><span class=n>tf</span><span class=o>.</span><span class=n>argmax</span><span class=p>(</span><span class=n>preds</span><span class=p>,</span> <span class=n>axis</span><span class=o>=</span><span class=mi>1</span><span class=p>),</span>
<a id=__codelineno-10-74 name=__codelineno-10-74></a>        <span class=n>num_classes</span><span class=o>=</span><span class=nb>len</span><span class=p>(</span><span class=n>labels</span><span class=p>),</span>
<a id=__codelineno-10-75 name=__codelineno-10-75></a>    <span class=p>)</span>
<a id=__codelineno-10-76 name=__codelineno-10-76></a>
<a id=__codelineno-10-77 name=__codelineno-10-77></a>    <span class=c1># Plot the confusion matrix</span>
<a id=__codelineno-10-78 name=__codelineno-10-78></a>    <span class=n>conf_matrix</span> <span class=o>=</span> <span class=n>conf_matrix</span> <span class=o>/</span> <span class=n>tf</span><span class=o>.</span><span class=n>reduce_sum</span><span class=p>(</span><span class=n>conf_matrix</span><span class=p>,</span> <span class=n>axis</span><span class=o>=</span><span class=mi>1</span><span class=p>)</span>
<a id=__codelineno-10-79 name=__codelineno-10-79></a>    <span class=n>plt</span><span class=o>.</span><span class=n>imshow</span><span class=p>(</span><span class=n>conf_matrix</span><span class=p>,</span> <span class=n>cmap</span><span class=o>=</span><span class=s2>&quot;Blues&quot;</span><span class=p>)</span>
<a id=__codelineno-10-80 name=__codelineno-10-80></a>
<a id=__codelineno-10-81 name=__codelineno-10-81></a>    <span class=c1># Plot cell values</span>
<a id=__codelineno-10-82 name=__codelineno-10-82></a>    <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>labels</span><span class=p>)):</span>
<a id=__codelineno-10-83 name=__codelineno-10-83></a>        <span class=k>for</span> <span class=n>j</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>labels</span><span class=p>)):</span>
<a id=__codelineno-10-84 name=__codelineno-10-84></a>            <span class=n>value</span> <span class=o>=</span> <span class=n>conf_matrix</span><span class=p>[</span><span class=n>i</span><span class=p>,</span> <span class=n>j</span><span class=p>]</span><span class=o>.</span><span class=n>numpy</span><span class=p>()</span>
<a id=__codelineno-10-85 name=__codelineno-10-85></a>            <span class=k>if</span> <span class=n>value</span> <span class=o>==</span> <span class=mi>0</span><span class=p>:</span>
<a id=__codelineno-10-86 name=__codelineno-10-86></a>                <span class=n>color</span> <span class=o>=</span> <span class=s2>&quot;lightgray&quot;</span>
<a id=__codelineno-10-87 name=__codelineno-10-87></a>            <span class=k>elif</span> <span class=n>value</span> <span class=o>&gt;</span> <span class=mf>0.5</span><span class=p>:</span>
<a id=__codelineno-10-88 name=__codelineno-10-88></a>                <span class=n>color</span> <span class=o>=</span> <span class=s2>&quot;white&quot;</span>
<a id=__codelineno-10-89 name=__codelineno-10-89></a>            <span class=k>else</span><span class=p>:</span>
<a id=__codelineno-10-90 name=__codelineno-10-90></a>                <span class=n>color</span> <span class=o>=</span> <span class=s2>&quot;black&quot;</span>
<a id=__codelineno-10-91 name=__codelineno-10-91></a>            <span class=n>plt</span><span class=o>.</span><span class=n>text</span><span class=p>(</span>
<a id=__codelineno-10-92 name=__codelineno-10-92></a>                <span class=n>j</span><span class=p>,</span>
<a id=__codelineno-10-93 name=__codelineno-10-93></a>                <span class=n>i</span><span class=p>,</span>
<a id=__codelineno-10-94 name=__codelineno-10-94></a>                <span class=sa>f</span><span class=s2>&quot;</span><span class=si>{</span><span class=n>value</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>,</span>
<a id=__codelineno-10-95 name=__codelineno-10-95></a>                <span class=n>ha</span><span class=o>=</span><span class=s2>&quot;center&quot;</span><span class=p>,</span>
<a id=__codelineno-10-96 name=__codelineno-10-96></a>                <span class=n>va</span><span class=o>=</span><span class=s2>&quot;center&quot;</span><span class=p>,</span>
<a id=__codelineno-10-97 name=__codelineno-10-97></a>                <span class=n>color</span><span class=o>=</span><span class=n>color</span><span class=p>,</span>
<a id=__codelineno-10-98 name=__codelineno-10-98></a>                <span class=n>fontsize</span><span class=o>=</span><span class=mi>8</span><span class=p>,</span>
<a id=__codelineno-10-99 name=__codelineno-10-99></a>            <span class=p>)</span>
<a id=__codelineno-10-100 name=__codelineno-10-100></a>
<a id=__codelineno-10-101 name=__codelineno-10-101></a>    <span class=n>plt</span><span class=o>.</span><span class=n>colorbar</span><span class=p>()</span>
<a id=__codelineno-10-102 name=__codelineno-10-102></a>    <span class=n>plt</span><span class=o>.</span><span class=n>xticks</span><span class=p>(</span><span class=nb>range</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>labels</span><span class=p>)),</span> <span class=n>labels</span><span class=p>,</span> <span class=n>rotation</span><span class=o>=</span><span class=mi>90</span><span class=p>)</span>
<a id=__codelineno-10-103 name=__codelineno-10-103></a>    <span class=n>plt</span><span class=o>.</span><span class=n>yticks</span><span class=p>(</span><span class=nb>range</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>labels</span><span class=p>)),</span> <span class=n>labels</span><span class=p>)</span>
<a id=__codelineno-10-104 name=__codelineno-10-104></a>    <span class=n>plt</span><span class=o>.</span><span class=n>xlabel</span><span class=p>(</span><span class=s2>&quot;Predicted label&quot;</span><span class=p>)</span>
<a id=__codelineno-10-105 name=__codelineno-10-105></a>    <span class=n>plt</span><span class=o>.</span><span class=n>ylabel</span><span class=p>(</span><span class=s2>&quot;True label&quot;</span><span class=p>)</span>
<a id=__codelineno-10-106 name=__codelineno-10-106></a>    <span class=n>plt</span><span class=o>.</span><span class=n>title</span><span class=p>(</span><span class=s2>&quot;Confusion matrix&quot;</span><span class=p>)</span>
<a id=__codelineno-10-107 name=__codelineno-10-107></a>
<a id=__codelineno-10-108 name=__codelineno-10-108></a>    <span class=k>return</span> <span class=n>fig</span>
<a id=__codelineno-10-109 name=__codelineno-10-109></a>
<a id=__codelineno-10-110 name=__codelineno-10-110></a>
<a id=__codelineno-10-111 name=__codelineno-10-111></a><span class=k>def</span> <span class=nf>main</span><span class=p>()</span> <span class=o>-&gt;</span> <span class=kc>None</span><span class=p>:</span>
<a id=__codelineno-10-112 name=__codelineno-10-112></a>    <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>sys</span><span class=o>.</span><span class=n>argv</span><span class=p>)</span> <span class=o>!=</span> <span class=mi>3</span><span class=p>:</span>
<a id=__codelineno-10-113 name=__codelineno-10-113></a>        <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Arguments error. Usage:</span><span class=se>\n</span><span class=s2>&quot;</span><span class=p>)</span>
<a id=__codelineno-10-114 name=__codelineno-10-114></a>        <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;</span><span class=se>\t</span><span class=s2>python3 evaluate.py &lt;model-folder&gt; &lt;prepared-dataset-folder&gt;</span><span class=se>\n</span><span class=s2>&quot;</span><span class=p>)</span>
<a id=__codelineno-10-115 name=__codelineno-10-115></a>        <span class=n>exit</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
<a id=__codelineno-10-116 name=__codelineno-10-116></a>
<a id=__codelineno-10-117 name=__codelineno-10-117></a>    <span class=n>model_folder</span> <span class=o>=</span> <span class=n>Path</span><span class=p>(</span><span class=n>sys</span><span class=o>.</span><span class=n>argv</span><span class=p>[</span><span class=mi>1</span><span class=p>])</span>
<a id=__codelineno-10-118 name=__codelineno-10-118></a>    <span class=n>prepared_dataset_folder</span> <span class=o>=</span> <span class=n>Path</span><span class=p>(</span><span class=n>sys</span><span class=o>.</span><span class=n>argv</span><span class=p>[</span><span class=mi>2</span><span class=p>])</span>
<a id=__codelineno-10-119 name=__codelineno-10-119></a>    <span class=n>evaluation_folder</span> <span class=o>=</span> <span class=n>Path</span><span class=p>(</span><span class=s2>&quot;evaluation&quot;</span><span class=p>)</span>
<a id=__codelineno-10-120 name=__codelineno-10-120></a>    <span class=n>plots_folder</span> <span class=o>=</span> <span class=n>Path</span><span class=p>(</span><span class=s2>&quot;plots&quot;</span><span class=p>)</span>
<a id=__codelineno-10-121 name=__codelineno-10-121></a>
<a id=__codelineno-10-122 name=__codelineno-10-122></a>    <span class=c1># Create folders</span>
<a id=__codelineno-10-123 name=__codelineno-10-123></a>    <span class=p>(</span><span class=n>evaluation_folder</span> <span class=o>/</span> <span class=n>plots_folder</span><span class=p>)</span><span class=o>.</span><span class=n>mkdir</span><span class=p>(</span><span class=n>parents</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span> <span class=n>exist_ok</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
<a id=__codelineno-10-124 name=__codelineno-10-124></a>
<a id=__codelineno-10-125 name=__codelineno-10-125></a>    <span class=c1># Load files</span>
<a id=__codelineno-10-126 name=__codelineno-10-126></a>    <span class=n>ds_test</span> <span class=o>=</span> <span class=n>tf</span><span class=o>.</span><span class=n>data</span><span class=o>.</span><span class=n>Dataset</span><span class=o>.</span><span class=n>load</span><span class=p>(</span><span class=nb>str</span><span class=p>(</span><span class=n>prepared_dataset_folder</span> <span class=o>/</span> <span class=s2>&quot;test&quot;</span><span class=p>))</span>
<a id=__codelineno-10-127 name=__codelineno-10-127></a>    <span class=n>labels</span> <span class=o>=</span> <span class=kc>None</span>
<a id=__codelineno-10-128 name=__codelineno-10-128></a>    <span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=n>prepared_dataset_folder</span> <span class=o>/</span> <span class=s2>&quot;labels.json&quot;</span><span class=p>)</span> <span class=k>as</span> <span class=n>f</span><span class=p>:</span>
<a id=__codelineno-10-129 name=__codelineno-10-129></a>        <span class=n>labels</span> <span class=o>=</span> <span class=n>json</span><span class=o>.</span><span class=n>load</span><span class=p>(</span><span class=n>f</span><span class=p>)</span>
<a id=__codelineno-10-130 name=__codelineno-10-130></a>
<a id=__codelineno-10-131 name=__codelineno-10-131></a>    <span class=c1># Load model</span>
<a id=__codelineno-10-132 name=__codelineno-10-132></a>    <span class=n>model_path</span> <span class=o>=</span> <span class=n>model_folder</span> <span class=o>/</span> <span class=s2>&quot;model.keras&quot;</span>
<a id=__codelineno-10-133 name=__codelineno-10-133></a>    <span class=n>model</span> <span class=o>=</span> <span class=n>tf</span><span class=o>.</span><span class=n>keras</span><span class=o>.</span><span class=n>models</span><span class=o>.</span><span class=n>load_model</span><span class=p>(</span><span class=n>model_path</span><span class=p>)</span>
<a id=__codelineno-10-134 name=__codelineno-10-134></a>    <span class=n>model_history</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>load</span><span class=p>(</span><span class=n>model_folder</span> <span class=o>/</span> <span class=s2>&quot;history.npy&quot;</span><span class=p>,</span> <span class=n>allow_pickle</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span><span class=o>.</span><span class=n>item</span><span class=p>()</span>
<a id=__codelineno-10-135 name=__codelineno-10-135></a>
<a id=__codelineno-10-136 name=__codelineno-10-136></a>    <span class=c1># Log metrics</span>
<a id=__codelineno-10-137 name=__codelineno-10-137></a>    <span class=n>val_loss</span><span class=p>,</span> <span class=n>val_acc</span> <span class=o>=</span> <span class=n>model</span><span class=o>.</span><span class=n>evaluate</span><span class=p>(</span><span class=n>ds_test</span><span class=p>)</span>
<a id=__codelineno-10-138 name=__codelineno-10-138></a>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Validation loss: </span><span class=si>{</span><span class=n>val_loss</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<a id=__codelineno-10-139 name=__codelineno-10-139></a>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Validation accuracy: </span><span class=si>{</span><span class=n>val_acc</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=mi>100</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>%&quot;</span><span class=p>)</span>
<a id=__codelineno-10-140 name=__codelineno-10-140></a>    <span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=n>evaluation_folder</span> <span class=o>/</span> <span class=s2>&quot;metrics.json&quot;</span><span class=p>,</span> <span class=s2>&quot;w&quot;</span><span class=p>)</span> <span class=k>as</span> <span class=n>f</span><span class=p>:</span>
<a id=__codelineno-10-141 name=__codelineno-10-141></a>        <span class=n>json</span><span class=o>.</span><span class=n>dump</span><span class=p>({</span><span class=s2>&quot;val_loss&quot;</span><span class=p>:</span> <span class=n>val_loss</span><span class=p>,</span> <span class=s2>&quot;val_acc&quot;</span><span class=p>:</span> <span class=n>val_acc</span><span class=p>},</span> <span class=n>f</span><span class=p>)</span>
<a id=__codelineno-10-142 name=__codelineno-10-142></a>
<a id=__codelineno-10-143 name=__codelineno-10-143></a>    <span class=c1># Save training history plot</span>
<a id=__codelineno-10-144 name=__codelineno-10-144></a>    <span class=n>fig</span> <span class=o>=</span> <span class=n>get_training_plot</span><span class=p>(</span><span class=n>model_history</span><span class=p>)</span>
<a id=__codelineno-10-145 name=__codelineno-10-145></a>    <span class=n>fig</span><span class=o>.</span><span class=n>savefig</span><span class=p>(</span><span class=n>evaluation_folder</span> <span class=o>/</span> <span class=n>plots_folder</span> <span class=o>/</span> <span class=s2>&quot;training_history.png&quot;</span><span class=p>)</span>
<a id=__codelineno-10-146 name=__codelineno-10-146></a>
<a id=__codelineno-10-147 name=__codelineno-10-147></a>    <span class=c1># Save predictions preview plot</span>
<a id=__codelineno-10-148 name=__codelineno-10-148></a>    <span class=n>fig</span> <span class=o>=</span> <span class=n>get_pred_preview_plot</span><span class=p>(</span><span class=n>model</span><span class=p>,</span> <span class=n>ds_test</span><span class=p>,</span> <span class=n>labels</span><span class=p>)</span>
<a id=__codelineno-10-149 name=__codelineno-10-149></a>    <span class=n>fig</span><span class=o>.</span><span class=n>savefig</span><span class=p>(</span><span class=n>evaluation_folder</span> <span class=o>/</span> <span class=n>plots_folder</span> <span class=o>/</span> <span class=s2>&quot;pred_preview.png&quot;</span><span class=p>)</span>
<a id=__codelineno-10-150 name=__codelineno-10-150></a>
<a id=__codelineno-10-151 name=__codelineno-10-151></a>    <span class=c1># Save confusion matrix plot</span>
<a id=__codelineno-10-152 name=__codelineno-10-152></a>    <span class=n>fig</span> <span class=o>=</span> <span class=n>get_confusion_matrix_plot</span><span class=p>(</span><span class=n>model</span><span class=p>,</span> <span class=n>ds_test</span><span class=p>,</span> <span class=n>labels</span><span class=p>)</span>
<a id=__codelineno-10-153 name=__codelineno-10-153></a>    <span class=n>fig</span><span class=o>.</span><span class=n>savefig</span><span class=p>(</span><span class=n>evaluation_folder</span> <span class=o>/</span> <span class=n>plots_folder</span> <span class=o>/</span> <span class=s2>&quot;confusion_matrix.png&quot;</span><span class=p>)</span>
<a id=__codelineno-10-154 name=__codelineno-10-154></a>
<a id=__codelineno-10-155 name=__codelineno-10-155></a>    <span class=nb>print</span><span class=p>(</span>
<a id=__codelineno-10-156 name=__codelineno-10-156></a>        <span class=sa>f</span><span class=s2>&quot;</span><span class=se>\n</span><span class=s2>Evaluation metrics and plot files saved at </span><span class=si>{</span><span class=n>evaluation_folder</span><span class=o>.</span><span class=n>absolute</span><span class=p>()</span><span class=si>}</span><span class=s2>&quot;</span>
<a id=__codelineno-10-157 name=__codelineno-10-157></a>    <span class=p>)</span>
<a id=__codelineno-10-158 name=__codelineno-10-158></a>
<a id=__codelineno-10-159 name=__codelineno-10-159></a>
<a id=__codelineno-10-160 name=__codelineno-10-160></a><span class=k>if</span> <span class=vm>__name__</span> <span class=o>==</span> <span class=s2>&quot;__main__&quot;</span><span class=p>:</span>
<a id=__codelineno-10-161 name=__codelineno-10-161></a>    <span class=n>main</span><span class=p>()</span>
</code></pre></div></td></tr></table></div> <h4 id=create-the-seed-helper-function>Create the seed helper function<a class=headerlink href=#create-the-seed-helper-function title="Permanent link">&para;</a></h4> <p>Finally, add a module for utils:</p> <div class=highlight><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>Execute the following command(s) in a terminal</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-11-1>1</a></span>
<span class=normal><a href=#__codelineno-11-2>2</a></span>
<span class=normal><a href=#__codelineno-11-3>3</a></span>
<span class=normal><a href=#__codelineno-11-4>4</a></span>
<span class=normal><a href=#__codelineno-11-5>5</a></span></pre></div></td><td class=code><div><pre><span></span><code><a id=__codelineno-11-1 name=__codelineno-11-1></a><span class=c1># Create the utils module</span>
<a id=__codelineno-11-2 name=__codelineno-11-2></a>mkdir<span class=w> </span>src/utils
<a id=__codelineno-11-3 name=__codelineno-11-3></a>
<a id=__codelineno-11-4 name=__codelineno-11-4></a><span class=c1># Create the __init__.py file to make the utils module a package</span>
<a id=__codelineno-11-5 name=__codelineno-11-5></a>touch<span class=w> </span>src/utils/__init__.py
</code></pre></div></td></tr></table></div> <p>In this module, include <code>src/utils/seed.py</code> to handle the fixing of the seed parameters. This ensure the results are reproducible:</p> <div class=highlight><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>src/utils/seed.py</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-12-1> 1</a></span>
<span class=normal><a href=#__codelineno-12-2> 2</a></span>
<span class=normal><a href=#__codelineno-12-3> 3</a></span>
<span class=normal><a href=#__codelineno-12-4> 4</a></span>
<span class=normal><a href=#__codelineno-12-5> 5</a></span>
<span class=normal><a href=#__codelineno-12-6> 6</a></span>
<span class=normal><a href=#__codelineno-12-7> 7</a></span>
<span class=normal><a href=#__codelineno-12-8> 8</a></span>
<span class=normal><a href=#__codelineno-12-9> 9</a></span>
<span class=normal><a href=#__codelineno-12-10>10</a></span>
<span class=normal><a href=#__codelineno-12-11>11</a></span>
<span class=normal><a href=#__codelineno-12-12>12</a></span>
<span class=normal><a href=#__codelineno-12-13>13</a></span>
<span class=normal><a href=#__codelineno-12-14>14</a></span>
<span class=normal><a href=#__codelineno-12-15>15</a></span>
<span class=normal><a href=#__codelineno-12-16>16</a></span>
<span class=normal><a href=#__codelineno-12-17>17</a></span>
<span class=normal><a href=#__codelineno-12-18>18</a></span></pre></div></td><td class=code><div><pre><span></span><code><a id=__codelineno-12-1 name=__codelineno-12-1></a><span class=kn>import</span> <span class=nn>os</span>
<a id=__codelineno-12-2 name=__codelineno-12-2></a><span class=kn>import</span> <span class=nn>random</span>
<a id=__codelineno-12-3 name=__codelineno-12-3></a>
<a id=__codelineno-12-4 name=__codelineno-12-4></a><span class=kn>import</span> <span class=nn>numpy</span> <span class=k>as</span> <span class=nn>np</span>
<a id=__codelineno-12-5 name=__codelineno-12-5></a><span class=kn>import</span> <span class=nn>tensorflow</span> <span class=k>as</span> <span class=nn>tf</span>
<a id=__codelineno-12-6 name=__codelineno-12-6></a>
<a id=__codelineno-12-7 name=__codelineno-12-7></a>
<a id=__codelineno-12-8 name=__codelineno-12-8></a><span class=k>def</span> <span class=nf>set_seed</span><span class=p>(</span><span class=n>seed</span><span class=p>:</span> <span class=nb>int</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=kc>None</span><span class=p>:</span>
<a id=__codelineno-12-9 name=__codelineno-12-9></a>    <span class=n>os</span><span class=o>.</span><span class=n>environ</span><span class=p>[</span><span class=s2>&quot;PYTHONHASHSEED&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=nb>str</span><span class=p>(</span><span class=n>seed</span><span class=p>)</span>
<a id=__codelineno-12-10 name=__codelineno-12-10></a>    <span class=n>random</span><span class=o>.</span><span class=n>seed</span><span class=p>(</span><span class=n>seed</span><span class=p>)</span>
<a id=__codelineno-12-11 name=__codelineno-12-11></a>    <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>seed</span><span class=p>(</span><span class=n>seed</span><span class=p>)</span>
<a id=__codelineno-12-12 name=__codelineno-12-12></a>
<a id=__codelineno-12-13 name=__codelineno-12-13></a>    <span class=n>os</span><span class=o>.</span><span class=n>environ</span><span class=p>[</span><span class=s2>&quot;TF_DETERMINISTIC_OPS&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=s2>&quot;1&quot;</span>
<a id=__codelineno-12-14 name=__codelineno-12-14></a>    <span class=n>os</span><span class=o>.</span><span class=n>environ</span><span class=p>[</span><span class=s2>&quot;TF_CUDNN_DETERMINISTIC&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=s2>&quot;1&quot;</span>
<a id=__codelineno-12-15 name=__codelineno-12-15></a>
<a id=__codelineno-12-16 name=__codelineno-12-16></a>    <span class=n>tf</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>set_seed</span><span class=p>(</span><span class=n>seed</span><span class=p>)</span>
<a id=__codelineno-12-17 name=__codelineno-12-17></a>    <span class=n>tf</span><span class=o>.</span><span class=n>config</span><span class=o>.</span><span class=n>threading</span><span class=o>.</span><span class=n>set_inter_op_parallelism_threads</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
<a id=__codelineno-12-18 name=__codelineno-12-18></a>    <span class=n>tf</span><span class=o>.</span><span class=n>config</span><span class=o>.</span><span class=n>threading</span><span class=o>.</span><span class=n>set_intra_op_parallelism_threads</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</code></pre></div></td></tr></table></div> <h3 id=create-a-readmemd-file>Create a <code>README.md</code> file<a class=headerlink href=#create-a-readmemd-file title="Permanent link">&para;</a></h3> <p>Finally, create a <code>README.md</code> file at the root of the project to describe the repository. Feel free to use the following template. As you progress though this guide, you can add your notes in the <code>## Notes</code> section:</p> <div class=highlight><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>README.md</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-13-1>1</a></span>
<span class=normal><a href=#__codelineno-13-2>2</a></span>
<span class=normal><a href=#__codelineno-13-3>3</a></span>
<span class=normal><a href=#__codelineno-13-4>4</a></span>
<span class=normal><a href=#__codelineno-13-5>5</a></span>
<span class=normal><a href=#__codelineno-13-6>6</a></span>
<span class=normal><a href=#__codelineno-13-7>7</a></span></pre></div></td><td class=code><div><pre><span></span><code><a id=__codelineno-13-1 name=__codelineno-13-1></a><span class=gh># MLOps - Celestial Body Classification</span>
<a id=__codelineno-13-2 name=__codelineno-13-2></a>
<a id=__codelineno-13-3 name=__codelineno-13-3></a>This repository contains the code from
<a id=__codelineno-13-4 name=__codelineno-13-4></a>[<span class=nt>A guide to MLOps</span>](<span class=na>https://mlops.swiss-ai-center.ch/</span>).
<a id=__codelineno-13-5 name=__codelineno-13-5></a>
<a id=__codelineno-13-6 name=__codelineno-13-6></a><span class=gu>## Notes</span>
<a id=__codelineno-13-7 name=__codelineno-13-7></a>&lt;!-- Enter your notes below --&gt;
</code></pre></div></td></tr></table></div> <h3 id=check-the-results>Check the results<a class=headerlink href=#check-the-results title="Permanent link">&para;</a></h3> <p>Your working directory should now look like this:</p> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-14-1> 1</a></span>
<span class=normal><a href=#__codelineno-14-2> 2</a></span>
<span class=normal><a href=#__codelineno-14-3> 3</a></span>
<span class=normal><a href=#__codelineno-14-4> 4</a></span>
<span class=normal><a href=#__codelineno-14-5> 5</a></span>
<span class=normal><a href=#__codelineno-14-6> 6</a></span>
<span class=normal><a href=#__codelineno-14-7> 7</a></span>
<span class=normal><a href=#__codelineno-14-8> 8</a></span>
<span class=normal><a href=#__codelineno-14-9> 9</a></span>
<span class=normal><a href=#__codelineno-14-10>10</a></span>
<span class=normal><a href=#__codelineno-14-11>11</a></span>
<span class=normal><a href=#__codelineno-14-12>12</a></span>
<span class=normal><a href=#__codelineno-14-13>13</a></span>
<span class=normal><a href=#__codelineno-14-14>14</a></span>
<span class=normal><a href=#__codelineno-14-15>15</a></span>
<span class=normal><a href=#__codelineno-14-16>16</a></span></pre></div></td><td class=code><div><pre><span></span><code><a id=__codelineno-14-1 name=__codelineno-14-1></a><span class="l l-Scalar l-Scalar-Plain">.</span>
<a id=__codelineno-14-2 name=__codelineno-14-2></a><span class="l l-Scalar l-Scalar-Plain">├── data</span>
<a id=__codelineno-14-3 name=__codelineno-14-3></a><span class="l l-Scalar l-Scalar-Plain">│   ├── raw</span>
<a id=__codelineno-14-4 name=__codelineno-14-4></a><span class="l l-Scalar l-Scalar-Plain">│   │   └── ...</span>
<a id=__codelineno-14-5 name=__codelineno-14-5></a><span class="l l-Scalar l-Scalar-Plain">│   └── README.md</span>
<a id=__codelineno-14-6 name=__codelineno-14-6></a><span class=hll><span class="l l-Scalar l-Scalar-Plain">├── src</span><span class=w> </span><span class=c1># (1)!</span>
</span><a id=__codelineno-14-7 name=__codelineno-14-7></a><span class=hll><span class="l l-Scalar l-Scalar-Plain">│</span><span class=err>  </span><span class="l l-Scalar l-Scalar-Plain"> ├── utils</span>
</span><a id=__codelineno-14-8 name=__codelineno-14-8></a><span class=hll><span class="l l-Scalar l-Scalar-Plain">│</span><span class=err>  </span><span class="l l-Scalar l-Scalar-Plain"> │</span><span class=err>  </span><span class="l l-Scalar l-Scalar-Plain"> ├── __init__.py</span>
</span><a id=__codelineno-14-9 name=__codelineno-14-9></a><span class=hll><span class="l l-Scalar l-Scalar-Plain">│</span><span class=err>  </span><span class="l l-Scalar l-Scalar-Plain"> │</span><span class=err>  </span><span class="l l-Scalar l-Scalar-Plain"> └── seed.py</span>
</span><a id=__codelineno-14-10 name=__codelineno-14-10></a><span class=hll><span class="l l-Scalar l-Scalar-Plain">│</span><span class=err>  </span><span class="l l-Scalar l-Scalar-Plain"> ├── evaluate.py</span>
</span><a id=__codelineno-14-11 name=__codelineno-14-11></a><span class=hll><span class="l l-Scalar l-Scalar-Plain">│</span><span class=err>  </span><span class="l l-Scalar l-Scalar-Plain"> ├── prepare.py</span>
</span><a id=__codelineno-14-12 name=__codelineno-14-12></a><span class=hll><span class="l l-Scalar l-Scalar-Plain">│</span><span class=err>  </span><span class="l l-Scalar l-Scalar-Plain"> └── train.py</span>
</span><a id=__codelineno-14-13 name=__codelineno-14-13></a><span class=hll><span class="l l-Scalar l-Scalar-Plain">├── README.md</span><span class=w> </span><span class=c1># (2)!</span>
</span><a id=__codelineno-14-14 name=__codelineno-14-14></a><span class=hll><span class="l l-Scalar l-Scalar-Plain">├── params.yaml</span><span class=w> </span><span class=c1># (3)!</span>
</span><a id=__codelineno-14-15 name=__codelineno-14-15></a><span class=hll><span class="l l-Scalar l-Scalar-Plain">├── requirements-freeze.txt</span><span class=w> </span><span class=c1># (4)!</span>
</span><a id=__codelineno-14-16 name=__codelineno-14-16></a><span class=hll><span class="l l-Scalar l-Scalar-Plain">└── requirements.txt</span><span class=w> </span><span class=c1># (5)!</span>
</span></code></pre></div></td></tr></table></div> <ol> <li>This, and all its sub-directory, is new.</li> <li>This is new.</li> <li>This is new.</li> <li>This is new.</li> <li>This is new.</li> </ol> <h3 id=run-the-experiment>Run the experiment<a class=headerlink href=#run-the-experiment title="Permanent link">&para;</a></h3> <p>Awesome! You now have everything you need to run the experiment: the codebase and the dataset are in place, the new virtual environment is set up, and you are ready to run the experiment using scripts for the first time.</p> <p>You can now follow these steps to reproduce the experiment:</p> <div class=highlight><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>Execute the following command(s) in a terminal</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-15-1>1</a></span>
<span class=normal><a href=#__codelineno-15-2>2</a></span>
<span class=normal><a href=#__codelineno-15-3>3</a></span>
<span class=normal><a href=#__codelineno-15-4>4</a></span>
<span class=normal><a href=#__codelineno-15-5>5</a></span>
<span class=normal><a href=#__codelineno-15-6>6</a></span>
<span class=normal><a href=#__codelineno-15-7>7</a></span>
<span class=normal><a href=#__codelineno-15-8>8</a></span></pre></div></td><td class=code><div><pre><span></span><code><a id=__codelineno-15-1 name=__codelineno-15-1></a><span class=c1># Prepare the dataset</span>
<a id=__codelineno-15-2 name=__codelineno-15-2></a>python3.12<span class=w> </span>src/prepare.py<span class=w> </span>data/raw<span class=w> </span>data/prepared
<a id=__codelineno-15-3 name=__codelineno-15-3></a>
<a id=__codelineno-15-4 name=__codelineno-15-4></a><span class=c1># Train the model with the train dataset and save it</span>
<a id=__codelineno-15-5 name=__codelineno-15-5></a>python3.12<span class=w> </span>src/train.py<span class=w> </span>data/prepared<span class=w> </span>model
<a id=__codelineno-15-6 name=__codelineno-15-6></a>
<a id=__codelineno-15-7 name=__codelineno-15-7></a><span class=c1># Evaluate the model performance</span>
<a id=__codelineno-15-8 name=__codelineno-15-8></a>python3.12<span class=w> </span>src/evaluate.py<span class=w> </span>model<span class=w> </span>data/prepared
</code></pre></div></td></tr></table></div> <p>The experiment will take some time to run. Once it is done, you will find the results in the <code>data/prepared</code>, <code>model</code>, and <code>evaluation</code> directories.</p> <h3 id=check-the-results_1>Check the results<a class=headerlink href=#check-the-results_1 title="Permanent link">&para;</a></h3> <p>Your working directory should now be similar to this:</p> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-16-1> 1</a></span>
<span class=normal><a href=#__codelineno-16-2> 2</a></span>
<span class=normal><a href=#__codelineno-16-3> 3</a></span>
<span class=normal><a href=#__codelineno-16-4> 4</a></span>
<span class=normal><a href=#__codelineno-16-5> 5</a></span>
<span class=normal><a href=#__codelineno-16-6> 6</a></span>
<span class=normal><a href=#__codelineno-16-7> 7</a></span>
<span class=normal><a href=#__codelineno-16-8> 8</a></span>
<span class=normal><a href=#__codelineno-16-9> 9</a></span>
<span class=normal><a href=#__codelineno-16-10>10</a></span>
<span class=normal><a href=#__codelineno-16-11>11</a></span>
<span class=normal><a href=#__codelineno-16-12>12</a></span>
<span class=normal><a href=#__codelineno-16-13>13</a></span>
<span class=normal><a href=#__codelineno-16-14>14</a></span>
<span class=normal><a href=#__codelineno-16-15>15</a></span>
<span class=normal><a href=#__codelineno-16-16>16</a></span>
<span class=normal><a href=#__codelineno-16-17>17</a></span>
<span class=normal><a href=#__codelineno-16-18>18</a></span>
<span class=normal><a href=#__codelineno-16-19>19</a></span>
<span class=normal><a href=#__codelineno-16-20>20</a></span>
<span class=normal><a href=#__codelineno-16-21>21</a></span>
<span class=normal><a href=#__codelineno-16-22>22</a></span>
<span class=normal><a href=#__codelineno-16-23>23</a></span>
<span class=normal><a href=#__codelineno-16-24>24</a></span>
<span class=normal><a href=#__codelineno-16-25>25</a></span>
<span class=normal><a href=#__codelineno-16-26>26</a></span>
<span class=normal><a href=#__codelineno-16-27>27</a></span>
<span class=normal><a href=#__codelineno-16-28>28</a></span>
<span class=normal><a href=#__codelineno-16-29>29</a></span>
<span class=normal><a href=#__codelineno-16-30>30</a></span>
<span class=normal><a href=#__codelineno-16-31>31</a></span></pre></div></td><td class=code><div><pre><span></span><code><a id=__codelineno-16-1 name=__codelineno-16-1></a><span class="l l-Scalar l-Scalar-Plain">.</span>
<a id=__codelineno-16-2 name=__codelineno-16-2></a><span class="l l-Scalar l-Scalar-Plain">├── data</span>
<a id=__codelineno-16-3 name=__codelineno-16-3></a><span class=hll><span class="l l-Scalar l-Scalar-Plain">│</span><span class=err>  </span><span class="l l-Scalar l-Scalar-Plain"> ├── prepared</span><span class=w> </span><span class=c1># (1)!</span>
</span><a id=__codelineno-16-4 name=__codelineno-16-4></a><span class=hll><span class="l l-Scalar l-Scalar-Plain">│</span><span class=err>  </span><span class="l l-Scalar l-Scalar-Plain"> │</span><span class=err>  </span><span class="l l-Scalar l-Scalar-Plain"> ├── test</span>
</span><a id=__codelineno-16-5 name=__codelineno-16-5></a><span class=hll><span class="l l-Scalar l-Scalar-Plain">│</span><span class=err>  </span><span class="l l-Scalar l-Scalar-Plain"> │</span><span class=err>  </span><span class="l l-Scalar l-Scalar-Plain"> │</span><span class=err> </span><span class="l l-Scalar l-Scalar-Plain">  └── ...</span>
</span><a id=__codelineno-16-6 name=__codelineno-16-6></a><span class=hll><span class="l l-Scalar l-Scalar-Plain">│</span><span class=err>  </span><span class="l l-Scalar l-Scalar-Plain"> │</span><span class=err>  </span><span class="l l-Scalar l-Scalar-Plain"> ├── train</span>
</span><a id=__codelineno-16-7 name=__codelineno-16-7></a><span class=hll><span class="l l-Scalar l-Scalar-Plain">│</span><span class=err>  </span><span class="l l-Scalar l-Scalar-Plain"> │</span><span class=err>  </span><span class="l l-Scalar l-Scalar-Plain"> │</span><span class=err> </span><span class="l l-Scalar l-Scalar-Plain">  └── ...</span>
</span><a id=__codelineno-16-8 name=__codelineno-16-8></a><span class=hll><span class="l l-Scalar l-Scalar-Plain">│</span><span class=err>  </span><span class="l l-Scalar l-Scalar-Plain"> │</span><span class=err>  </span><span class="l l-Scalar l-Scalar-Plain"> ├── labels.json</span>
</span><a id=__codelineno-16-9 name=__codelineno-16-9></a><span class=hll><span class="l l-Scalar l-Scalar-Plain">│</span><span class=err>  </span><span class="l l-Scalar l-Scalar-Plain"> │</span><span class=err>  </span><span class="l l-Scalar l-Scalar-Plain"> └── preview.png</span>
</span><a id=__codelineno-16-10 name=__codelineno-16-10></a><span class="l l-Scalar l-Scalar-Plain">│   ├── raw</span>
<a id=__codelineno-16-11 name=__codelineno-16-11></a><span class="l l-Scalar l-Scalar-Plain">│   │   └── ...</span>
<a id=__codelineno-16-12 name=__codelineno-16-12></a><span class="l l-Scalar l-Scalar-Plain">│</span><span class=err>  </span><span class="l l-Scalar l-Scalar-Plain"> └── README.md</span>
<a id=__codelineno-16-13 name=__codelineno-16-13></a><span class=hll><span class="l l-Scalar l-Scalar-Plain">├── evaluation</span><span class=w> </span><span class=c1># (2)!</span>
</span><a id=__codelineno-16-14 name=__codelineno-16-14></a><span class=hll><span class="l l-Scalar l-Scalar-Plain">│</span><span class=err>  </span><span class="l l-Scalar l-Scalar-Plain"> ├── plots</span>
</span><a id=__codelineno-16-15 name=__codelineno-16-15></a><span class=hll><span class="l l-Scalar l-Scalar-Plain">│</span><span class=err>  </span><span class="l l-Scalar l-Scalar-Plain"> │</span><span class=err>  </span><span class="l l-Scalar l-Scalar-Plain"> ├── confusion_matrix.png</span>
</span><a id=__codelineno-16-16 name=__codelineno-16-16></a><span class=hll><span class="l l-Scalar l-Scalar-Plain">│</span><span class=err>  </span><span class="l l-Scalar l-Scalar-Plain"> │</span><span class=err>  </span><span class="l l-Scalar l-Scalar-Plain"> ├── pred_preview.png</span>
</span><a id=__codelineno-16-17 name=__codelineno-16-17></a><span class=hll><span class="l l-Scalar l-Scalar-Plain">│</span><span class=err>  </span><span class="l l-Scalar l-Scalar-Plain"> │</span><span class=err>  </span><span class="l l-Scalar l-Scalar-Plain"> └── training_history.png</span>
</span><a id=__codelineno-16-18 name=__codelineno-16-18></a><span class=hll><span class="l l-Scalar l-Scalar-Plain">│</span><span class=err>  </span><span class="l l-Scalar l-Scalar-Plain"> └── metrics.json</span>
</span><a id=__codelineno-16-19 name=__codelineno-16-19></a><span class=hll><span class="l l-Scalar l-Scalar-Plain">├── model</span><span class=w> </span><span class=c1># (4)!</span>
</span><a id=__codelineno-16-20 name=__codelineno-16-20></a><span class=hll><span class="l l-Scalar l-Scalar-Plain">│</span><span class=err>  </span><span class="l l-Scalar l-Scalar-Plain"> └── ...</span>
</span><a id=__codelineno-16-21 name=__codelineno-16-21></a><span class="l l-Scalar l-Scalar-Plain">├── src</span>
<a id=__codelineno-16-22 name=__codelineno-16-22></a><span class="l l-Scalar l-Scalar-Plain">│</span><span class=err>  </span><span class="l l-Scalar l-Scalar-Plain"> ├── utils</span>
<a id=__codelineno-16-23 name=__codelineno-16-23></a><span class="l l-Scalar l-Scalar-Plain">│</span><span class=err>  </span><span class="l l-Scalar l-Scalar-Plain"> │</span><span class=err>  </span><span class="l l-Scalar l-Scalar-Plain"> ├── __init__.py</span>
<a id=__codelineno-16-24 name=__codelineno-16-24></a><span class="l l-Scalar l-Scalar-Plain">│   │   └── seed.py</span>
<a id=__codelineno-16-25 name=__codelineno-16-25></a><span class="l l-Scalar l-Scalar-Plain">│   ├── evaluate.py</span>
<a id=__codelineno-16-26 name=__codelineno-16-26></a><span class="l l-Scalar l-Scalar-Plain">│   ├── prepare.py</span>
<a id=__codelineno-16-27 name=__codelineno-16-27></a><span class="l l-Scalar l-Scalar-Plain">│   └── train.py</span>
<a id=__codelineno-16-28 name=__codelineno-16-28></a><span class="l l-Scalar l-Scalar-Plain">├── README.md</span>
<a id=__codelineno-16-29 name=__codelineno-16-29></a><span class="l l-Scalar l-Scalar-Plain">├── params.yaml</span>
<a id=__codelineno-16-30 name=__codelineno-16-30></a><span class="l l-Scalar l-Scalar-Plain">├── requirements-freeze.txt</span>
<a id=__codelineno-16-31 name=__codelineno-16-31></a><span class="l l-Scalar l-Scalar-Plain">└── requirements.txt</span>
</code></pre></div></td></tr></table></div> <ol> <li>This, and all its sub-directory, is new.</li> <li>This, and all its sub-directory, is new.</li> <li>This is new.</li> <li>This is new.</li> </ol> <p>Here, the following should be noted:</p> <ul> <li>the <code>prepare.py</code> script created the <code>data/prepared</code> directory and divided the dataset into a training set and a test set</li> <li>the <code>train.py</code> script created the <code>model</code> directory and trained the model with the prepared data.</li> <li>the <code>evaluate.py</code> script created the <code>evaluation</code> directory and generated some plots and metrics to evaluate the model</li> </ul> <p>Take some time to get familiar with the scripts and the results.</p> <h2 id=summary>Summary<a class=headerlink href=#summary title="Permanent link">&para;</a></h2> <p>Congratulations! You have successfully reproduced the experiment on your machine, this time using a modular approach that can be put into production.</p> <p>In this chapter, you have:</p> <ol> <li>Set up a Python environment using <code>pip</code> and <code>virtualenv</code></li> <li>Adapted the content of the Jupyter Notebook into Python scripts</li> <li>Launched the experiment locally</li> </ol> <p>However, you may have identified the following areas for improvement:</p> <ul class=task-list> <li class=task-list-item><label class=task-list-control><input type=checkbox><span class=task-list-indicator></span></label> Codebase is not versioned</li> <li class=task-list-item><label class=task-list-control><input type=checkbox><span class=task-list-indicator></span></label> Dataset still needs manual download and placement</li> <li class=task-list-item><label class=task-list-control><input type=checkbox><span class=task-list-indicator></span></label> Steps to run the experiment were not documented</li> <li class=task-list-item><label class=task-list-control><input type=checkbox><span class=task-list-indicator></span></label> Codebase is not easily sharable</li> <li class=task-list-item><label class=task-list-control><input type=checkbox><span class=task-list-indicator></span></label> Dataset is not easily sharable</li> </ul> <p>In the next chapters, you will enhance the workflow to fix those issues.</p> <p>You can now safely continue to the next chapter.</p> <h2 id=state-of-the-mlops-process>State of the MLOps process<a class=headerlink href=#state-of-the-mlops-process title="Permanent link">&para;</a></h2> <ul class=task-list> <li class=task-list-item><label class=task-list-control><input type=checkbox checked><span class=task-list-indicator></span></label> Notebook has been transformed into scripts for production</li> <li class=task-list-item><label class=task-list-control><input type=checkbox><span class=task-list-indicator></span></label> Codebase and dataset are not versioned</li> <li class=task-list-item><label class=task-list-control><input type=checkbox><span class=task-list-indicator></span></label> Model steps rely on verbal communication and may be undocumented</li> <li class=task-list-item><label class=task-list-control><input type=checkbox><span class=task-list-indicator></span></label> Changes to model are not easily visualized</li> <li class=task-list-item><label class=task-list-control><input type=checkbox><span class=task-list-indicator></span></label> Model may have required artifacts that are forgotten or omitted in saved/loaded state</li> <li class=task-list-item><label class=task-list-control><input type=checkbox><span class=task-list-indicator></span></label> Model cannot be easily used from outside of the experiment context</li> </ul> <p>You will address these issues in the next chapters for improved efficiency and collaboration. Continue the guide to learn how.</p> <h2 id=sources>Sources<a class=headerlink href=#sources title="Permanent link">&para;</a></h2> <p>Highly inspired by:</p> <ul> <li><a href=https://dvc.org/doc/start/data-management/data-pipelines><em>Get Started: Data Pipelines</em> - dvc.org</a></li> <li><a href=https://stackoverflow.com/questions/36288235/how-to-get-stable-results-with-tensorflow-setting-random-seed><em>How to get stable results with TensorFlow, setting random seed</em> - stackoverflow.com</a></li> </ul> <aside class=md-source-file> <span class=md-source-file__fact> <span class=md-icon title="Last update"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M21 13.1c-.1 0-.3.1-.4.2l-1 1 2.1 2.1 1-1c.2-.2.2-.6 0-.8l-1.3-1.3c-.1-.1-.2-.2-.4-.2m-1.9 1.8-6.1 6V23h2.1l6.1-6.1zM12.5 7v5.2l4 2.4-1 1L11 13V7zM11 21.9c-5.1-.5-9-4.8-9-9.9C2 6.5 6.5 2 12 2c5.3 0 9.6 4.1 10 9.3-.3-.1-.6-.2-1-.2s-.7.1-1 .2C19.6 7.2 16.2 4 12 4c-4.4 0-8 3.6-8 8 0 4.1 3.1 7.5 7.1 7.9l-.1.2z"/></svg> </span> <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-datetime">February 3, 2025 13:43:14</span> </span> </aside> </article> </div> <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var labels=set.querySelector(".tabbed-labels");for(var tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script> <script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script> </div> <button type=button class="md-top md-icon" data-md-component=top hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg> Back to top </button> </main> <footer class=md-footer> <nav class="md-footer__inner md-grid" aria-label=Footer> <a href=../chapter-11-run-a-simple-ml-experiment-with-jupyter-notebook/ class="md-footer__link md-footer__link--prev" aria-label="Previous: Chapter 1.1 - Run a simple ML experiment with Jupyter Notebook"> <div class="md-footer__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg> </div> <div class=md-footer__title> <span class=md-footer__direction> Previous </span> <div class=md-ellipsis> Chapter 1.1 - Run a simple ML experiment with Jupyter Notebook </div> </div> </a> <a href=../chapter-13-initialize-git-and-dvc-for-local-training/ class="md-footer__link md-footer__link--next" aria-label="Next: Chapter 1.3 - Initialize Git and DVC for local training"> <div class=md-footer__title> <span class=md-footer__direction> Next </span> <div class=md-ellipsis> Chapter 1.3 - Initialize Git and DVC for local training </div> </div> <div class="md-footer__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11z"/></svg> </div> </a> </nav> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-copyright> <div class=md-copyright__highlight> Copyright &copy; 2025 Swiss AI Center </div> Made with <a href=https://squidfunk.github.io/mkdocs-material/ target=_blank rel=noopener> Material for MkDocs </a> </div> <div class=md-social> <a href=https://swiss-ai-center.ch target=_blank rel=noopener title="Swiss AI Center" class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M17.9 17.39c-.26-.8-1.01-1.39-1.9-1.39h-1v-3a1 1 0 0 0-1-1H8v-2h2a1 1 0 0 0 1-1V7h2a2 2 0 0 0 2-2v-.41a7.984 7.984 0 0 1 2.9 12.8M11 19.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.22.21-1.79L9 15v1a2 2 0 0 0 2 2m1-16A10 10 0 0 0 2 12a10 10 0 0 0 10 10 10 10 0 0 0 10-10A10 10 0 0 0 12 2"/></svg> </a> <a href=https://github.com/swiss-ai-center target=_blank rel=noopener title="Swiss AI Center on GitHub" class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 2A10 10 0 0 0 2 12c0 4.42 2.87 8.17 6.84 9.5.5.08.66-.23.66-.5v-1.69c-2.77.6-3.36-1.34-3.36-1.34-.46-1.16-1.11-1.47-1.11-1.47-.91-.62.07-.6.07-.6 1 .07 1.53 1.03 1.53 1.03.87 1.52 2.34 1.07 2.91.83.09-.65.35-1.09.63-1.34-2.22-.25-4.55-1.11-4.55-4.92 0-1.11.38-2 1.03-2.71-.1-.25-.45-1.29.1-2.64 0 0 .84-.27 2.75 1.02.79-.22 1.65-.33 2.5-.33s1.71.11 2.5.33c1.91-1.29 2.75-1.02 2.75-1.02.55 1.35.2 2.39.1 2.64.65.71 1.03 1.6 1.03 2.71 0 3.82-2.34 4.66-4.57 4.91.36.31.69.92.69 1.85V21c0 .27.16.59.67.5C19.14 20.16 22 16.42 22 12A10 10 0 0 0 12 2"/></svg> </a> </div> </div> </div> </footer> </div> <div class=md-dialog data-md-component=dialog> <div class="md-dialog__inner md-typeset"></div> </div> <script id=__config type=application/json>{"base": "../..", "features": ["announce.dismiss", "content.code.annotate", "content.code.copy", "content.action.edit", "content.action.view", "content.tabs.link", "navigation.indexes", "navigation.instant", "navigation.tabs", "navigation.tabs.sticky", "navigation.top", "navigation.footer", "search.suggest", "search.highlight", "toc.follow"], "search": "../../assets/javascripts/workers/search.6ce7567c.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script> <script src=../../assets/javascripts/bundle.83f73b43.min.js></script> <script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script> <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> <script src=https://unpkg.com/tablesort@5.3.0/dist/tablesort.min.js></script> <script src=../../assets/javascripts/mathjax.js></script> <script src=../../assets/javascripts/tablesort.js></script> <script src=../../assets/javascripts/parallax.js></script> <script src=../../assets/javascripts/scrollAnimations.js></script> <script id=init-glightbox>const lightbox = GLightbox({"touchNavigation": true, "loop": false, "zoomable": true, "draggable": true, "openEffect": "zoom", "closeEffect": "zoom", "slideEffect": "slide"});
document$.subscribe(() => { lightbox.reload() });
</script></body> </html>