<!doctype html><html lang=en class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Workshop AI Days@HES-SO Machine Learning Operations - MLOps"><meta name=author content="Swiss AI Center contributors"><link href=https://swiss-ai-center.github.io/workshop-mlops/part-3-serve-and-deploy-the-model/chapter-31-save-and-load-the-model-with-bentoml/ rel=canonical><link href=../introduction/ rel=prev><link href=../chapter-32-serve-the-model-locally-with-bentoml/ rel=next><link rel=icon href=../../assets/images/favicon.svg><meta name=generator content="mkdocs-1.6.1, mkdocs-material-9.5.42"><title>Chapter 3.1 - Save and load the model with BentoML - AI Days@HES-SO Workshop MLOps</title><link rel=stylesheet href=../../assets/stylesheets/main.0253249f.min.css><link rel=stylesheet href=../../assets/stylesheets/palette.06af60db.min.css><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback"><style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style><link rel=stylesheet href=../../assets/stylesheets/extra.css><script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script><meta property=og:type content=website><meta property=og:title content="Chapter 3.1 - Save and load the model with BentoML - AI Days@HES-SO Workshop MLOps"><meta property=og:description content="Workshop AI Days@HES-SO Machine Learning Operations - MLOps"><meta property=og:image content=https://swiss-ai-center.github.io/workshop-mlops/assets/images/social/part-3-serve-and-deploy-the-model/chapter-31-save-and-load-the-model-with-bentoml.png><meta property=og:image:type content=image/png><meta property=og:image:width content=1200><meta property=og:image:height content=630><meta content=https://swiss-ai-center.github.io/workshop-mlops/part-3-serve-and-deploy-the-model/chapter-31-save-and-load-the-model-with-bentoml/ property=og:url><meta name=twitter:card content=summary_large_image><meta name=twitter:title content="Chapter 3.1 - Save and load the model with BentoML - AI Days@HES-SO Workshop MLOps"><meta name=twitter:description content="Workshop AI Days@HES-SO Machine Learning Operations - MLOps"><meta name=twitter:image content=https://swiss-ai-center.github.io/workshop-mlops/assets/images/social/part-3-serve-and-deploy-the-model/chapter-31-save-and-load-the-model-with-bentoml.png><link href=../../assets/stylesheets/glightbox.min.css rel=stylesheet><style>
    html.glightbox-open { overflow: initial; height: 100%; }
    .gslide-title { margin-top: 0px; user-select: text; }
    .gslide-desc { color: #666; user-select: text; }
    .gslide-image img { background: white; }
    .gscrollbar-fixer { padding-right: 15px; }
    .gdesc-inner { font-size: 0.75rem; }
    body[data-md-color-scheme="slate"] .gdesc-inner { background: var(--md-default-bg-color);}
    body[data-md-color-scheme="slate"] .gslide-title { color: var(--md-default-fg-color);}
    body[data-md-color-scheme="slate"] .gslide-desc { color: var(--md-default-fg-color);}</style><script src=../../assets/javascripts/glightbox.min.js></script></head> <body dir=ltr data-md-color-scheme=default data-md-color-primary=indigo data-md-color-accent=indigo> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#chapter-31-save-and-load-the-model-with-bentoml class=md-skip> Skip to content </a> </div> <div data-md-component=announce> </div> <header class="md-header md-header--shadow md-header--lifted" data-md-component=header> <nav class="md-header__inner md-grid" aria-label=Header> <a href=../.. title="AI Days@HES-SO Workshop MLOps" class="md-header__button md-logo" aria-label="AI Days@HES-SO Workshop MLOps" data-md-component=logo> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M18.6 6.62c-1.44 0-2.8.56-3.77 1.53L7.8 14.39c-.64.64-1.49.99-2.4.99C3.53 15.38 2 13.87 2 12s1.53-3.38 3.4-3.38c.91 0 1.76.35 2.44 1.03l1.13 1 1.53-1.34L9.22 8.2A5.37 5.37 0 0 0 5.4 6.62C2.42 6.62 0 9.04 0 12s2.42 5.38 5.4 5.38c1.44 0 2.8-.56 3.77-1.53l7.03-6.24c.64-.64 1.49-.99 2.4-.99 1.87 0 3.4 1.51 3.4 3.38s-1.53 3.38-3.4 3.38c-.9 0-1.76-.35-2.44-1.03L15 13.34l-1.5 1.34 1.28 1.12a5.39 5.39 0 0 0 3.82 1.57c2.98 0 5.4-2.41 5.4-5.37 0-3-2.42-5.38-5.4-5.38"/></svg> </a> <label class="md-header__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg> </label> <div class=md-header__title data-md-component=header-title> <div class=md-header__ellipsis> <div class=md-header__topic> <span class=md-ellipsis> AI Days@HES-SO Workshop MLOps </span> </div> <div class=md-header__topic data-md-component=header-topic> <span class=md-ellipsis> Chapter 3.1 - Save and load the model with BentoML </span> </div> </div> </div> <form class=md-header__option data-md-component=palette> <input class=md-option data-md-color-media=(prefers-color-scheme) data-md-color-scheme=default data-md-color-primary=indigo data-md-color-accent=indigo aria-label="Switch to light mode" type=radio name=__palette id=__palette_0> <label class="md-header__button md-icon" title="Switch to light mode" for=__palette_1 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="m14.3 16-.7-2h-3.2l-.7 2H7.8L11 7h2l3.2 9zM20 8.69V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12zm-9.15 3.96h2.3L12 9z"/></svg> </label> <input class=md-option data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme=default data-md-color-primary=indigo data-md-color-accent=indigo aria-label="Switch to dark mode" type=radio name=__palette id=__palette_1> <label class="md-header__button md-icon" title="Switch to dark mode" for=__palette_2 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg> </label> <input class=md-option data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme=slate data-md-color-primary=indigo data-md-color-accent=indigo aria-label="Switch to system preference" type=radio name=__palette id=__palette_2> <label class="md-header__button md-icon" title="Switch to system preference" for=__palette_0 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg> </label> </form> <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script> <label class="md-header__button md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg> </label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query aria-label=Search placeholder=Search autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query required> <label class="md-search__icon md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg> </label> <nav class=md-search__options aria-label=Search> <button type=reset class="md-search__icon md-icon" title=Clear aria-label=Clear tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg> </button> </nav> <div class=md-search__suggest data-md-component=search-suggest></div> </form> <div class=md-search__output> <div class=md-search__scrollwrap tabindex=0 data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> Initializing search </div> <ol class=md-search-result__list role=presentation></ol> </div> </div> </div> </div> </div> </nav> <nav class=md-tabs aria-label=Tabs data-md-component=tabs> <div class=md-grid> <ul class=md-tabs__list> <li class=md-tabs__item> <a href=../../syllabus/ class=md-tabs__link> üèÅ Introduction </a> </li> <li class=md-tabs__item> <a href=../../part-1-local-training/introduction/ class=md-tabs__link> üè† Local training </a> </li> <li class=md-tabs__item> <a href=../../part-2-model-evaluation/introduction/ class=md-tabs__link> üìä Model evaluation </a> </li> <li class="md-tabs__item md-tabs__item--active"> <a href=../introduction/ class=md-tabs__link> üöö Serve the model </a> </li> <li class=md-tabs__item> <a href=../../conclusion/ class=md-tabs__link> ü™Ñ Conclusion </a> </li> </ul> </div> </nav> </header> <div class=md-container data-md-component=container> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary md-nav--lifted" aria-label=Navigation data-md-level=0> <label class=md-nav__title for=__drawer> <a href=../.. title="AI Days@HES-SO Workshop MLOps" class="md-nav__button md-logo" aria-label="AI Days@HES-SO Workshop MLOps" data-md-component=logo> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M18.6 6.62c-1.44 0-2.8.56-3.77 1.53L7.8 14.39c-.64.64-1.49.99-2.4.99C3.53 15.38 2 13.87 2 12s1.53-3.38 3.4-3.38c.91 0 1.76.35 2.44 1.03l1.13 1 1.53-1.34L9.22 8.2A5.37 5.37 0 0 0 5.4 6.62C2.42 6.62 0 9.04 0 12s2.42 5.38 5.4 5.38c1.44 0 2.8-.56 3.77-1.53l7.03-6.24c.64-.64 1.49-.99 2.4-.99 1.87 0 3.4 1.51 3.4 3.38s-1.53 3.38-3.4 3.38c-.9 0-1.76-.35-2.44-1.03L15 13.34l-1.5 1.34 1.28 1.12a5.39 5.39 0 0 0 3.82 1.57c2.98 0 5.4-2.41 5.4-5.37 0-3-2.42-5.38-5.4-5.38"/></svg> </a> AI Days@HES-SO Workshop MLOps </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_1> <label class=md-nav__link for=__nav_1 id=__nav_1_label tabindex=0> <span class=md-ellipsis> üèÅ Introduction </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_1_label aria-expanded=false> <label class=md-nav__title for=__nav_1> <span class="md-nav__icon md-icon"></span> üèÅ Introduction </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../syllabus/ class=md-nav__link> <span class=md-ellipsis> Syllabus </span> </a> </li> <li class=md-nav__item> <a href=../../concept/ class=md-nav__link> <span class=md-ellipsis> Concept </span> </a> </li> <li class=md-nav__item> <a href=../../tools/ class=md-nav__link> <span class=md-ellipsis> Tools </span> </a> </li> <li class=md-nav__item> <a href=../../wsl2/ class=md-nav__link> <span class=md-ellipsis> Installing WSL 2 </span> </a> </li> <li class=md-nav__item> <a href=../../commands/ class=md-nav__link> <span class=md-ellipsis> Commands </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2> <label class=md-nav__link for=__nav_2 id=__nav_2_label tabindex=0> <span class=md-ellipsis> üè† Local training </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_2_label aria-expanded=false> <label class=md-nav__title for=__nav_2> <span class="md-nav__icon md-icon"></span> üè† Local training </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../part-1-local-training/introduction/ class=md-nav__link> <span class=md-ellipsis> Introduction </span> </a> </li> <li class=md-nav__item> <a href=../../part-1-local-training/chapter-11-run-a-simple-ml-experiment-with-jupyter-notebook/ class=md-nav__link> <span class=md-ellipsis> Chapter 1.1 - Run a simple ML experiment with Jupyter Notebook </span> </a> </li> <li class=md-nav__item> <a href=../../part-1-local-training/chapter-12-adapt-and-move-the-jupyter-notebook-to-python-scripts/ class=md-nav__link> <span class=md-ellipsis> Chapter 1.2 - Adapt and move the Jupyter Notebook to Python scripts </span> </a> </li> <li class=md-nav__item> <a href=../../part-1-local-training/chapter-13-initialize-git-and-dvc-for-local-training/ class=md-nav__link> <span class=md-ellipsis> Chapter 1.3 - Initialize Git and DVC for local training </span> </a> </li> <li class=md-nav__item> <a href=../../part-1-local-training/conclusion/ class=md-nav__link> <span class=md-ellipsis> Conclusion </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_3> <label class=md-nav__link for=__nav_3 id=__nav_3_label tabindex=0> <span class=md-ellipsis> üìä Model evaluation </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_3_label aria-expanded=false> <label class=md-nav__title for=__nav_3> <span class="md-nav__icon md-icon"></span> üìä Model evaluation </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../part-2-model-evaluation/introduction/ class=md-nav__link> <span class=md-ellipsis> Introduction </span> </a> </li> <li class=md-nav__item> <a href=../../part-2-model-evaluation/chapter-21-reproduce-the-ml-experiment-with-dvc/ class=md-nav__link> <span class=md-ellipsis> Chapter 2.1 - Reproduce the ML experiment with DVC </span> </a> </li> <li class=md-nav__item> <a href=../../part-2-model-evaluation/chapter-22-track-model-evolution-with-dvc/ class=md-nav__link> <span class=md-ellipsis> Chapter 2.2 - Track model evolution with DVC </span> </a> </li> <li class=md-nav__item> <a href=../../part-2-model-evaluation/conclusion/ class=md-nav__link> <span class=md-ellipsis> Conclusion </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_4 checked> <label class=md-nav__link for=__nav_4 id=__nav_4_label tabindex> <span class=md-ellipsis> üöö Serve the model </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_4_label aria-expanded=true> <label class=md-nav__title for=__nav_4> <span class="md-nav__icon md-icon"></span> üöö Serve the model </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../introduction/ class=md-nav__link> <span class=md-ellipsis> Introduction </span> </a> </li> <li class="md-nav__item md-nav__item--active"> <input class="md-nav__toggle md-toggle" type=checkbox id=__toc> <label class="md-nav__link md-nav__link--active" for=__toc> <span class=md-ellipsis> Chapter 3.1 - Save and load the model with BentoML </span> <span class="md-nav__icon md-icon"></span> </label> <a href=./ class="md-nav__link md-nav__link--active"> <span class=md-ellipsis> Chapter 3.1 - Save and load the model with BentoML </span> </a> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#introduction class=md-nav__link> <span class=md-ellipsis> Introduction </span> </a> </li> <li class=md-nav__item> <a href=#steps class=md-nav__link> <span class=md-ellipsis> Steps </span> </a> <nav class=md-nav aria-label=Steps> <ul class=md-nav__list> <li class=md-nav__item> <a href=#install-bentoml-and-dependencies class=md-nav__link> <span class=md-ellipsis> Install BentoML and dependencies </span> </a> </li> <li class=md-nav__item> <a href=#update-the-experiment class=md-nav__link> <span class=md-ellipsis> Update the experiment </span> </a> <nav class=md-nav aria-label="Update the experiment"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#update-srctrainpy class=md-nav__link> <span class=md-ellipsis> Update src/train.py </span> </a> </li> <li class=md-nav__item> <a href=#update-srcevaluatepy class=md-nav__link> <span class=md-ellipsis> Update src/evaluate.py </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#run-the-experiment class=md-nav__link> <span class=md-ellipsis> Run the experiment </span> </a> </li> <li class=md-nav__item> <a href=#check-the-changes class=md-nav__link> <span class=md-ellipsis> Check the changes </span> </a> </li> <li class=md-nav__item> <a href=#commit-the-changes-to-git class=md-nav__link> <span class=md-ellipsis> Commit the changes to Git </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#summary class=md-nav__link> <span class=md-ellipsis> Summary </span> </a> </li> <li class=md-nav__item> <a href=#state-of-the-mlops-process class=md-nav__link> <span class=md-ellipsis> State of the MLOps process </span> </a> </li> <li class=md-nav__item> <a href=#sources class=md-nav__link> <span class=md-ellipsis> Sources </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../chapter-32-serve-the-model-locally-with-bentoml/ class=md-nav__link> <span class=md-ellipsis> Chapter 3.2 - Serve the model locally with BentoML </span> </a> </li> <li class=md-nav__item> <a href=../chapter-33-build-and-publish-the-model-with-bentoml-and-docker-locally/ class=md-nav__link> <span class=md-ellipsis> Chapter 3.3 - Build and publish the model with BentoML and Docker locally </span> </a> </li> <li class=md-nav__item> <a href=../conclusion/ class=md-nav__link> <span class=md-ellipsis> Conclusion </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_5> <label class=md-nav__link for=__nav_5 id=__nav_5_label tabindex=0> <span class=md-ellipsis> ü™Ñ Conclusion </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_5_label aria-expanded=false> <label class=md-nav__title for=__nav_5> <span class="md-nav__icon md-icon"></span> ü™Ñ Conclusion </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../conclusion/ class=md-nav__link> <span class=md-ellipsis> Conclusion </span> </a> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=sidebar data-md-type=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#introduction class=md-nav__link> <span class=md-ellipsis> Introduction </span> </a> </li> <li class=md-nav__item> <a href=#steps class=md-nav__link> <span class=md-ellipsis> Steps </span> </a> <nav class=md-nav aria-label=Steps> <ul class=md-nav__list> <li class=md-nav__item> <a href=#install-bentoml-and-dependencies class=md-nav__link> <span class=md-ellipsis> Install BentoML and dependencies </span> </a> </li> <li class=md-nav__item> <a href=#update-the-experiment class=md-nav__link> <span class=md-ellipsis> Update the experiment </span> </a> <nav class=md-nav aria-label="Update the experiment"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#update-srctrainpy class=md-nav__link> <span class=md-ellipsis> Update src/train.py </span> </a> </li> <li class=md-nav__item> <a href=#update-srcevaluatepy class=md-nav__link> <span class=md-ellipsis> Update src/evaluate.py </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#run-the-experiment class=md-nav__link> <span class=md-ellipsis> Run the experiment </span> </a> </li> <li class=md-nav__item> <a href=#check-the-changes class=md-nav__link> <span class=md-ellipsis> Check the changes </span> </a> </li> <li class=md-nav__item> <a href=#commit-the-changes-to-git class=md-nav__link> <span class=md-ellipsis> Commit the changes to Git </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#summary class=md-nav__link> <span class=md-ellipsis> Summary </span> </a> </li> <li class=md-nav__item> <a href=#state-of-the-mlops-process class=md-nav__link> <span class=md-ellipsis> State of the MLOps process </span> </a> </li> <li class=md-nav__item> <a href=#sources class=md-nav__link> <span class=md-ellipsis> Sources </span> </a> </li> </ul> </nav> </div> </div> </div> <div class=md-content data-md-component=content> <article class="md-content__inner md-typeset"> <a href=blob/main/docs/part-3-serve-and-deploy-the-model/chapter-31-save-and-load-the-model-with-bentoml.md title="Edit this page" class="md-content__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M10 20H6V4h7v5h5v3.1l2-2V8l-6-6H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h4zm10.2-7c.1 0 .3.1.4.2l1.3 1.3c.2.2.2.6 0 .8l-1 1-2.1-2.1 1-1c.1-.1.2-.2.4-.2m0 3.9L14.1 23H12v-2.1l6.1-6.1z"/></svg> </a> <a href=blob/main/docs/part-3-serve-and-deploy-the-model/chapter-31-save-and-load-the-model-with-bentoml.md title="View source of this page" class="md-content__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M17 18c.56 0 1 .44 1 1s-.44 1-1 1-1-.44-1-1 .44-1 1-1m0-3c-2.73 0-5.06 1.66-6 4 .94 2.34 3.27 4 6 4s5.06-1.66 6-4c-.94-2.34-3.27-4-6-4m0 6.5a2.5 2.5 0 0 1-2.5-2.5 2.5 2.5 0 0 1 2.5-2.5 2.5 2.5 0 0 1 2.5 2.5 2.5 2.5 0 0 1-2.5 2.5M9.27 20H6V4h7v5h5v4.07c.7.08 1.36.25 2 .49V8l-6-6H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h4.5a8.2 8.2 0 0 1-1.23-2"/></svg> </a> <h1 id=chapter-31-save-and-load-the-model-with-bentoml>Chapter 3.1 - Save and load the model with BentoML<a class=headerlink href=#chapter-31-save-and-load-the-model-with-bentoml title="Permanent link">&para;</a></h1> <h2 id=introduction>Introduction<a class=headerlink href=#introduction title="Permanent link">&para;</a></h2> <p>The purpose of this chapter is to serve and use the model for usage outside of the experiment context with the help of <a href=../../tools/ ><span class=twemoji><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M16.3 11a1.1 1.1 0 1 0 0-2.2 1.1 1.1 0 0 0 0 2.2m-4.4 0a1.1 1.1 0 1 0 0-2.2 1.1 1.1 0 0 0 0 2.2M5.67 0a1.2 1.2 0 0 0-.815.318L.386 4.444A1.2 1.2 0 0 0 0 5.325V22.4A1.6 1.6 0 0 0 1.6 24h17.048a1.2 1.2 0 0 0 .911-.42l4.152-4.843a1.2 1.2 0 0 0 .289-.781V1.6A1.6 1.6 0 0 0 22.4 0ZM6 .6h16.2a1.2 1.2 0 0 1 1.2 1.2v15.8a1.6 1.6 0 0 1-1.6 1.6H6A1.2 1.2 0 0 1 4.8 18V1.8A1.2 1.2 0 0 1 6 .6"/></svg></span> BentoML</a>, a tool designed for easy packaging, deployment, and serving of Machine Learning models.</p> <p>By transforming your model into a BentoML model artifact, it is possible to load the model for future usage with all its dependencies. This will allow you to use the model in a production environment, share it with others, and deploy it to a cluster.</p> <p>In this chapter, you will learn how to:</p> <ol> <li>Install BentoML</li> <li>Learn about BentoML's model store</li> <li>Update and run the experiment to use BentoML to save and load the model to and from the model's store</li> </ol> <p>The following diagram illustrates the control flow of the experiment at the end of this chapter:</p> <pre class=mermaid><code>flowchart TB
    workspaceGraph &lt;-....-&gt; dot_git
    data[data/raw]
    subgraph cacheGraph[CACHE]
        dot_dvc[(.dvc)]
        dot_git[(.git)]
    end
    subgraph workspaceGraph[WORKSPACE]
        data --&gt; code[*.py]
        subgraph dvcGraph["dvc.yaml"]
            code
        end
        params[params.yaml] -.- code
        bento_model[model/classifier.bentomodel]
        bento_model &lt;-.-&gt; dot_dvc
        code --&gt; |save_model
                  export_model|bento_model
        bento_model --&gt; |import_model
                         load_model|code
    end
    style workspaceGraph opacity:0.4,color:#7f7f7f80
    style dvcGraph opacity:0.4,color:#7f7f7f80
    style cacheGraph opacity:0.4,color:#7f7f7f80
    style data opacity:0.4,color:#7f7f7f80
    style dot_git opacity:0.4,color:#7f7f7f80
    style dot_dvc opacity:0.4,color:#7f7f7f80
    style code opacity:0.4,color:#7f7f7f80
    style params opacity:0.4,color:#7f7f7f80
    linkStyle 0 opacity:0.4,color:#7f7f7f80
    linkStyle 1 opacity:0.4,color:#7f7f7f80
    linkStyle 2 opacity:0.4,color:#7f7f7f80
    linkStyle 3 opacity:0.4,color:#7f7f7f80
    linkStyle 4 opacity:0.4,color:#7f7f7f80
    linkStyle 5 opacity:0.4,color:#7f7f7f80</code></pre> <h2 id=steps>Steps<a class=headerlink href=#steps title="Permanent link">&para;</a></h2> <h3 id=install-bentoml-and-dependencies>Install BentoML and dependencies<a class=headerlink href=#install-bentoml-and-dependencies title="Permanent link">&para;</a></h3> <p>Add the <code>bentoml</code> package to install BentoML support. <code>pillow</code> is also added to support image processing:</p> <div class=highlight><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>requirements.txt</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-0-1>1</a></span>
<span class=normal><a href=#__codelineno-0-2>2</a></span>
<span class=normal><a href=#__codelineno-0-3>3</a></span>
<span class=normal><a href=#__codelineno-0-4>4</a></span>
<span class=normal><a href=#__codelineno-0-5>5</a></span>
<span class=normal><a href=#__codelineno-0-6>6</a></span></pre></div></td><td class=code><div><pre><span></span><code><a id=__codelineno-0-1 name=__codelineno-0-1></a>tensorflow==2.17.1
<a id=__codelineno-0-2 name=__codelineno-0-2></a>matplotlib==3.9.3
<a id=__codelineno-0-3 name=__codelineno-0-3></a>pyyaml==6.0.2
<a id=__codelineno-0-4 name=__codelineno-0-4></a>dvc==3.58.0
<a id=__codelineno-0-5 name=__codelineno-0-5></a><span class=hll>bentoml==1.3.15
</span><a id=__codelineno-0-6 name=__codelineno-0-6></a><span class=hll>pillow==11.0.0
</span></code></pre></div></td></tr></table></div> <p>Check the differences with Git to validate the changes:</p> <div class=highlight><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>Execute the following command(s) in a terminal</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-1-1>1</a></span>
<span class=normal><a href=#__codelineno-1-2>2</a></span></pre></div></td><td class=code><div><pre><span></span><code><a id=__codelineno-1-1 name=__codelineno-1-1></a><span class=c1># Show the differences with Git</span>
<a id=__codelineno-1-2 name=__codelineno-1-2></a>git<span class=w> </span>diff<span class=w> </span>requirements.txt
</code></pre></div></td></tr></table></div> <p>The output should be similar to this:</p> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-2-1> 1</a></span>
<span class=normal><a href=#__codelineno-2-2> 2</a></span>
<span class=normal><a href=#__codelineno-2-3> 3</a></span>
<span class=normal><a href=#__codelineno-2-4> 4</a></span>
<span class=normal><a href=#__codelineno-2-5> 5</a></span>
<span class=normal><a href=#__codelineno-2-6> 6</a></span>
<span class=normal><a href=#__codelineno-2-7> 7</a></span>
<span class=normal><a href=#__codelineno-2-8> 8</a></span>
<span class=normal><a href=#__codelineno-2-9> 9</a></span>
<span class=normal><a href=#__codelineno-2-10>10</a></span></pre></div></td><td class=code><div><pre><span></span><code><a id=__codelineno-2-1 name=__codelineno-2-1></a><span class=gh>diff --git a/requirements.txt b/requirements.txt</span>
<a id=__codelineno-2-2 name=__codelineno-2-2></a><span class=gh>index 4b8d3d9..d584cca 100644</span>
<a id=__codelineno-2-3 name=__codelineno-2-3></a><span class=gd>--- a/requirements.txt</span>
<a id=__codelineno-2-4 name=__codelineno-2-4></a><span class=gi>+++ b/requirements.txt</span>
<a id=__codelineno-2-5 name=__codelineno-2-5></a><span class=gu>@@ -2,3 +2,5 @@ tensorflow==2.17.1</span>
<a id=__codelineno-2-6 name=__codelineno-2-6></a><span class=w> </span>matplotlib==3.9.3
<a id=__codelineno-2-7 name=__codelineno-2-7></a><span class=w> </span>pyyaml==6.0.2
<a id=__codelineno-2-8 name=__codelineno-2-8></a><span class=w> </span>dvc==3.58.0
<a id=__codelineno-2-9 name=__codelineno-2-9></a><span class=gi>+bentoml==1.3.15</span>
<a id=__codelineno-2-10 name=__codelineno-2-10></a><span class=gi>+pillow==11.0.0</span>
</code></pre></div></td></tr></table></div> <p>Install the package and update the freeze file.</p> <div class="admonition warning"> <p class=admonition-title>Warning</p> <p>Prior to running any pip commands, it is crucial to ensure the virtual environment is activated to avoid potential conflicts with system-wide Python packages.</p> <p>To check its status, simply run <code>pip -V</code>. If the virtual environment is active, the output will show the path to the virtual environment's Python executable. If it is not, you can activate it with <code>source .venv/bin/activate</code>.</p> </div> <div class=highlight><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>Execute the following command(s) in a terminal</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-3-1>1</a></span>
<span class=normal><a href=#__codelineno-3-2>2</a></span>
<span class=normal><a href=#__codelineno-3-3>3</a></span>
<span class=normal><a href=#__codelineno-3-4>4</a></span>
<span class=normal><a href=#__codelineno-3-5>5</a></span></pre></div></td><td class=code><div><pre><span></span><code><a id=__codelineno-3-1 name=__codelineno-3-1></a><span class=c1># Install the dependencies</span>
<a id=__codelineno-3-2 name=__codelineno-3-2></a>pip<span class=w> </span>install<span class=w> </span>--requirement<span class=w> </span>requirements.txt
<a id=__codelineno-3-3 name=__codelineno-3-3></a>
<a id=__codelineno-3-4 name=__codelineno-3-4></a><span class=c1># Freeze the dependencies</span>
<a id=__codelineno-3-5 name=__codelineno-3-5></a>pip<span class=w> </span>freeze<span class=w> </span>--local<span class=w> </span>--all<span class=w> </span>&gt;<span class=w> </span>requirements-freeze.txt
</code></pre></div></td></tr></table></div> <h3 id=update-the-experiment>Update the experiment<a class=headerlink href=#update-the-experiment title="Permanent link">&para;</a></h3> <p>To make the most of BentoML's capabilities, you must start by converting your model into the specialized BentoML model artifact format with all its dependencies.</p> <p>BentoML offers a model store, which is a centralized repository for all your models. This store is stored in a directory on your local machine at <code>~/bentoml/</code>.</p> <p>In order to share the model with others, the model must be exported in the current working directory. It will then be uploaded to DVC and shared with others.</p> <h4 id=update-srctrainpy>Update <code>src/train.py</code><a class=headerlink href=#update-srctrainpy title="Permanent link">&para;</a></h4> <p>Update the <code>src/train.py</code> file to save the model with BentoML:</p> <div class=highlight><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>src/train.py</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-4-1>  1</a></span>
<span class=normal><a href=#__codelineno-4-2>  2</a></span>
<span class=normal><a href=#__codelineno-4-3>  3</a></span>
<span class=normal><a href=#__codelineno-4-4>  4</a></span>
<span class=normal><a href=#__codelineno-4-5>  5</a></span>
<span class=normal><a href=#__codelineno-4-6>  6</a></span>
<span class=normal><a href=#__codelineno-4-7>  7</a></span>
<span class=normal><a href=#__codelineno-4-8>  8</a></span>
<span class=normal><a href=#__codelineno-4-9>  9</a></span>
<span class=normal><a href=#__codelineno-4-10> 10</a></span>
<span class=normal><a href=#__codelineno-4-11> 11</a></span>
<span class=normal><a href=#__codelineno-4-12> 12</a></span>
<span class=normal><a href=#__codelineno-4-13> 13</a></span>
<span class=normal><a href=#__codelineno-4-14> 14</a></span>
<span class=normal><a href=#__codelineno-4-15> 15</a></span>
<span class=normal><a href=#__codelineno-4-16> 16</a></span>
<span class=normal><a href=#__codelineno-4-17> 17</a></span>
<span class=normal><a href=#__codelineno-4-18> 18</a></span>
<span class=normal><a href=#__codelineno-4-19> 19</a></span>
<span class=normal><a href=#__codelineno-4-20> 20</a></span>
<span class=normal><a href=#__codelineno-4-21> 21</a></span>
<span class=normal><a href=#__codelineno-4-22> 22</a></span>
<span class=normal><a href=#__codelineno-4-23> 23</a></span>
<span class=normal><a href=#__codelineno-4-24> 24</a></span>
<span class=normal><a href=#__codelineno-4-25> 25</a></span>
<span class=normal><a href=#__codelineno-4-26> 26</a></span>
<span class=normal><a href=#__codelineno-4-27> 27</a></span>
<span class=normal><a href=#__codelineno-4-28> 28</a></span>
<span class=normal><a href=#__codelineno-4-29> 29</a></span>
<span class=normal><a href=#__codelineno-4-30> 30</a></span>
<span class=normal><a href=#__codelineno-4-31> 31</a></span>
<span class=normal><a href=#__codelineno-4-32> 32</a></span>
<span class=normal><a href=#__codelineno-4-33> 33</a></span>
<span class=normal><a href=#__codelineno-4-34> 34</a></span>
<span class=normal><a href=#__codelineno-4-35> 35</a></span>
<span class=normal><a href=#__codelineno-4-36> 36</a></span>
<span class=normal><a href=#__codelineno-4-37> 37</a></span>
<span class=normal><a href=#__codelineno-4-38> 38</a></span>
<span class=normal><a href=#__codelineno-4-39> 39</a></span>
<span class=normal><a href=#__codelineno-4-40> 40</a></span>
<span class=normal><a href=#__codelineno-4-41> 41</a></span>
<span class=normal><a href=#__codelineno-4-42> 42</a></span>
<span class=normal><a href=#__codelineno-4-43> 43</a></span>
<span class=normal><a href=#__codelineno-4-44> 44</a></span>
<span class=normal><a href=#__codelineno-4-45> 45</a></span>
<span class=normal><a href=#__codelineno-4-46> 46</a></span>
<span class=normal><a href=#__codelineno-4-47> 47</a></span>
<span class=normal><a href=#__codelineno-4-48> 48</a></span>
<span class=normal><a href=#__codelineno-4-49> 49</a></span>
<span class=normal><a href=#__codelineno-4-50> 50</a></span>
<span class=normal><a href=#__codelineno-4-51> 51</a></span>
<span class=normal><a href=#__codelineno-4-52> 52</a></span>
<span class=normal><a href=#__codelineno-4-53> 53</a></span>
<span class=normal><a href=#__codelineno-4-54> 54</a></span>
<span class=normal><a href=#__codelineno-4-55> 55</a></span>
<span class=normal><a href=#__codelineno-4-56> 56</a></span>
<span class=normal><a href=#__codelineno-4-57> 57</a></span>
<span class=normal><a href=#__codelineno-4-58> 58</a></span>
<span class=normal><a href=#__codelineno-4-59> 59</a></span>
<span class=normal><a href=#__codelineno-4-60> 60</a></span>
<span class=normal><a href=#__codelineno-4-61> 61</a></span>
<span class=normal><a href=#__codelineno-4-62> 62</a></span>
<span class=normal><a href=#__codelineno-4-63> 63</a></span>
<span class=normal><a href=#__codelineno-4-64> 64</a></span>
<span class=normal><a href=#__codelineno-4-65> 65</a></span>
<span class=normal><a href=#__codelineno-4-66> 66</a></span>
<span class=normal><a href=#__codelineno-4-67> 67</a></span>
<span class=normal><a href=#__codelineno-4-68> 68</a></span>
<span class=normal><a href=#__codelineno-4-69> 69</a></span>
<span class=normal><a href=#__codelineno-4-70> 70</a></span>
<span class=normal><a href=#__codelineno-4-71> 71</a></span>
<span class=normal><a href=#__codelineno-4-72> 72</a></span>
<span class=normal><a href=#__codelineno-4-73> 73</a></span>
<span class=normal><a href=#__codelineno-4-74> 74</a></span>
<span class=normal><a href=#__codelineno-4-75> 75</a></span>
<span class=normal><a href=#__codelineno-4-76> 76</a></span>
<span class=normal><a href=#__codelineno-4-77> 77</a></span>
<span class=normal><a href=#__codelineno-4-78> 78</a></span>
<span class=normal><a href=#__codelineno-4-79> 79</a></span>
<span class=normal><a href=#__codelineno-4-80> 80</a></span>
<span class=normal><a href=#__codelineno-4-81> 81</a></span>
<span class=normal><a href=#__codelineno-4-82> 82</a></span>
<span class=normal><a href=#__codelineno-4-83> 83</a></span>
<span class=normal><a href=#__codelineno-4-84> 84</a></span>
<span class=normal><a href=#__codelineno-4-85> 85</a></span>
<span class=normal><a href=#__codelineno-4-86> 86</a></span>
<span class=normal><a href=#__codelineno-4-87> 87</a></span>
<span class=normal><a href=#__codelineno-4-88> 88</a></span>
<span class=normal><a href=#__codelineno-4-89> 89</a></span>
<span class=normal><a href=#__codelineno-4-90> 90</a></span>
<span class=normal><a href=#__codelineno-4-91> 91</a></span>
<span class=normal><a href=#__codelineno-4-92> 92</a></span>
<span class=normal><a href=#__codelineno-4-93> 93</a></span>
<span class=normal><a href=#__codelineno-4-94> 94</a></span>
<span class=normal><a href=#__codelineno-4-95> 95</a></span>
<span class=normal><a href=#__codelineno-4-96> 96</a></span>
<span class=normal><a href=#__codelineno-4-97> 97</a></span>
<span class=normal><a href=#__codelineno-4-98> 98</a></span>
<span class=normal><a href=#__codelineno-4-99> 99</a></span>
<span class=normal><a href=#__codelineno-4-100>100</a></span>
<span class=normal><a href=#__codelineno-4-101>101</a></span>
<span class=normal><a href=#__codelineno-4-102>102</a></span>
<span class=normal><a href=#__codelineno-4-103>103</a></span>
<span class=normal><a href=#__codelineno-4-104>104</a></span>
<span class=normal><a href=#__codelineno-4-105>105</a></span>
<span class=normal><a href=#__codelineno-4-106>106</a></span>
<span class=normal><a href=#__codelineno-4-107>107</a></span>
<span class=normal><a href=#__codelineno-4-108>108</a></span>
<span class=normal><a href=#__codelineno-4-109>109</a></span>
<span class=normal><a href=#__codelineno-4-110>110</a></span>
<span class=normal><a href=#__codelineno-4-111>111</a></span>
<span class=normal><a href=#__codelineno-4-112>112</a></span>
<span class=normal><a href=#__codelineno-4-113>113</a></span>
<span class=normal><a href=#__codelineno-4-114>114</a></span>
<span class=normal><a href=#__codelineno-4-115>115</a></span>
<span class=normal><a href=#__codelineno-4-116>116</a></span>
<span class=normal><a href=#__codelineno-4-117>117</a></span>
<span class=normal><a href=#__codelineno-4-118>118</a></span>
<span class=normal><a href=#__codelineno-4-119>119</a></span>
<span class=normal><a href=#__codelineno-4-120>120</a></span>
<span class=normal><a href=#__codelineno-4-121>121</a></span>
<span class=normal><a href=#__codelineno-4-122>122</a></span>
<span class=normal><a href=#__codelineno-4-123>123</a></span>
<span class=normal><a href=#__codelineno-4-124>124</a></span>
<span class=normal><a href=#__codelineno-4-125>125</a></span>
<span class=normal><a href=#__codelineno-4-126>126</a></span>
<span class=normal><a href=#__codelineno-4-127>127</a></span>
<span class=normal><a href=#__codelineno-4-128>128</a></span>
<span class=normal><a href=#__codelineno-4-129>129</a></span>
<span class=normal><a href=#__codelineno-4-130>130</a></span>
<span class=normal><a href=#__codelineno-4-131>131</a></span>
<span class=normal><a href=#__codelineno-4-132>132</a></span>
<span class=normal><a href=#__codelineno-4-133>133</a></span>
<span class=normal><a href=#__codelineno-4-134>134</a></span></pre></div></td><td class=code><div><pre><span></span><code><a id=__codelineno-4-1 name=__codelineno-4-1></a><span class=hll><span class=kn>import</span> <span class=nn>json</span>
</span><a id=__codelineno-4-2 name=__codelineno-4-2></a><span class=kn>import</span> <span class=nn>sys</span>
<a id=__codelineno-4-3 name=__codelineno-4-3></a><span class=kn>from</span> <span class=nn>pathlib</span> <span class=kn>import</span> <span class=n>Path</span>
<a id=__codelineno-4-4 name=__codelineno-4-4></a><span class=kn>from</span> <span class=nn>typing</span> <span class=kn>import</span> <span class=n>Tuple</span>
<a id=__codelineno-4-5 name=__codelineno-4-5></a>
<a id=__codelineno-4-6 name=__codelineno-4-6></a><span class=kn>import</span> <span class=nn>numpy</span> <span class=k>as</span> <span class=nn>np</span>
<a id=__codelineno-4-7 name=__codelineno-4-7></a><span class=kn>import</span> <span class=nn>tensorflow</span> <span class=k>as</span> <span class=nn>tf</span>
<a id=__codelineno-4-8 name=__codelineno-4-8></a><span class=kn>import</span> <span class=nn>yaml</span>
<a id=__codelineno-4-9 name=__codelineno-4-9></a><span class=hll><span class=kn>import</span> <span class=nn>bentoml</span>
</span><a id=__codelineno-4-10 name=__codelineno-4-10></a><span class=hll><span class=kn>from</span> <span class=nn>PIL.Image</span> <span class=kn>import</span> <span class=n>Image</span>
</span><a id=__codelineno-4-11 name=__codelineno-4-11></a>
<a id=__codelineno-4-12 name=__codelineno-4-12></a><span class=kn>from</span> <span class=nn>utils.seed</span> <span class=kn>import</span> <span class=n>set_seed</span>
<a id=__codelineno-4-13 name=__codelineno-4-13></a>
<a id=__codelineno-4-14 name=__codelineno-4-14></a>
<a id=__codelineno-4-15 name=__codelineno-4-15></a><span class=k>def</span> <span class=nf>get_model</span><span class=p>(</span>
<a id=__codelineno-4-16 name=__codelineno-4-16></a>    <span class=n>image_shape</span><span class=p>:</span> <span class=n>Tuple</span><span class=p>[</span><span class=nb>int</span><span class=p>,</span> <span class=nb>int</span><span class=p>,</span> <span class=nb>int</span><span class=p>],</span>
<a id=__codelineno-4-17 name=__codelineno-4-17></a>    <span class=n>conv_size</span><span class=p>:</span> <span class=nb>int</span><span class=p>,</span>
<a id=__codelineno-4-18 name=__codelineno-4-18></a>    <span class=n>dense_size</span><span class=p>:</span> <span class=nb>int</span><span class=p>,</span>
<a id=__codelineno-4-19 name=__codelineno-4-19></a>    <span class=n>output_classes</span><span class=p>:</span> <span class=nb>int</span><span class=p>,</span>
<a id=__codelineno-4-20 name=__codelineno-4-20></a><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>tf</span><span class=o>.</span><span class=n>keras</span><span class=o>.</span><span class=n>Model</span><span class=p>:</span>
<a id=__codelineno-4-21 name=__codelineno-4-21></a><span class=w>    </span><span class=sd>&quot;&quot;&quot;Create a simple CNN model&quot;&quot;&quot;</span>
<a id=__codelineno-4-22 name=__codelineno-4-22></a>    <span class=n>model</span> <span class=o>=</span> <span class=n>tf</span><span class=o>.</span><span class=n>keras</span><span class=o>.</span><span class=n>models</span><span class=o>.</span><span class=n>Sequential</span><span class=p>(</span>
<a id=__codelineno-4-23 name=__codelineno-4-23></a>        <span class=p>[</span>
<a id=__codelineno-4-24 name=__codelineno-4-24></a>            <span class=n>tf</span><span class=o>.</span><span class=n>keras</span><span class=o>.</span><span class=n>layers</span><span class=o>.</span><span class=n>Conv2D</span><span class=p>(</span>
<a id=__codelineno-4-25 name=__codelineno-4-25></a>                <span class=n>conv_size</span><span class=p>,</span> <span class=p>(</span><span class=mi>3</span><span class=p>,</span> <span class=mi>3</span><span class=p>),</span> <span class=n>activation</span><span class=o>=</span><span class=s2>&quot;relu&quot;</span><span class=p>,</span> <span class=n>input_shape</span><span class=o>=</span><span class=n>image_shape</span>
<a id=__codelineno-4-26 name=__codelineno-4-26></a>            <span class=p>),</span>
<a id=__codelineno-4-27 name=__codelineno-4-27></a>            <span class=n>tf</span><span class=o>.</span><span class=n>keras</span><span class=o>.</span><span class=n>layers</span><span class=o>.</span><span class=n>MaxPooling2D</span><span class=p>((</span><span class=mi>3</span><span class=p>,</span> <span class=mi>3</span><span class=p>)),</span>
<a id=__codelineno-4-28 name=__codelineno-4-28></a>            <span class=n>tf</span><span class=o>.</span><span class=n>keras</span><span class=o>.</span><span class=n>layers</span><span class=o>.</span><span class=n>Flatten</span><span class=p>(),</span>
<a id=__codelineno-4-29 name=__codelineno-4-29></a>            <span class=n>tf</span><span class=o>.</span><span class=n>keras</span><span class=o>.</span><span class=n>layers</span><span class=o>.</span><span class=n>Dense</span><span class=p>(</span><span class=n>dense_size</span><span class=p>,</span> <span class=n>activation</span><span class=o>=</span><span class=s2>&quot;relu&quot;</span><span class=p>),</span>
<a id=__codelineno-4-30 name=__codelineno-4-30></a>            <span class=n>tf</span><span class=o>.</span><span class=n>keras</span><span class=o>.</span><span class=n>layers</span><span class=o>.</span><span class=n>Dense</span><span class=p>(</span><span class=n>output_classes</span><span class=p>),</span>
<a id=__codelineno-4-31 name=__codelineno-4-31></a>        <span class=p>]</span>
<a id=__codelineno-4-32 name=__codelineno-4-32></a>    <span class=p>)</span>
<a id=__codelineno-4-33 name=__codelineno-4-33></a>    <span class=k>return</span> <span class=n>model</span>
<a id=__codelineno-4-34 name=__codelineno-4-34></a>
<a id=__codelineno-4-35 name=__codelineno-4-35></a>
<a id=__codelineno-4-36 name=__codelineno-4-36></a><span class=k>def</span> <span class=nf>main</span><span class=p>()</span> <span class=o>-&gt;</span> <span class=kc>None</span><span class=p>:</span>
<a id=__codelineno-4-37 name=__codelineno-4-37></a>    <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>sys</span><span class=o>.</span><span class=n>argv</span><span class=p>)</span> <span class=o>!=</span> <span class=mi>3</span><span class=p>:</span>
<a id=__codelineno-4-38 name=__codelineno-4-38></a>        <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Arguments error. Usage:</span><span class=se>\n</span><span class=s2>&quot;</span><span class=p>)</span>
<a id=__codelineno-4-39 name=__codelineno-4-39></a>        <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;</span><span class=se>\t</span><span class=s2>python3 train.py &lt;prepared-dataset-folder&gt; &lt;model-folder&gt;</span><span class=se>\n</span><span class=s2>&quot;</span><span class=p>)</span>
<a id=__codelineno-4-40 name=__codelineno-4-40></a>        <span class=n>exit</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
<a id=__codelineno-4-41 name=__codelineno-4-41></a>
<a id=__codelineno-4-42 name=__codelineno-4-42></a>    <span class=c1># Load parameters</span>
<a id=__codelineno-4-43 name=__codelineno-4-43></a>    <span class=n>prepare_params</span> <span class=o>=</span> <span class=n>yaml</span><span class=o>.</span><span class=n>safe_load</span><span class=p>(</span><span class=nb>open</span><span class=p>(</span><span class=s2>&quot;params.yaml&quot;</span><span class=p>))[</span><span class=s2>&quot;prepare&quot;</span><span class=p>]</span>
<a id=__codelineno-4-44 name=__codelineno-4-44></a>    <span class=n>train_params</span> <span class=o>=</span> <span class=n>yaml</span><span class=o>.</span><span class=n>safe_load</span><span class=p>(</span><span class=nb>open</span><span class=p>(</span><span class=s2>&quot;params.yaml&quot;</span><span class=p>))[</span><span class=s2>&quot;train&quot;</span><span class=p>]</span>
<a id=__codelineno-4-45 name=__codelineno-4-45></a>
<a id=__codelineno-4-46 name=__codelineno-4-46></a>    <span class=n>prepared_dataset_folder</span> <span class=o>=</span> <span class=n>Path</span><span class=p>(</span><span class=n>sys</span><span class=o>.</span><span class=n>argv</span><span class=p>[</span><span class=mi>1</span><span class=p>])</span>
<a id=__codelineno-4-47 name=__codelineno-4-47></a>    <span class=n>model_folder</span> <span class=o>=</span> <span class=n>Path</span><span class=p>(</span><span class=n>sys</span><span class=o>.</span><span class=n>argv</span><span class=p>[</span><span class=mi>2</span><span class=p>])</span>
<a id=__codelineno-4-48 name=__codelineno-4-48></a>
<a id=__codelineno-4-49 name=__codelineno-4-49></a>    <span class=n>image_size</span> <span class=o>=</span> <span class=n>prepare_params</span><span class=p>[</span><span class=s2>&quot;image_size&quot;</span><span class=p>]</span>
<a id=__codelineno-4-50 name=__codelineno-4-50></a>    <span class=n>grayscale</span> <span class=o>=</span> <span class=n>prepare_params</span><span class=p>[</span><span class=s2>&quot;grayscale&quot;</span><span class=p>]</span>
<a id=__codelineno-4-51 name=__codelineno-4-51></a>    <span class=n>image_shape</span> <span class=o>=</span> <span class=p>(</span><span class=o>*</span><span class=n>image_size</span><span class=p>,</span> <span class=mi>1</span> <span class=k>if</span> <span class=n>grayscale</span> <span class=k>else</span> <span class=mi>3</span><span class=p>)</span>
<a id=__codelineno-4-52 name=__codelineno-4-52></a>
<a id=__codelineno-4-53 name=__codelineno-4-53></a>    <span class=n>seed</span> <span class=o>=</span> <span class=n>train_params</span><span class=p>[</span><span class=s2>&quot;seed&quot;</span><span class=p>]</span>
<a id=__codelineno-4-54 name=__codelineno-4-54></a>    <span class=n>lr</span> <span class=o>=</span> <span class=n>train_params</span><span class=p>[</span><span class=s2>&quot;lr&quot;</span><span class=p>]</span>
<a id=__codelineno-4-55 name=__codelineno-4-55></a>    <span class=n>epochs</span> <span class=o>=</span> <span class=n>train_params</span><span class=p>[</span><span class=s2>&quot;epochs&quot;</span><span class=p>]</span>
<a id=__codelineno-4-56 name=__codelineno-4-56></a>    <span class=n>conv_size</span> <span class=o>=</span> <span class=n>train_params</span><span class=p>[</span><span class=s2>&quot;conv_size&quot;</span><span class=p>]</span>
<a id=__codelineno-4-57 name=__codelineno-4-57></a>    <span class=n>dense_size</span> <span class=o>=</span> <span class=n>train_params</span><span class=p>[</span><span class=s2>&quot;dense_size&quot;</span><span class=p>]</span>
<a id=__codelineno-4-58 name=__codelineno-4-58></a>    <span class=n>output_classes</span> <span class=o>=</span> <span class=n>train_params</span><span class=p>[</span><span class=s2>&quot;output_classes&quot;</span><span class=p>]</span>
<a id=__codelineno-4-59 name=__codelineno-4-59></a>
<a id=__codelineno-4-60 name=__codelineno-4-60></a>    <span class=c1># Set seed for reproducibility</span>
<a id=__codelineno-4-61 name=__codelineno-4-61></a>    <span class=n>set_seed</span><span class=p>(</span><span class=n>seed</span><span class=p>)</span>
<a id=__codelineno-4-62 name=__codelineno-4-62></a>
<a id=__codelineno-4-63 name=__codelineno-4-63></a>    <span class=c1># Load data</span>
<a id=__codelineno-4-64 name=__codelineno-4-64></a>    <span class=n>ds_train</span> <span class=o>=</span> <span class=n>tf</span><span class=o>.</span><span class=n>data</span><span class=o>.</span><span class=n>Dataset</span><span class=o>.</span><span class=n>load</span><span class=p>(</span><span class=nb>str</span><span class=p>(</span><span class=n>prepared_dataset_folder</span> <span class=o>/</span> <span class=s2>&quot;train&quot;</span><span class=p>))</span>
<a id=__codelineno-4-65 name=__codelineno-4-65></a>    <span class=n>ds_test</span> <span class=o>=</span> <span class=n>tf</span><span class=o>.</span><span class=n>data</span><span class=o>.</span><span class=n>Dataset</span><span class=o>.</span><span class=n>load</span><span class=p>(</span><span class=nb>str</span><span class=p>(</span><span class=n>prepared_dataset_folder</span> <span class=o>/</span> <span class=s2>&quot;test&quot;</span><span class=p>))</span>
<a id=__codelineno-4-66 name=__codelineno-4-66></a>
<a id=__codelineno-4-67 name=__codelineno-4-67></a><span class=hll>    <span class=n>labels</span> <span class=o>=</span> <span class=kc>None</span>
</span><a id=__codelineno-4-68 name=__codelineno-4-68></a><span class=hll>    <span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=n>prepared_dataset_folder</span> <span class=o>/</span> <span class=s2>&quot;labels.json&quot;</span><span class=p>)</span> <span class=k>as</span> <span class=n>f</span><span class=p>:</span>
</span><a id=__codelineno-4-69 name=__codelineno-4-69></a><span class=hll>        <span class=n>labels</span> <span class=o>=</span> <span class=n>json</span><span class=o>.</span><span class=n>load</span><span class=p>(</span><span class=n>f</span><span class=p>)</span>
</span><a id=__codelineno-4-70 name=__codelineno-4-70></a>
<a id=__codelineno-4-71 name=__codelineno-4-71></a>    <span class=c1># Define the model</span>
<a id=__codelineno-4-72 name=__codelineno-4-72></a>    <span class=n>model</span> <span class=o>=</span> <span class=n>get_model</span><span class=p>(</span><span class=n>image_shape</span><span class=p>,</span> <span class=n>conv_size</span><span class=p>,</span> <span class=n>dense_size</span><span class=p>,</span> <span class=n>output_classes</span><span class=p>)</span>
<a id=__codelineno-4-73 name=__codelineno-4-73></a>    <span class=n>model</span><span class=o>.</span><span class=n>compile</span><span class=p>(</span>
<a id=__codelineno-4-74 name=__codelineno-4-74></a>        <span class=n>optimizer</span><span class=o>=</span><span class=n>tf</span><span class=o>.</span><span class=n>keras</span><span class=o>.</span><span class=n>optimizers</span><span class=o>.</span><span class=n>Adam</span><span class=p>(</span><span class=n>lr</span><span class=p>),</span>
<a id=__codelineno-4-75 name=__codelineno-4-75></a>        <span class=n>loss</span><span class=o>=</span><span class=n>tf</span><span class=o>.</span><span class=n>keras</span><span class=o>.</span><span class=n>losses</span><span class=o>.</span><span class=n>SparseCategoricalCrossentropy</span><span class=p>(</span><span class=n>from_logits</span><span class=o>=</span><span class=kc>True</span><span class=p>),</span>
<a id=__codelineno-4-76 name=__codelineno-4-76></a>        <span class=n>metrics</span><span class=o>=</span><span class=p>[</span><span class=n>tf</span><span class=o>.</span><span class=n>keras</span><span class=o>.</span><span class=n>metrics</span><span class=o>.</span><span class=n>SparseCategoricalAccuracy</span><span class=p>()],</span>
<a id=__codelineno-4-77 name=__codelineno-4-77></a>    <span class=p>)</span>
<a id=__codelineno-4-78 name=__codelineno-4-78></a>    <span class=n>model</span><span class=o>.</span><span class=n>summary</span><span class=p>()</span>
<a id=__codelineno-4-79 name=__codelineno-4-79></a>
<a id=__codelineno-4-80 name=__codelineno-4-80></a>    <span class=c1># Train the model</span>
<a id=__codelineno-4-81 name=__codelineno-4-81></a>    <span class=n>model</span><span class=o>.</span><span class=n>fit</span><span class=p>(</span>
<a id=__codelineno-4-82 name=__codelineno-4-82></a>        <span class=n>ds_train</span><span class=p>,</span>
<a id=__codelineno-4-83 name=__codelineno-4-83></a>        <span class=n>epochs</span><span class=o>=</span><span class=n>epochs</span><span class=p>,</span>
<a id=__codelineno-4-84 name=__codelineno-4-84></a>        <span class=n>validation_data</span><span class=o>=</span><span class=n>ds_test</span><span class=p>,</span>
<a id=__codelineno-4-85 name=__codelineno-4-85></a>    <span class=p>)</span>
<a id=__codelineno-4-86 name=__codelineno-4-86></a>
<a id=__codelineno-4-87 name=__codelineno-4-87></a>    <span class=c1># Save the model</span>
<a id=__codelineno-4-88 name=__codelineno-4-88></a>    <span class=n>model_folder</span><span class=o>.</span><span class=n>mkdir</span><span class=p>(</span><span class=n>parents</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span> <span class=n>exist_ok</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
<a id=__codelineno-4-89 name=__codelineno-4-89></a>
<a id=__codelineno-4-90 name=__codelineno-4-90></a><span class=hll>    <span class=k>def</span> <span class=nf>preprocess</span><span class=p>(</span><span class=n>x</span><span class=p>:</span> <span class=n>Image</span><span class=p>):</span>
</span><a id=__codelineno-4-91 name=__codelineno-4-91></a><span class=hll>        <span class=c1># convert PIL image to tensor</span>
</span><a id=__codelineno-4-92 name=__codelineno-4-92></a><span class=hll>        <span class=n>x</span> <span class=o>=</span> <span class=n>x</span><span class=o>.</span><span class=n>convert</span><span class=p>(</span><span class=s1>&#39;L&#39;</span> <span class=k>if</span> <span class=n>grayscale</span> <span class=k>else</span> <span class=s1>&#39;RGB&#39;</span><span class=p>)</span>
</span><a id=__codelineno-4-93 name=__codelineno-4-93></a><span class=hll>        <span class=n>x</span> <span class=o>=</span> <span class=n>x</span><span class=o>.</span><span class=n>resize</span><span class=p>(</span><span class=n>image_size</span><span class=p>)</span>
</span><a id=__codelineno-4-94 name=__codelineno-4-94></a><span class=hll>        <span class=n>x</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>array</span><span class=p>(</span><span class=n>x</span><span class=p>)</span>
</span><a id=__codelineno-4-95 name=__codelineno-4-95></a><span class=hll>        <span class=n>x</span> <span class=o>=</span> <span class=n>x</span> <span class=o>/</span> <span class=mf>255.0</span>
</span><a id=__codelineno-4-96 name=__codelineno-4-96></a><span class=hll>        <span class=c1># add batch dimension</span>
</span><a id=__codelineno-4-97 name=__codelineno-4-97></a><span class=hll>        <span class=n>x</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>expand_dims</span><span class=p>(</span><span class=n>x</span><span class=p>,</span> <span class=n>axis</span><span class=o>=</span><span class=mi>0</span><span class=p>)</span>
</span><a id=__codelineno-4-98 name=__codelineno-4-98></a><span class=hll>        <span class=k>return</span> <span class=n>x</span>
</span><a id=__codelineno-4-99 name=__codelineno-4-99></a><span class=hll>
</span><a id=__codelineno-4-100 name=__codelineno-4-100></a><span class=hll>    <span class=k>def</span> <span class=nf>postprocess</span><span class=p>(</span><span class=n>x</span><span class=p>:</span> <span class=n>Image</span><span class=p>):</span>
</span><a id=__codelineno-4-101 name=__codelineno-4-101></a><span class=hll>        <span class=k>return</span> <span class=p>{</span>
</span><a id=__codelineno-4-102 name=__codelineno-4-102></a><span class=hll>            <span class=s2>&quot;prediction&quot;</span><span class=p>:</span> <span class=n>labels</span><span class=p>[</span><span class=n>tf</span><span class=o>.</span><span class=n>argmax</span><span class=p>(</span><span class=n>x</span><span class=p>,</span> <span class=n>axis</span><span class=o>=-</span><span class=mi>1</span><span class=p>)</span><span class=o>.</span><span class=n>numpy</span><span class=p>()[</span><span class=mi>0</span><span class=p>]],</span>
</span><a id=__codelineno-4-103 name=__codelineno-4-103></a><span class=hll>            <span class=s2>&quot;probabilities&quot;</span><span class=p>:</span> <span class=p>{</span>
</span><a id=__codelineno-4-104 name=__codelineno-4-104></a><span class=hll>                <span class=n>labels</span><span class=p>[</span><span class=n>i</span><span class=p>]:</span> <span class=n>prob</span>
</span><a id=__codelineno-4-105 name=__codelineno-4-105></a><span class=hll>                <span class=k>for</span> <span class=n>i</span><span class=p>,</span> <span class=n>prob</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=n>tf</span><span class=o>.</span><span class=n>nn</span><span class=o>.</span><span class=n>softmax</span><span class=p>(</span><span class=n>x</span><span class=p>)</span><span class=o>.</span><span class=n>numpy</span><span class=p>()[</span><span class=mi>0</span><span class=p>]</span><span class=o>.</span><span class=n>tolist</span><span class=p>())</span>
</span><a id=__codelineno-4-106 name=__codelineno-4-106></a><span class=hll>            <span class=p>},</span>
</span><a id=__codelineno-4-107 name=__codelineno-4-107></a><span class=hll>        <span class=p>}</span>
</span><a id=__codelineno-4-108 name=__codelineno-4-108></a><span class=hll>
</span><a id=__codelineno-4-109 name=__codelineno-4-109></a><span class=hll>    <span class=c1># Save the model using BentoML to its model store</span>
</span><a id=__codelineno-4-110 name=__codelineno-4-110></a><span class=hll>    <span class=c1># https://docs.bentoml.com/en/latest/reference/frameworks/keras.html#bentoml.keras.save_model</span>
</span><a id=__codelineno-4-111 name=__codelineno-4-111></a><span class=hll>    <span class=n>bentoml</span><span class=o>.</span><span class=n>keras</span><span class=o>.</span><span class=n>save_model</span><span class=p>(</span>
</span><a id=__codelineno-4-112 name=__codelineno-4-112></a><span class=hll>        <span class=s2>&quot;celestial_bodies_classifier_model&quot;</span><span class=p>,</span>
</span><a id=__codelineno-4-113 name=__codelineno-4-113></a><span class=hll>        <span class=n>model</span><span class=p>,</span>
</span><a id=__codelineno-4-114 name=__codelineno-4-114></a><span class=hll>        <span class=n>include_optimizer</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span>
</span><a id=__codelineno-4-115 name=__codelineno-4-115></a><span class=hll>        <span class=n>custom_objects</span><span class=o>=</span><span class=p>{</span>
</span><a id=__codelineno-4-116 name=__codelineno-4-116></a><span class=hll>            <span class=s2>&quot;preprocess&quot;</span><span class=p>:</span> <span class=n>preprocess</span><span class=p>,</span>
</span><a id=__codelineno-4-117 name=__codelineno-4-117></a><span class=hll>            <span class=s2>&quot;postprocess&quot;</span><span class=p>:</span> <span class=n>postprocess</span><span class=p>,</span>
</span><a id=__codelineno-4-118 name=__codelineno-4-118></a><span class=hll>        <span class=p>}</span>
</span><a id=__codelineno-4-119 name=__codelineno-4-119></a><span class=hll>    <span class=p>)</span>
</span><a id=__codelineno-4-120 name=__codelineno-4-120></a><span class=hll>
</span><a id=__codelineno-4-121 name=__codelineno-4-121></a><span class=hll>    <span class=c1># Export the model from the model store to the local model folder</span>
</span><a id=__codelineno-4-122 name=__codelineno-4-122></a><span class=hll>    <span class=n>bentoml</span><span class=o>.</span><span class=n>models</span><span class=o>.</span><span class=n>export_model</span><span class=p>(</span>
</span><a id=__codelineno-4-123 name=__codelineno-4-123></a><span class=hll>        <span class=s2>&quot;celestial_bodies_classifier_model:latest&quot;</span><span class=p>,</span>
</span><a id=__codelineno-4-124 name=__codelineno-4-124></a><span class=hll>        <span class=sa>f</span><span class=s2>&quot;</span><span class=si>{</span><span class=n>model_folder</span><span class=si>}</span><span class=s2>/celestial_bodies_classifier_model.bentomodel&quot;</span><span class=p>,</span>
</span><a id=__codelineno-4-125 name=__codelineno-4-125></a><span class=hll>    <span class=p>)</span>
</span><a id=__codelineno-4-126 name=__codelineno-4-126></a>
<a id=__codelineno-4-127 name=__codelineno-4-127></a>    <span class=c1># Save the model history</span>
<a id=__codelineno-4-128 name=__codelineno-4-128></a>    <span class=n>np</span><span class=o>.</span><span class=n>save</span><span class=p>(</span><span class=n>model_folder</span> <span class=o>/</span> <span class=s2>&quot;history.npy&quot;</span><span class=p>,</span> <span class=n>model</span><span class=o>.</span><span class=n>history</span><span class=o>.</span><span class=n>history</span><span class=p>)</span>
<a id=__codelineno-4-129 name=__codelineno-4-129></a>
<a id=__codelineno-4-130 name=__codelineno-4-130></a>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;</span><span class=se>\n</span><span class=s2>Model saved at </span><span class=si>{</span><span class=n>model_folder</span><span class=o>.</span><span class=n>absolute</span><span class=p>()</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<a id=__codelineno-4-131 name=__codelineno-4-131></a>
<a id=__codelineno-4-132 name=__codelineno-4-132></a>
<a id=__codelineno-4-133 name=__codelineno-4-133></a><span class=k>if</span> <span class=vm>__name__</span> <span class=o>==</span> <span class=s2>&quot;__main__&quot;</span><span class=p>:</span>
<a id=__codelineno-4-134 name=__codelineno-4-134></a>    <span class=n>main</span><span class=p>()</span>
</code></pre></div></td></tr></table></div> <p>BentoML can save the model with custom objects.</p> <p>These custom objects can be used to save the model with arbitrary data that can be used afterword when loading back the model. In this case, the following objects are saved with the model:</p> <ul> <li><code>preprocess</code> is used to preprocess the input data before feeding it to the model.</li> <li><code>postprocess</code> is used to postprocess the output of the model.</li> </ul> <p>These functions will be used later to transform the input and output data when using the model through a HTTP REST API.</p> <p>Check the differences with Git to better understand the changes:</p> <div class=highlight><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>Execute the following command(s) in a terminal</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-5-1>1</a></span>
<span class=normal><a href=#__codelineno-5-2>2</a></span></pre></div></td><td class=code><div><pre><span></span><code><a id=__codelineno-5-1 name=__codelineno-5-1></a><span class=c1># Show the differences with Git</span>
<a id=__codelineno-5-2 name=__codelineno-5-2></a>git<span class=w> </span>diff<span class=w> </span>src/train.py
</code></pre></div></td></tr></table></div> <p>The output should be similar to this:</p> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-6-1> 1</a></span>
<span class=normal><a href=#__codelineno-6-2> 2</a></span>
<span class=normal><a href=#__codelineno-6-3> 3</a></span>
<span class=normal><a href=#__codelineno-6-4> 4</a></span>
<span class=normal><a href=#__codelineno-6-5> 5</a></span>
<span class=normal><a href=#__codelineno-6-6> 6</a></span>
<span class=normal><a href=#__codelineno-6-7> 7</a></span>
<span class=normal><a href=#__codelineno-6-8> 8</a></span>
<span class=normal><a href=#__codelineno-6-9> 9</a></span>
<span class=normal><a href=#__codelineno-6-10>10</a></span>
<span class=normal><a href=#__codelineno-6-11>11</a></span>
<span class=normal><a href=#__codelineno-6-12>12</a></span>
<span class=normal><a href=#__codelineno-6-13>13</a></span>
<span class=normal><a href=#__codelineno-6-14>14</a></span>
<span class=normal><a href=#__codelineno-6-15>15</a></span>
<span class=normal><a href=#__codelineno-6-16>16</a></span>
<span class=normal><a href=#__codelineno-6-17>17</a></span>
<span class=normal><a href=#__codelineno-6-18>18</a></span>
<span class=normal><a href=#__codelineno-6-19>19</a></span>
<span class=normal><a href=#__codelineno-6-20>20</a></span>
<span class=normal><a href=#__codelineno-6-21>21</a></span>
<span class=normal><a href=#__codelineno-6-22>22</a></span>
<span class=normal><a href=#__codelineno-6-23>23</a></span>
<span class=normal><a href=#__codelineno-6-24>24</a></span>
<span class=normal><a href=#__codelineno-6-25>25</a></span>
<span class=normal><a href=#__codelineno-6-26>26</a></span>
<span class=normal><a href=#__codelineno-6-27>27</a></span>
<span class=normal><a href=#__codelineno-6-28>28</a></span>
<span class=normal><a href=#__codelineno-6-29>29</a></span>
<span class=normal><a href=#__codelineno-6-30>30</a></span>
<span class=normal><a href=#__codelineno-6-31>31</a></span>
<span class=normal><a href=#__codelineno-6-32>32</a></span>
<span class=normal><a href=#__codelineno-6-33>33</a></span>
<span class=normal><a href=#__codelineno-6-34>34</a></span>
<span class=normal><a href=#__codelineno-6-35>35</a></span>
<span class=normal><a href=#__codelineno-6-36>36</a></span>
<span class=normal><a href=#__codelineno-6-37>37</a></span>
<span class=normal><a href=#__codelineno-6-38>38</a></span>
<span class=normal><a href=#__codelineno-6-39>39</a></span>
<span class=normal><a href=#__codelineno-6-40>40</a></span>
<span class=normal><a href=#__codelineno-6-41>41</a></span>
<span class=normal><a href=#__codelineno-6-42>42</a></span>
<span class=normal><a href=#__codelineno-6-43>43</a></span>
<span class=normal><a href=#__codelineno-6-44>44</a></span>
<span class=normal><a href=#__codelineno-6-45>45</a></span>
<span class=normal><a href=#__codelineno-6-46>46</a></span>
<span class=normal><a href=#__codelineno-6-47>47</a></span>
<span class=normal><a href=#__codelineno-6-48>48</a></span>
<span class=normal><a href=#__codelineno-6-49>49</a></span>
<span class=normal><a href=#__codelineno-6-50>50</a></span>
<span class=normal><a href=#__codelineno-6-51>51</a></span>
<span class=normal><a href=#__codelineno-6-52>52</a></span>
<span class=normal><a href=#__codelineno-6-53>53</a></span>
<span class=normal><a href=#__codelineno-6-54>54</a></span>
<span class=normal><a href=#__codelineno-6-55>55</a></span>
<span class=normal><a href=#__codelineno-6-56>56</a></span>
<span class=normal><a href=#__codelineno-6-57>57</a></span>
<span class=normal><a href=#__codelineno-6-58>58</a></span>
<span class=normal><a href=#__codelineno-6-59>59</a></span>
<span class=normal><a href=#__codelineno-6-60>60</a></span>
<span class=normal><a href=#__codelineno-6-61>61</a></span>
<span class=normal><a href=#__codelineno-6-62>62</a></span>
<span class=normal><a href=#__codelineno-6-63>63</a></span>
<span class=normal><a href=#__codelineno-6-64>64</a></span>
<span class=normal><a href=#__codelineno-6-65>65</a></span>
<span class=normal><a href=#__codelineno-6-66>66</a></span>
<span class=normal><a href=#__codelineno-6-67>67</a></span>
<span class=normal><a href=#__codelineno-6-68>68</a></span>
<span class=normal><a href=#__codelineno-6-69>69</a></span>
<span class=normal><a href=#__codelineno-6-70>70</a></span>
<span class=normal><a href=#__codelineno-6-71>71</a></span>
<span class=normal><a href=#__codelineno-6-72>72</a></span>
<span class=normal><a href=#__codelineno-6-73>73</a></span>
<span class=normal><a href=#__codelineno-6-74>74</a></span>
<span class=normal><a href=#__codelineno-6-75>75</a></span></pre></div></td><td class=code><div><pre><span></span><code><a id=__codelineno-6-1 name=__codelineno-6-1></a><span class=gh>diff --git a/src/train.py b/src/train.py</span>
<a id=__codelineno-6-2 name=__codelineno-6-2></a><span class=gh>index 5c69e2f..b845eb3 100644</span>
<a id=__codelineno-6-3 name=__codelineno-6-3></a><span class=gd>--- a/src/train.py</span>
<a id=__codelineno-6-4 name=__codelineno-6-4></a><span class=gi>+++ b/src/train.py</span>
<a id=__codelineno-6-5 name=__codelineno-6-5></a><span class=gu>@@ -1,3 +1,4 @@</span>
<a id=__codelineno-6-6 name=__codelineno-6-6></a><span class=gi>+import json</span>
<a id=__codelineno-6-7 name=__codelineno-6-7></a><span class=w> </span>import sys
<a id=__codelineno-6-8 name=__codelineno-6-8></a><span class=w> </span>from pathlib import Path
<a id=__codelineno-6-9 name=__codelineno-6-9></a><span class=w> </span>from typing import Tuple
<a id=__codelineno-6-10 name=__codelineno-6-10></a><span class=gu>@@ -5,6 +6,8 @@ from typing import Tuple</span>
<a id=__codelineno-6-11 name=__codelineno-6-11></a><span class=w> </span>import numpy as np
<a id=__codelineno-6-12 name=__codelineno-6-12></a><span class=w> </span>import tensorflow as tf
<a id=__codelineno-6-13 name=__codelineno-6-13></a><span class=w> </span>import yaml
<a id=__codelineno-6-14 name=__codelineno-6-14></a><span class=gi>+import bentoml</span>
<a id=__codelineno-6-15 name=__codelineno-6-15></a><span class=gi>+from PIL.Image import Image</span>
<a id=__codelineno-6-16 name=__codelineno-6-16></a>
<a id=__codelineno-6-17 name=__codelineno-6-17></a><span class=w> </span>from utils.seed import set_seed
<a id=__codelineno-6-18 name=__codelineno-6-18></a>
<a id=__codelineno-6-19 name=__codelineno-6-19></a><span class=gu>@@ -61,6 +64,10 @@ def main() -&gt; None:</span>
<a id=__codelineno-6-20 name=__codelineno-6-20></a><span class=w> </span>    ds_train = tf.data.Dataset.load(str(prepared_dataset_folder / &quot;train&quot;))
<a id=__codelineno-6-21 name=__codelineno-6-21></a><span class=w> </span>    ds_test = tf.data.Dataset.load(str(prepared_dataset_folder / &quot;test&quot;))
<a id=__codelineno-6-22 name=__codelineno-6-22></a>
<a id=__codelineno-6-23 name=__codelineno-6-23></a><span class=gi>+    labels = None</span>
<a id=__codelineno-6-24 name=__codelineno-6-24></a><span class=gi>+    with open(prepared_dataset_folder / &quot;labels.json&quot;) as f:</span>
<a id=__codelineno-6-25 name=__codelineno-6-25></a><span class=gi>+        labels = json.load(f)</span>
<a id=__codelineno-6-26 name=__codelineno-6-26></a><span class=gi>+</span>
<a id=__codelineno-6-27 name=__codelineno-6-27></a><span class=w> </span>    # Define the model
<a id=__codelineno-6-28 name=__codelineno-6-28></a><span class=w> </span>    model = get_model(image_shape, conv_size, dense_size, output_classes)
<a id=__codelineno-6-29 name=__codelineno-6-29></a><span class=w> </span>    model.compile(
<a id=__codelineno-6-30 name=__codelineno-6-30></a><span class=gu>@@ -79,8 +86,44 @@ def main() -&gt; None:</span>
<a id=__codelineno-6-31 name=__codelineno-6-31></a>
<a id=__codelineno-6-32 name=__codelineno-6-32></a><span class=w> </span>    # Save the model
<a id=__codelineno-6-33 name=__codelineno-6-33></a><span class=w> </span>    model_folder.mkdir(parents=True, exist_ok=True)
<a id=__codelineno-6-34 name=__codelineno-6-34></a><span class=gd>-    model_path = model_folder / &quot;model.keras&quot;</span>
<a id=__codelineno-6-35 name=__codelineno-6-35></a><span class=gd>-    model.save(model_path)</span>
<a id=__codelineno-6-36 name=__codelineno-6-36></a><span class=gi>+</span>
<a id=__codelineno-6-37 name=__codelineno-6-37></a><span class=gi>+    def preprocess(x: Image):</span>
<a id=__codelineno-6-38 name=__codelineno-6-38></a><span class=gi>+        # convert PIL image to tensor</span>
<a id=__codelineno-6-39 name=__codelineno-6-39></a><span class=gi>+        x = x.convert(&#39;L&#39; if grayscale else &#39;RGB&#39;)</span>
<a id=__codelineno-6-40 name=__codelineno-6-40></a><span class=gi>+        x = x.resize(image_size)</span>
<a id=__codelineno-6-41 name=__codelineno-6-41></a><span class=gi>+        x = np.array(x)</span>
<a id=__codelineno-6-42 name=__codelineno-6-42></a><span class=gi>+        x = x / 255.0</span>
<a id=__codelineno-6-43 name=__codelineno-6-43></a><span class=gi>+        # add batch dimension</span>
<a id=__codelineno-6-44 name=__codelineno-6-44></a><span class=gi>+        x = np.expand_dims(x, axis=0)</span>
<a id=__codelineno-6-45 name=__codelineno-6-45></a><span class=gi>+        return x</span>
<a id=__codelineno-6-46 name=__codelineno-6-46></a><span class=gi>+</span>
<a id=__codelineno-6-47 name=__codelineno-6-47></a><span class=gi>+    def postprocess(x: Image):</span>
<a id=__codelineno-6-48 name=__codelineno-6-48></a><span class=gi>+        return {</span>
<a id=__codelineno-6-49 name=__codelineno-6-49></a><span class=gi>+            &quot;prediction&quot;: labels[tf.argmax(x, axis=-1).numpy()[0]],</span>
<a id=__codelineno-6-50 name=__codelineno-6-50></a><span class=gi>+            &quot;probabilities&quot;: {</span>
<a id=__codelineno-6-51 name=__codelineno-6-51></a><span class=gi>+                labels[i]: prob</span>
<a id=__codelineno-6-52 name=__codelineno-6-52></a><span class=gi>+                for i, prob in enumerate(tf.nn.softmax(x).numpy()[0].tolist())</span>
<a id=__codelineno-6-53 name=__codelineno-6-53></a><span class=gi>+            },</span>
<a id=__codelineno-6-54 name=__codelineno-6-54></a><span class=gi>+        }</span>
<a id=__codelineno-6-55 name=__codelineno-6-55></a><span class=gi>+</span>
<a id=__codelineno-6-56 name=__codelineno-6-56></a><span class=gi>+    # Save the model using BentoML to its model store</span>
<a id=__codelineno-6-57 name=__codelineno-6-57></a><span class=gi>+    # https://docs.bentoml.com/en/latest/reference/frameworks/keras.html#bentoml.keras.save_model</span>
<a id=__codelineno-6-58 name=__codelineno-6-58></a><span class=gi>+    bentoml.keras.save_model(</span>
<a id=__codelineno-6-59 name=__codelineno-6-59></a><span class=gi>+        &quot;celestial_bodies_classifier_model&quot;,</span>
<a id=__codelineno-6-60 name=__codelineno-6-60></a><span class=gi>+        model,</span>
<a id=__codelineno-6-61 name=__codelineno-6-61></a><span class=gi>+        include_optimizer=True,</span>
<a id=__codelineno-6-62 name=__codelineno-6-62></a><span class=gi>+        custom_objects={</span>
<a id=__codelineno-6-63 name=__codelineno-6-63></a><span class=gi>+            &quot;preprocess&quot;: preprocess,</span>
<a id=__codelineno-6-64 name=__codelineno-6-64></a><span class=gi>+            &quot;postprocess&quot;: postprocess,</span>
<a id=__codelineno-6-65 name=__codelineno-6-65></a><span class=gi>+        }</span>
<a id=__codelineno-6-66 name=__codelineno-6-66></a><span class=gi>+    )</span>
<a id=__codelineno-6-67 name=__codelineno-6-67></a><span class=gi>+</span>
<a id=__codelineno-6-68 name=__codelineno-6-68></a><span class=gi>+    # Export the model from the model store to the local model folder</span>
<a id=__codelineno-6-69 name=__codelineno-6-69></a><span class=gi>+    bentoml.models.export_model(</span>
<a id=__codelineno-6-70 name=__codelineno-6-70></a><span class=gi>+        &quot;celestial_bodies_classifier_model:latest&quot;,</span>
<a id=__codelineno-6-71 name=__codelineno-6-71></a><span class=gi>+        f&quot;{model_folder}/celestial_bodies_classifier_model.bentomodel&quot;,</span>
<a id=__codelineno-6-72 name=__codelineno-6-72></a><span class=gi>+    )</span>
<a id=__codelineno-6-73 name=__codelineno-6-73></a><span class=gi>+</span>
<a id=__codelineno-6-74 name=__codelineno-6-74></a><span class=w> </span>    # Save the model history
<a id=__codelineno-6-75 name=__codelineno-6-75></a><span class=w> </span>    np.save(model_folder / &quot;history.npy&quot;, model.history.history)
</code></pre></div></td></tr></table></div> <h4 id=update-srcevaluatepy>Update <code>src/evaluate.py</code><a class=headerlink href=#update-srcevaluatepy title="Permanent link">&para;</a></h4> <p>Update the <code>src/evaluate.py</code> file to load the model from BentoML:</p> <div class=highlight><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>src/evaluate.py</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-7-1>  1</a></span>
<span class=normal><a href=#__codelineno-7-2>  2</a></span>
<span class=normal><a href=#__codelineno-7-3>  3</a></span>
<span class=normal><a href=#__codelineno-7-4>  4</a></span>
<span class=normal><a href=#__codelineno-7-5>  5</a></span>
<span class=normal><a href=#__codelineno-7-6>  6</a></span>
<span class=normal><a href=#__codelineno-7-7>  7</a></span>
<span class=normal><a href=#__codelineno-7-8>  8</a></span>
<span class=normal><a href=#__codelineno-7-9>  9</a></span>
<span class=normal><a href=#__codelineno-7-10> 10</a></span>
<span class=normal><a href=#__codelineno-7-11> 11</a></span>
<span class=normal><a href=#__codelineno-7-12> 12</a></span>
<span class=normal><a href=#__codelineno-7-13> 13</a></span>
<span class=normal><a href=#__codelineno-7-14> 14</a></span>
<span class=normal><a href=#__codelineno-7-15> 15</a></span>
<span class=normal><a href=#__codelineno-7-16> 16</a></span>
<span class=normal><a href=#__codelineno-7-17> 17</a></span>
<span class=normal><a href=#__codelineno-7-18> 18</a></span>
<span class=normal><a href=#__codelineno-7-19> 19</a></span>
<span class=normal><a href=#__codelineno-7-20> 20</a></span>
<span class=normal><a href=#__codelineno-7-21> 21</a></span>
<span class=normal><a href=#__codelineno-7-22> 22</a></span>
<span class=normal><a href=#__codelineno-7-23> 23</a></span>
<span class=normal><a href=#__codelineno-7-24> 24</a></span>
<span class=normal><a href=#__codelineno-7-25> 25</a></span>
<span class=normal><a href=#__codelineno-7-26> 26</a></span>
<span class=normal><a href=#__codelineno-7-27> 27</a></span>
<span class=normal><a href=#__codelineno-7-28> 28</a></span>
<span class=normal><a href=#__codelineno-7-29> 29</a></span>
<span class=normal><a href=#__codelineno-7-30> 30</a></span>
<span class=normal><a href=#__codelineno-7-31> 31</a></span>
<span class=normal><a href=#__codelineno-7-32> 32</a></span>
<span class=normal><a href=#__codelineno-7-33> 33</a></span>
<span class=normal><a href=#__codelineno-7-34> 34</a></span>
<span class=normal><a href=#__codelineno-7-35> 35</a></span>
<span class=normal><a href=#__codelineno-7-36> 36</a></span>
<span class=normal><a href=#__codelineno-7-37> 37</a></span>
<span class=normal><a href=#__codelineno-7-38> 38</a></span>
<span class=normal><a href=#__codelineno-7-39> 39</a></span>
<span class=normal><a href=#__codelineno-7-40> 40</a></span>
<span class=normal><a href=#__codelineno-7-41> 41</a></span>
<span class=normal><a href=#__codelineno-7-42> 42</a></span>
<span class=normal><a href=#__codelineno-7-43> 43</a></span>
<span class=normal><a href=#__codelineno-7-44> 44</a></span>
<span class=normal><a href=#__codelineno-7-45> 45</a></span>
<span class=normal><a href=#__codelineno-7-46> 46</a></span>
<span class=normal><a href=#__codelineno-7-47> 47</a></span>
<span class=normal><a href=#__codelineno-7-48> 48</a></span>
<span class=normal><a href=#__codelineno-7-49> 49</a></span>
<span class=normal><a href=#__codelineno-7-50> 50</a></span>
<span class=normal><a href=#__codelineno-7-51> 51</a></span>
<span class=normal><a href=#__codelineno-7-52> 52</a></span>
<span class=normal><a href=#__codelineno-7-53> 53</a></span>
<span class=normal><a href=#__codelineno-7-54> 54</a></span>
<span class=normal><a href=#__codelineno-7-55> 55</a></span>
<span class=normal><a href=#__codelineno-7-56> 56</a></span>
<span class=normal><a href=#__codelineno-7-57> 57</a></span>
<span class=normal><a href=#__codelineno-7-58> 58</a></span>
<span class=normal><a href=#__codelineno-7-59> 59</a></span>
<span class=normal><a href=#__codelineno-7-60> 60</a></span>
<span class=normal><a href=#__codelineno-7-61> 61</a></span>
<span class=normal><a href=#__codelineno-7-62> 62</a></span>
<span class=normal><a href=#__codelineno-7-63> 63</a></span>
<span class=normal><a href=#__codelineno-7-64> 64</a></span>
<span class=normal><a href=#__codelineno-7-65> 65</a></span>
<span class=normal><a href=#__codelineno-7-66> 66</a></span>
<span class=normal><a href=#__codelineno-7-67> 67</a></span>
<span class=normal><a href=#__codelineno-7-68> 68</a></span>
<span class=normal><a href=#__codelineno-7-69> 69</a></span>
<span class=normal><a href=#__codelineno-7-70> 70</a></span>
<span class=normal><a href=#__codelineno-7-71> 71</a></span>
<span class=normal><a href=#__codelineno-7-72> 72</a></span>
<span class=normal><a href=#__codelineno-7-73> 73</a></span>
<span class=normal><a href=#__codelineno-7-74> 74</a></span>
<span class=normal><a href=#__codelineno-7-75> 75</a></span>
<span class=normal><a href=#__codelineno-7-76> 76</a></span>
<span class=normal><a href=#__codelineno-7-77> 77</a></span>
<span class=normal><a href=#__codelineno-7-78> 78</a></span>
<span class=normal><a href=#__codelineno-7-79> 79</a></span>
<span class=normal><a href=#__codelineno-7-80> 80</a></span>
<span class=normal><a href=#__codelineno-7-81> 81</a></span>
<span class=normal><a href=#__codelineno-7-82> 82</a></span>
<span class=normal><a href=#__codelineno-7-83> 83</a></span>
<span class=normal><a href=#__codelineno-7-84> 84</a></span>
<span class=normal><a href=#__codelineno-7-85> 85</a></span>
<span class=normal><a href=#__codelineno-7-86> 86</a></span>
<span class=normal><a href=#__codelineno-7-87> 87</a></span>
<span class=normal><a href=#__codelineno-7-88> 88</a></span>
<span class=normal><a href=#__codelineno-7-89> 89</a></span>
<span class=normal><a href=#__codelineno-7-90> 90</a></span>
<span class=normal><a href=#__codelineno-7-91> 91</a></span>
<span class=normal><a href=#__codelineno-7-92> 92</a></span>
<span class=normal><a href=#__codelineno-7-93> 93</a></span>
<span class=normal><a href=#__codelineno-7-94> 94</a></span>
<span class=normal><a href=#__codelineno-7-95> 95</a></span>
<span class=normal><a href=#__codelineno-7-96> 96</a></span>
<span class=normal><a href=#__codelineno-7-97> 97</a></span>
<span class=normal><a href=#__codelineno-7-98> 98</a></span>
<span class=normal><a href=#__codelineno-7-99> 99</a></span>
<span class=normal><a href=#__codelineno-7-100>100</a></span>
<span class=normal><a href=#__codelineno-7-101>101</a></span>
<span class=normal><a href=#__codelineno-7-102>102</a></span>
<span class=normal><a href=#__codelineno-7-103>103</a></span>
<span class=normal><a href=#__codelineno-7-104>104</a></span>
<span class=normal><a href=#__codelineno-7-105>105</a></span>
<span class=normal><a href=#__codelineno-7-106>106</a></span>
<span class=normal><a href=#__codelineno-7-107>107</a></span>
<span class=normal><a href=#__codelineno-7-108>108</a></span>
<span class=normal><a href=#__codelineno-7-109>109</a></span>
<span class=normal><a href=#__codelineno-7-110>110</a></span>
<span class=normal><a href=#__codelineno-7-111>111</a></span>
<span class=normal><a href=#__codelineno-7-112>112</a></span>
<span class=normal><a href=#__codelineno-7-113>113</a></span>
<span class=normal><a href=#__codelineno-7-114>114</a></span>
<span class=normal><a href=#__codelineno-7-115>115</a></span>
<span class=normal><a href=#__codelineno-7-116>116</a></span>
<span class=normal><a href=#__codelineno-7-117>117</a></span>
<span class=normal><a href=#__codelineno-7-118>118</a></span>
<span class=normal><a href=#__codelineno-7-119>119</a></span>
<span class=normal><a href=#__codelineno-7-120>120</a></span>
<span class=normal><a href=#__codelineno-7-121>121</a></span>
<span class=normal><a href=#__codelineno-7-122>122</a></span>
<span class=normal><a href=#__codelineno-7-123>123</a></span>
<span class=normal><a href=#__codelineno-7-124>124</a></span>
<span class=normal><a href=#__codelineno-7-125>125</a></span>
<span class=normal><a href=#__codelineno-7-126>126</a></span>
<span class=normal><a href=#__codelineno-7-127>127</a></span>
<span class=normal><a href=#__codelineno-7-128>128</a></span>
<span class=normal><a href=#__codelineno-7-129>129</a></span>
<span class=normal><a href=#__codelineno-7-130>130</a></span>
<span class=normal><a href=#__codelineno-7-131>131</a></span>
<span class=normal><a href=#__codelineno-7-132>132</a></span>
<span class=normal><a href=#__codelineno-7-133>133</a></span>
<span class=normal><a href=#__codelineno-7-134>134</a></span>
<span class=normal><a href=#__codelineno-7-135>135</a></span>
<span class=normal><a href=#__codelineno-7-136>136</a></span>
<span class=normal><a href=#__codelineno-7-137>137</a></span>
<span class=normal><a href=#__codelineno-7-138>138</a></span>
<span class=normal><a href=#__codelineno-7-139>139</a></span>
<span class=normal><a href=#__codelineno-7-140>140</a></span>
<span class=normal><a href=#__codelineno-7-141>141</a></span>
<span class=normal><a href=#__codelineno-7-142>142</a></span>
<span class=normal><a href=#__codelineno-7-143>143</a></span>
<span class=normal><a href=#__codelineno-7-144>144</a></span>
<span class=normal><a href=#__codelineno-7-145>145</a></span>
<span class=normal><a href=#__codelineno-7-146>146</a></span>
<span class=normal><a href=#__codelineno-7-147>147</a></span>
<span class=normal><a href=#__codelineno-7-148>148</a></span>
<span class=normal><a href=#__codelineno-7-149>149</a></span>
<span class=normal><a href=#__codelineno-7-150>150</a></span>
<span class=normal><a href=#__codelineno-7-151>151</a></span>
<span class=normal><a href=#__codelineno-7-152>152</a></span>
<span class=normal><a href=#__codelineno-7-153>153</a></span>
<span class=normal><a href=#__codelineno-7-154>154</a></span>
<span class=normal><a href=#__codelineno-7-155>155</a></span>
<span class=normal><a href=#__codelineno-7-156>156</a></span>
<span class=normal><a href=#__codelineno-7-157>157</a></span>
<span class=normal><a href=#__codelineno-7-158>158</a></span>
<span class=normal><a href=#__codelineno-7-159>159</a></span>
<span class=normal><a href=#__codelineno-7-160>160</a></span>
<span class=normal><a href=#__codelineno-7-161>161</a></span>
<span class=normal><a href=#__codelineno-7-162>162</a></span>
<span class=normal><a href=#__codelineno-7-163>163</a></span>
<span class=normal><a href=#__codelineno-7-164>164</a></span>
<span class=normal><a href=#__codelineno-7-165>165</a></span>
<span class=normal><a href=#__codelineno-7-166>166</a></span>
<span class=normal><a href=#__codelineno-7-167>167</a></span></pre></div></td><td class=code><div><pre><span></span><code><a id=__codelineno-7-1 name=__codelineno-7-1></a><span class=kn>import</span> <span class=nn>json</span>
<a id=__codelineno-7-2 name=__codelineno-7-2></a><span class=kn>import</span> <span class=nn>sys</span>
<a id=__codelineno-7-3 name=__codelineno-7-3></a><span class=kn>from</span> <span class=nn>pathlib</span> <span class=kn>import</span> <span class=n>Path</span>
<a id=__codelineno-7-4 name=__codelineno-7-4></a><span class=kn>from</span> <span class=nn>typing</span> <span class=kn>import</span> <span class=n>List</span>
<a id=__codelineno-7-5 name=__codelineno-7-5></a>
<a id=__codelineno-7-6 name=__codelineno-7-6></a><span class=kn>import</span> <span class=nn>matplotlib.pyplot</span> <span class=k>as</span> <span class=nn>plt</span>
<a id=__codelineno-7-7 name=__codelineno-7-7></a><span class=kn>import</span> <span class=nn>numpy</span> <span class=k>as</span> <span class=nn>np</span>
<a id=__codelineno-7-8 name=__codelineno-7-8></a><span class=kn>import</span> <span class=nn>tensorflow</span> <span class=k>as</span> <span class=nn>tf</span>
<a id=__codelineno-7-9 name=__codelineno-7-9></a><span class=hll><span class=kn>import</span> <span class=nn>bentoml</span>
</span><a id=__codelineno-7-10 name=__codelineno-7-10></a>
<a id=__codelineno-7-11 name=__codelineno-7-11></a>
<a id=__codelineno-7-12 name=__codelineno-7-12></a><span class=k>def</span> <span class=nf>get_training_plot</span><span class=p>(</span><span class=n>model_history</span><span class=p>:</span> <span class=nb>dict</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>plt</span><span class=o>.</span><span class=n>Figure</span><span class=p>:</span>
<a id=__codelineno-7-13 name=__codelineno-7-13></a><span class=w>    </span><span class=sd>&quot;&quot;&quot;Plot the training and validation loss&quot;&quot;&quot;</span>
<a id=__codelineno-7-14 name=__codelineno-7-14></a>    <span class=n>epochs</span> <span class=o>=</span> <span class=nb>range</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=n>model_history</span><span class=p>[</span><span class=s2>&quot;loss&quot;</span><span class=p>])</span> <span class=o>+</span> <span class=mi>1</span><span class=p>)</span>
<a id=__codelineno-7-15 name=__codelineno-7-15></a>
<a id=__codelineno-7-16 name=__codelineno-7-16></a>    <span class=n>fig</span> <span class=o>=</span> <span class=n>plt</span><span class=o>.</span><span class=n>figure</span><span class=p>(</span><span class=n>figsize</span><span class=o>=</span><span class=p>(</span><span class=mi>10</span><span class=p>,</span> <span class=mi>4</span><span class=p>))</span>
<a id=__codelineno-7-17 name=__codelineno-7-17></a>    <span class=n>plt</span><span class=o>.</span><span class=n>plot</span><span class=p>(</span><span class=n>epochs</span><span class=p>,</span> <span class=n>model_history</span><span class=p>[</span><span class=s2>&quot;loss&quot;</span><span class=p>],</span> <span class=n>label</span><span class=o>=</span><span class=s2>&quot;Training loss&quot;</span><span class=p>)</span>
<a id=__codelineno-7-18 name=__codelineno-7-18></a>    <span class=n>plt</span><span class=o>.</span><span class=n>plot</span><span class=p>(</span><span class=n>epochs</span><span class=p>,</span> <span class=n>model_history</span><span class=p>[</span><span class=s2>&quot;val_loss&quot;</span><span class=p>],</span> <span class=n>label</span><span class=o>=</span><span class=s2>&quot;Validation loss&quot;</span><span class=p>)</span>
<a id=__codelineno-7-19 name=__codelineno-7-19></a>    <span class=n>plt</span><span class=o>.</span><span class=n>xticks</span><span class=p>(</span><span class=n>epochs</span><span class=p>)</span>
<a id=__codelineno-7-20 name=__codelineno-7-20></a>    <span class=n>plt</span><span class=o>.</span><span class=n>title</span><span class=p>(</span><span class=s2>&quot;Training and validation loss&quot;</span><span class=p>)</span>
<a id=__codelineno-7-21 name=__codelineno-7-21></a>    <span class=n>plt</span><span class=o>.</span><span class=n>xlabel</span><span class=p>(</span><span class=s2>&quot;Epochs&quot;</span><span class=p>)</span>
<a id=__codelineno-7-22 name=__codelineno-7-22></a>    <span class=n>plt</span><span class=o>.</span><span class=n>ylabel</span><span class=p>(</span><span class=s2>&quot;Loss&quot;</span><span class=p>)</span>
<a id=__codelineno-7-23 name=__codelineno-7-23></a>    <span class=n>plt</span><span class=o>.</span><span class=n>legend</span><span class=p>()</span>
<a id=__codelineno-7-24 name=__codelineno-7-24></a>    <span class=n>plt</span><span class=o>.</span><span class=n>grid</span><span class=p>(</span><span class=kc>True</span><span class=p>)</span>
<a id=__codelineno-7-25 name=__codelineno-7-25></a>
<a id=__codelineno-7-26 name=__codelineno-7-26></a>    <span class=k>return</span> <span class=n>fig</span>
<a id=__codelineno-7-27 name=__codelineno-7-27></a>
<a id=__codelineno-7-28 name=__codelineno-7-28></a>
<a id=__codelineno-7-29 name=__codelineno-7-29></a><span class=k>def</span> <span class=nf>get_pred_preview_plot</span><span class=p>(</span>
<a id=__codelineno-7-30 name=__codelineno-7-30></a>    <span class=n>model</span><span class=p>:</span> <span class=n>tf</span><span class=o>.</span><span class=n>keras</span><span class=o>.</span><span class=n>Model</span><span class=p>,</span> <span class=n>ds_test</span><span class=p>:</span> <span class=n>tf</span><span class=o>.</span><span class=n>data</span><span class=o>.</span><span class=n>Dataset</span><span class=p>,</span> <span class=n>labels</span><span class=p>:</span> <span class=n>List</span><span class=p>[</span><span class=nb>str</span><span class=p>]</span>
<a id=__codelineno-7-31 name=__codelineno-7-31></a><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>plt</span><span class=o>.</span><span class=n>Figure</span><span class=p>:</span>
<a id=__codelineno-7-32 name=__codelineno-7-32></a><span class=w>    </span><span class=sd>&quot;&quot;&quot;Plot a preview of the predictions&quot;&quot;&quot;</span>
<a id=__codelineno-7-33 name=__codelineno-7-33></a>    <span class=n>fig</span> <span class=o>=</span> <span class=n>plt</span><span class=o>.</span><span class=n>figure</span><span class=p>(</span><span class=n>figsize</span><span class=o>=</span><span class=p>(</span><span class=mi>10</span><span class=p>,</span> <span class=mi>5</span><span class=p>),</span> <span class=n>tight_layout</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
<a id=__codelineno-7-34 name=__codelineno-7-34></a>    <span class=k>for</span> <span class=n>images</span><span class=p>,</span> <span class=n>label_idxs</span> <span class=ow>in</span> <span class=n>ds_test</span><span class=o>.</span><span class=n>take</span><span class=p>(</span><span class=mi>1</span><span class=p>):</span>
<a id=__codelineno-7-35 name=__codelineno-7-35></a>        <span class=n>preds</span> <span class=o>=</span> <span class=n>model</span><span class=o>.</span><span class=n>predict</span><span class=p>(</span><span class=n>images</span><span class=p>)</span>
<a id=__codelineno-7-36 name=__codelineno-7-36></a>        <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>10</span><span class=p>):</span>
<a id=__codelineno-7-37 name=__codelineno-7-37></a>            <span class=n>plt</span><span class=o>.</span><span class=n>subplot</span><span class=p>(</span><span class=mi>2</span><span class=p>,</span> <span class=mi>5</span><span class=p>,</span> <span class=n>i</span> <span class=o>+</span> <span class=mi>1</span><span class=p>)</span>
<a id=__codelineno-7-38 name=__codelineno-7-38></a>            <span class=n>img</span> <span class=o>=</span> <span class=p>(</span><span class=n>images</span><span class=p>[</span><span class=n>i</span><span class=p>]</span><span class=o>.</span><span class=n>numpy</span><span class=p>()</span> <span class=o>*</span> <span class=mi>255</span><span class=p>)</span><span class=o>.</span><span class=n>astype</span><span class=p>(</span><span class=s2>&quot;uint8&quot;</span><span class=p>)</span>
<a id=__codelineno-7-39 name=__codelineno-7-39></a>            <span class=c1># Convert image to rgb if grayscale</span>
<a id=__codelineno-7-40 name=__codelineno-7-40></a>            <span class=k>if</span> <span class=n>img</span><span class=o>.</span><span class=n>shape</span><span class=p>[</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span> <span class=o>==</span> <span class=mi>1</span><span class=p>:</span>
<a id=__codelineno-7-41 name=__codelineno-7-41></a>                <span class=n>img</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>squeeze</span><span class=p>(</span><span class=n>img</span><span class=p>,</span> <span class=n>axis</span><span class=o>=-</span><span class=mi>1</span><span class=p>)</span>
<a id=__codelineno-7-42 name=__codelineno-7-42></a>                <span class=n>img</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>stack</span><span class=p>((</span><span class=n>img</span><span class=p>,)</span> <span class=o>*</span> <span class=mi>3</span><span class=p>,</span> <span class=n>axis</span><span class=o>=-</span><span class=mi>1</span><span class=p>)</span>
<a id=__codelineno-7-43 name=__codelineno-7-43></a>            <span class=n>true_label</span> <span class=o>=</span> <span class=n>labels</span><span class=p>[</span><span class=n>label_idxs</span><span class=p>[</span><span class=n>i</span><span class=p>]</span><span class=o>.</span><span class=n>numpy</span><span class=p>()]</span>
<a id=__codelineno-7-44 name=__codelineno-7-44></a>            <span class=n>pred_label</span> <span class=o>=</span> <span class=n>labels</span><span class=p>[</span><span class=n>np</span><span class=o>.</span><span class=n>argmax</span><span class=p>(</span><span class=n>preds</span><span class=p>[</span><span class=n>i</span><span class=p>])]</span>
<a id=__codelineno-7-45 name=__codelineno-7-45></a>            <span class=c1># Add red border if the prediction is wrong else add green border</span>
<a id=__codelineno-7-46 name=__codelineno-7-46></a>            <span class=n>img</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>pad</span><span class=p>(</span><span class=n>img</span><span class=p>,</span> <span class=n>pad_width</span><span class=o>=</span><span class=p>((</span><span class=mi>1</span><span class=p>,</span> <span class=mi>1</span><span class=p>),</span> <span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=mi>1</span><span class=p>),</span> <span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>)))</span>
<a id=__codelineno-7-47 name=__codelineno-7-47></a>            <span class=k>if</span> <span class=n>true_label</span> <span class=o>!=</span> <span class=n>pred_label</span><span class=p>:</span>
<a id=__codelineno-7-48 name=__codelineno-7-48></a>                <span class=n>img</span><span class=p>[</span><span class=mi>0</span><span class=p>,</span> <span class=p>:,</span> <span class=mi>0</span><span class=p>]</span> <span class=o>=</span> <span class=mi>255</span>  <span class=c1># Top border</span>
<a id=__codelineno-7-49 name=__codelineno-7-49></a>                <span class=n>img</span><span class=p>[</span><span class=o>-</span><span class=mi>1</span><span class=p>,</span> <span class=p>:,</span> <span class=mi>0</span><span class=p>]</span> <span class=o>=</span> <span class=mi>255</span>  <span class=c1># Bottom border</span>
<a id=__codelineno-7-50 name=__codelineno-7-50></a>                <span class=n>img</span><span class=p>[:,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>]</span> <span class=o>=</span> <span class=mi>255</span>  <span class=c1># Left border</span>
<a id=__codelineno-7-51 name=__codelineno-7-51></a>                <span class=n>img</span><span class=p>[:,</span> <span class=o>-</span><span class=mi>1</span><span class=p>,</span> <span class=mi>0</span><span class=p>]</span> <span class=o>=</span> <span class=mi>255</span>  <span class=c1># Right border</span>
<a id=__codelineno-7-52 name=__codelineno-7-52></a>            <span class=k>else</span><span class=p>:</span>
<a id=__codelineno-7-53 name=__codelineno-7-53></a>                <span class=n>img</span><span class=p>[</span><span class=mi>0</span><span class=p>,</span> <span class=p>:,</span> <span class=mi>1</span><span class=p>]</span> <span class=o>=</span> <span class=mi>255</span>
<a id=__codelineno-7-54 name=__codelineno-7-54></a>                <span class=n>img</span><span class=p>[</span><span class=o>-</span><span class=mi>1</span><span class=p>,</span> <span class=p>:,</span> <span class=mi>1</span><span class=p>]</span> <span class=o>=</span> <span class=mi>255</span>
<a id=__codelineno-7-55 name=__codelineno-7-55></a>                <span class=n>img</span><span class=p>[:,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>1</span><span class=p>]</span> <span class=o>=</span> <span class=mi>255</span>
<a id=__codelineno-7-56 name=__codelineno-7-56></a>                <span class=n>img</span><span class=p>[:,</span> <span class=o>-</span><span class=mi>1</span><span class=p>,</span> <span class=mi>1</span><span class=p>]</span> <span class=o>=</span> <span class=mi>255</span>
<a id=__codelineno-7-57 name=__codelineno-7-57></a>
<a id=__codelineno-7-58 name=__codelineno-7-58></a>            <span class=n>plt</span><span class=o>.</span><span class=n>imshow</span><span class=p>(</span><span class=n>img</span><span class=p>)</span>
<a id=__codelineno-7-59 name=__codelineno-7-59></a>            <span class=n>plt</span><span class=o>.</span><span class=n>title</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;True: </span><span class=si>{</span><span class=n>true_label</span><span class=si>}</span><span class=se>\n</span><span class=s2>&quot;</span> <span class=sa>f</span><span class=s2>&quot;Pred: </span><span class=si>{</span><span class=n>pred_label</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<a id=__codelineno-7-60 name=__codelineno-7-60></a>            <span class=n>plt</span><span class=o>.</span><span class=n>axis</span><span class=p>(</span><span class=s2>&quot;off&quot;</span><span class=p>)</span>
<a id=__codelineno-7-61 name=__codelineno-7-61></a>
<a id=__codelineno-7-62 name=__codelineno-7-62></a>    <span class=k>return</span> <span class=n>fig</span>
<a id=__codelineno-7-63 name=__codelineno-7-63></a>
<a id=__codelineno-7-64 name=__codelineno-7-64></a>
<a id=__codelineno-7-65 name=__codelineno-7-65></a><span class=k>def</span> <span class=nf>get_confusion_matrix_plot</span><span class=p>(</span>
<a id=__codelineno-7-66 name=__codelineno-7-66></a>    <span class=n>model</span><span class=p>:</span> <span class=n>tf</span><span class=o>.</span><span class=n>keras</span><span class=o>.</span><span class=n>Model</span><span class=p>,</span> <span class=n>ds_test</span><span class=p>:</span> <span class=n>tf</span><span class=o>.</span><span class=n>data</span><span class=o>.</span><span class=n>Dataset</span><span class=p>,</span> <span class=n>labels</span><span class=p>:</span> <span class=n>List</span><span class=p>[</span><span class=nb>str</span><span class=p>]</span>
<a id=__codelineno-7-67 name=__codelineno-7-67></a><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>plt</span><span class=o>.</span><span class=n>Figure</span><span class=p>:</span>
<a id=__codelineno-7-68 name=__codelineno-7-68></a><span class=w>    </span><span class=sd>&quot;&quot;&quot;Plot the confusion matrix&quot;&quot;&quot;</span>
<a id=__codelineno-7-69 name=__codelineno-7-69></a>    <span class=n>fig</span> <span class=o>=</span> <span class=n>plt</span><span class=o>.</span><span class=n>figure</span><span class=p>(</span><span class=n>figsize</span><span class=o>=</span><span class=p>(</span><span class=mi>6</span><span class=p>,</span> <span class=mi>6</span><span class=p>),</span> <span class=n>tight_layout</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
<a id=__codelineno-7-70 name=__codelineno-7-70></a>    <span class=n>preds</span> <span class=o>=</span> <span class=n>model</span><span class=o>.</span><span class=n>predict</span><span class=p>(</span><span class=n>ds_test</span><span class=p>)</span>
<a id=__codelineno-7-71 name=__codelineno-7-71></a>
<a id=__codelineno-7-72 name=__codelineno-7-72></a>    <span class=n>conf_matrix</span> <span class=o>=</span> <span class=n>tf</span><span class=o>.</span><span class=n>math</span><span class=o>.</span><span class=n>confusion_matrix</span><span class=p>(</span>
<a id=__codelineno-7-73 name=__codelineno-7-73></a>        <span class=n>labels</span><span class=o>=</span><span class=n>tf</span><span class=o>.</span><span class=n>concat</span><span class=p>([</span><span class=n>y</span> <span class=k>for</span> <span class=n>_</span><span class=p>,</span> <span class=n>y</span> <span class=ow>in</span> <span class=n>ds_test</span><span class=p>],</span> <span class=n>axis</span><span class=o>=</span><span class=mi>0</span><span class=p>),</span>
<a id=__codelineno-7-74 name=__codelineno-7-74></a>        <span class=n>predictions</span><span class=o>=</span><span class=n>tf</span><span class=o>.</span><span class=n>argmax</span><span class=p>(</span><span class=n>preds</span><span class=p>,</span> <span class=n>axis</span><span class=o>=</span><span class=mi>1</span><span class=p>),</span>
<a id=__codelineno-7-75 name=__codelineno-7-75></a>        <span class=n>num_classes</span><span class=o>=</span><span class=nb>len</span><span class=p>(</span><span class=n>labels</span><span class=p>),</span>
<a id=__codelineno-7-76 name=__codelineno-7-76></a>    <span class=p>)</span>
<a id=__codelineno-7-77 name=__codelineno-7-77></a>
<a id=__codelineno-7-78 name=__codelineno-7-78></a>    <span class=c1># Plot the confusion matrix</span>
<a id=__codelineno-7-79 name=__codelineno-7-79></a>    <span class=n>conf_matrix</span> <span class=o>=</span> <span class=n>conf_matrix</span> <span class=o>/</span> <span class=n>tf</span><span class=o>.</span><span class=n>reduce_sum</span><span class=p>(</span><span class=n>conf_matrix</span><span class=p>,</span> <span class=n>axis</span><span class=o>=</span><span class=mi>1</span><span class=p>)</span>
<a id=__codelineno-7-80 name=__codelineno-7-80></a>    <span class=n>plt</span><span class=o>.</span><span class=n>imshow</span><span class=p>(</span><span class=n>conf_matrix</span><span class=p>,</span> <span class=n>cmap</span><span class=o>=</span><span class=s2>&quot;Blues&quot;</span><span class=p>)</span>
<a id=__codelineno-7-81 name=__codelineno-7-81></a>
<a id=__codelineno-7-82 name=__codelineno-7-82></a>    <span class=c1># Plot cell values</span>
<a id=__codelineno-7-83 name=__codelineno-7-83></a>    <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>labels</span><span class=p>)):</span>
<a id=__codelineno-7-84 name=__codelineno-7-84></a>        <span class=k>for</span> <span class=n>j</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>labels</span><span class=p>)):</span>
<a id=__codelineno-7-85 name=__codelineno-7-85></a>            <span class=n>value</span> <span class=o>=</span> <span class=n>conf_matrix</span><span class=p>[</span><span class=n>i</span><span class=p>,</span> <span class=n>j</span><span class=p>]</span><span class=o>.</span><span class=n>numpy</span><span class=p>()</span>
<a id=__codelineno-7-86 name=__codelineno-7-86></a>            <span class=k>if</span> <span class=n>value</span> <span class=o>==</span> <span class=mi>0</span><span class=p>:</span>
<a id=__codelineno-7-87 name=__codelineno-7-87></a>                <span class=n>color</span> <span class=o>=</span> <span class=s2>&quot;lightgray&quot;</span>
<a id=__codelineno-7-88 name=__codelineno-7-88></a>            <span class=k>elif</span> <span class=n>value</span> <span class=o>&gt;</span> <span class=mf>0.5</span><span class=p>:</span>
<a id=__codelineno-7-89 name=__codelineno-7-89></a>                <span class=n>color</span> <span class=o>=</span> <span class=s2>&quot;white&quot;</span>
<a id=__codelineno-7-90 name=__codelineno-7-90></a>            <span class=k>else</span><span class=p>:</span>
<a id=__codelineno-7-91 name=__codelineno-7-91></a>                <span class=n>color</span> <span class=o>=</span> <span class=s2>&quot;black&quot;</span>
<a id=__codelineno-7-92 name=__codelineno-7-92></a>            <span class=n>plt</span><span class=o>.</span><span class=n>text</span><span class=p>(</span>
<a id=__codelineno-7-93 name=__codelineno-7-93></a>                <span class=n>j</span><span class=p>,</span>
<a id=__codelineno-7-94 name=__codelineno-7-94></a>                <span class=n>i</span><span class=p>,</span>
<a id=__codelineno-7-95 name=__codelineno-7-95></a>                <span class=sa>f</span><span class=s2>&quot;</span><span class=si>{</span><span class=n>value</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>,</span>
<a id=__codelineno-7-96 name=__codelineno-7-96></a>                <span class=n>ha</span><span class=o>=</span><span class=s2>&quot;center&quot;</span><span class=p>,</span>
<a id=__codelineno-7-97 name=__codelineno-7-97></a>                <span class=n>va</span><span class=o>=</span><span class=s2>&quot;center&quot;</span><span class=p>,</span>
<a id=__codelineno-7-98 name=__codelineno-7-98></a>                <span class=n>color</span><span class=o>=</span><span class=n>color</span><span class=p>,</span>
<a id=__codelineno-7-99 name=__codelineno-7-99></a>                <span class=n>fontsize</span><span class=o>=</span><span class=mi>8</span><span class=p>,</span>
<a id=__codelineno-7-100 name=__codelineno-7-100></a>            <span class=p>)</span>
<a id=__codelineno-7-101 name=__codelineno-7-101></a>
<a id=__codelineno-7-102 name=__codelineno-7-102></a>    <span class=n>plt</span><span class=o>.</span><span class=n>colorbar</span><span class=p>()</span>
<a id=__codelineno-7-103 name=__codelineno-7-103></a>    <span class=n>plt</span><span class=o>.</span><span class=n>xticks</span><span class=p>(</span><span class=nb>range</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>labels</span><span class=p>)),</span> <span class=n>labels</span><span class=p>,</span> <span class=n>rotation</span><span class=o>=</span><span class=mi>90</span><span class=p>)</span>
<a id=__codelineno-7-104 name=__codelineno-7-104></a>    <span class=n>plt</span><span class=o>.</span><span class=n>yticks</span><span class=p>(</span><span class=nb>range</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>labels</span><span class=p>)),</span> <span class=n>labels</span><span class=p>)</span>
<a id=__codelineno-7-105 name=__codelineno-7-105></a>    <span class=n>plt</span><span class=o>.</span><span class=n>xlabel</span><span class=p>(</span><span class=s2>&quot;Predicted label&quot;</span><span class=p>)</span>
<a id=__codelineno-7-106 name=__codelineno-7-106></a>    <span class=n>plt</span><span class=o>.</span><span class=n>ylabel</span><span class=p>(</span><span class=s2>&quot;True label&quot;</span><span class=p>)</span>
<a id=__codelineno-7-107 name=__codelineno-7-107></a>    <span class=n>plt</span><span class=o>.</span><span class=n>title</span><span class=p>(</span><span class=s2>&quot;Confusion matrix&quot;</span><span class=p>)</span>
<a id=__codelineno-7-108 name=__codelineno-7-108></a>
<a id=__codelineno-7-109 name=__codelineno-7-109></a>    <span class=k>return</span> <span class=n>fig</span>
<a id=__codelineno-7-110 name=__codelineno-7-110></a>
<a id=__codelineno-7-111 name=__codelineno-7-111></a>
<a id=__codelineno-7-112 name=__codelineno-7-112></a><span class=k>def</span> <span class=nf>main</span><span class=p>()</span> <span class=o>-&gt;</span> <span class=kc>None</span><span class=p>:</span>
<a id=__codelineno-7-113 name=__codelineno-7-113></a>    <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>sys</span><span class=o>.</span><span class=n>argv</span><span class=p>)</span> <span class=o>!=</span> <span class=mi>3</span><span class=p>:</span>
<a id=__codelineno-7-114 name=__codelineno-7-114></a>        <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Arguments error. Usage:</span><span class=se>\n</span><span class=s2>&quot;</span><span class=p>)</span>
<a id=__codelineno-7-115 name=__codelineno-7-115></a>        <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;</span><span class=se>\t</span><span class=s2>python3 evaluate.py &lt;model-folder&gt; &lt;prepared-dataset-folder&gt;</span><span class=se>\n</span><span class=s2>&quot;</span><span class=p>)</span>
<a id=__codelineno-7-116 name=__codelineno-7-116></a>        <span class=n>exit</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
<a id=__codelineno-7-117 name=__codelineno-7-117></a>
<a id=__codelineno-7-118 name=__codelineno-7-118></a>    <span class=n>model_folder</span> <span class=o>=</span> <span class=n>Path</span><span class=p>(</span><span class=n>sys</span><span class=o>.</span><span class=n>argv</span><span class=p>[</span><span class=mi>1</span><span class=p>])</span>
<a id=__codelineno-7-119 name=__codelineno-7-119></a>    <span class=n>prepared_dataset_folder</span> <span class=o>=</span> <span class=n>Path</span><span class=p>(</span><span class=n>sys</span><span class=o>.</span><span class=n>argv</span><span class=p>[</span><span class=mi>2</span><span class=p>])</span>
<a id=__codelineno-7-120 name=__codelineno-7-120></a>    <span class=n>evaluation_folder</span> <span class=o>=</span> <span class=n>Path</span><span class=p>(</span><span class=s2>&quot;evaluation&quot;</span><span class=p>)</span>
<a id=__codelineno-7-121 name=__codelineno-7-121></a>    <span class=n>plots_folder</span> <span class=o>=</span> <span class=n>Path</span><span class=p>(</span><span class=s2>&quot;plots&quot;</span><span class=p>)</span>
<a id=__codelineno-7-122 name=__codelineno-7-122></a>
<a id=__codelineno-7-123 name=__codelineno-7-123></a>    <span class=c1># Create folders</span>
<a id=__codelineno-7-124 name=__codelineno-7-124></a>    <span class=p>(</span><span class=n>evaluation_folder</span> <span class=o>/</span> <span class=n>plots_folder</span><span class=p>)</span><span class=o>.</span><span class=n>mkdir</span><span class=p>(</span><span class=n>parents</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span> <span class=n>exist_ok</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
<a id=__codelineno-7-125 name=__codelineno-7-125></a>
<a id=__codelineno-7-126 name=__codelineno-7-126></a>    <span class=c1># Load files</span>
<a id=__codelineno-7-127 name=__codelineno-7-127></a>    <span class=n>ds_test</span> <span class=o>=</span> <span class=n>tf</span><span class=o>.</span><span class=n>data</span><span class=o>.</span><span class=n>Dataset</span><span class=o>.</span><span class=n>load</span><span class=p>(</span><span class=nb>str</span><span class=p>(</span><span class=n>prepared_dataset_folder</span> <span class=o>/</span> <span class=s2>&quot;test&quot;</span><span class=p>))</span>
<a id=__codelineno-7-128 name=__codelineno-7-128></a>    <span class=n>labels</span> <span class=o>=</span> <span class=kc>None</span>
<a id=__codelineno-7-129 name=__codelineno-7-129></a>    <span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=n>prepared_dataset_folder</span> <span class=o>/</span> <span class=s2>&quot;labels.json&quot;</span><span class=p>)</span> <span class=k>as</span> <span class=n>f</span><span class=p>:</span>
<a id=__codelineno-7-130 name=__codelineno-7-130></a>        <span class=n>labels</span> <span class=o>=</span> <span class=n>json</span><span class=o>.</span><span class=n>load</span><span class=p>(</span><span class=n>f</span><span class=p>)</span>
<a id=__codelineno-7-131 name=__codelineno-7-131></a>
<a id=__codelineno-7-132 name=__codelineno-7-132></a><span class=hll>    <span class=c1># Import the model to the model store from a local model folder</span>
</span><a id=__codelineno-7-133 name=__codelineno-7-133></a><span class=hll>    <span class=k>try</span><span class=p>:</span>
</span><a id=__codelineno-7-134 name=__codelineno-7-134></a><span class=hll>        <span class=n>bentoml</span><span class=o>.</span><span class=n>models</span><span class=o>.</span><span class=n>import_model</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;</span><span class=si>{</span><span class=n>model_folder</span><span class=si>}</span><span class=s2>/celestial_bodies_classifier_model.bentomodel&quot;</span><span class=p>)</span>
</span><a id=__codelineno-7-135 name=__codelineno-7-135></a><span class=hll>    <span class=k>except</span> <span class=n>bentoml</span><span class=o>.</span><span class=n>exceptions</span><span class=o>.</span><span class=n>BentoMLException</span><span class=p>:</span>
</span><a id=__codelineno-7-136 name=__codelineno-7-136></a><span class=hll>        <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Model already exists in the model store - skipping import.&quot;</span><span class=p>)</span>
</span><a id=__codelineno-7-137 name=__codelineno-7-137></a><span class=hll>
</span><a id=__codelineno-7-138 name=__codelineno-7-138></a>    <span class=c1># Load model</span>
<a id=__codelineno-7-139 name=__codelineno-7-139></a><span class=hll>    <span class=n>model</span> <span class=o>=</span> <span class=n>bentoml</span><span class=o>.</span><span class=n>keras</span><span class=o>.</span><span class=n>load_model</span><span class=p>(</span><span class=s2>&quot;celestial_bodies_classifier_model&quot;</span><span class=p>)</span>
</span><a id=__codelineno-7-140 name=__codelineno-7-140></a>    <span class=n>model_history</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>load</span><span class=p>(</span><span class=n>model_folder</span> <span class=o>/</span> <span class=s2>&quot;history.npy&quot;</span><span class=p>,</span> <span class=n>allow_pickle</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span><span class=o>.</span><span class=n>item</span><span class=p>()</span>
<a id=__codelineno-7-141 name=__codelineno-7-141></a>
<a id=__codelineno-7-142 name=__codelineno-7-142></a>    <span class=c1># Log metrics</span>
<a id=__codelineno-7-143 name=__codelineno-7-143></a>    <span class=n>val_loss</span><span class=p>,</span> <span class=n>val_acc</span> <span class=o>=</span> <span class=n>model</span><span class=o>.</span><span class=n>evaluate</span><span class=p>(</span><span class=n>ds_test</span><span class=p>)</span>
<a id=__codelineno-7-144 name=__codelineno-7-144></a>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Validation loss: </span><span class=si>{</span><span class=n>val_loss</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<a id=__codelineno-7-145 name=__codelineno-7-145></a>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Validation accuracy: </span><span class=si>{</span><span class=n>val_acc</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=mi>100</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>%&quot;</span><span class=p>)</span>
<a id=__codelineno-7-146 name=__codelineno-7-146></a>    <span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=n>evaluation_folder</span> <span class=o>/</span> <span class=s2>&quot;metrics.json&quot;</span><span class=p>,</span> <span class=s2>&quot;w&quot;</span><span class=p>)</span> <span class=k>as</span> <span class=n>f</span><span class=p>:</span>
<a id=__codelineno-7-147 name=__codelineno-7-147></a>        <span class=n>json</span><span class=o>.</span><span class=n>dump</span><span class=p>({</span><span class=s2>&quot;val_loss&quot;</span><span class=p>:</span> <span class=n>val_loss</span><span class=p>,</span> <span class=s2>&quot;val_acc&quot;</span><span class=p>:</span> <span class=n>val_acc</span><span class=p>},</span> <span class=n>f</span><span class=p>)</span>
<a id=__codelineno-7-148 name=__codelineno-7-148></a>
<a id=__codelineno-7-149 name=__codelineno-7-149></a>    <span class=c1># Save training history plot</span>
<a id=__codelineno-7-150 name=__codelineno-7-150></a>    <span class=n>fig</span> <span class=o>=</span> <span class=n>get_training_plot</span><span class=p>(</span><span class=n>model_history</span><span class=p>)</span>
<a id=__codelineno-7-151 name=__codelineno-7-151></a>    <span class=n>fig</span><span class=o>.</span><span class=n>savefig</span><span class=p>(</span><span class=n>evaluation_folder</span> <span class=o>/</span> <span class=n>plots_folder</span> <span class=o>/</span> <span class=s2>&quot;training_history.png&quot;</span><span class=p>)</span>
<a id=__codelineno-7-152 name=__codelineno-7-152></a>
<a id=__codelineno-7-153 name=__codelineno-7-153></a>    <span class=c1># Save predictions preview plot</span>
<a id=__codelineno-7-154 name=__codelineno-7-154></a>    <span class=n>fig</span> <span class=o>=</span> <span class=n>get_pred_preview_plot</span><span class=p>(</span><span class=n>model</span><span class=p>,</span> <span class=n>ds_test</span><span class=p>,</span> <span class=n>labels</span><span class=p>)</span>
<a id=__codelineno-7-155 name=__codelineno-7-155></a>    <span class=n>fig</span><span class=o>.</span><span class=n>savefig</span><span class=p>(</span><span class=n>evaluation_folder</span> <span class=o>/</span> <span class=n>plots_folder</span> <span class=o>/</span> <span class=s2>&quot;pred_preview.png&quot;</span><span class=p>)</span>
<a id=__codelineno-7-156 name=__codelineno-7-156></a>
<a id=__codelineno-7-157 name=__codelineno-7-157></a>    <span class=c1># Save confusion matrix plot</span>
<a id=__codelineno-7-158 name=__codelineno-7-158></a>    <span class=n>fig</span> <span class=o>=</span> <span class=n>get_confusion_matrix_plot</span><span class=p>(</span><span class=n>model</span><span class=p>,</span> <span class=n>ds_test</span><span class=p>,</span> <span class=n>labels</span><span class=p>)</span>
<a id=__codelineno-7-159 name=__codelineno-7-159></a>    <span class=n>fig</span><span class=o>.</span><span class=n>savefig</span><span class=p>(</span><span class=n>evaluation_folder</span> <span class=o>/</span> <span class=n>plots_folder</span> <span class=o>/</span> <span class=s2>&quot;confusion_matrix.png&quot;</span><span class=p>)</span>
<a id=__codelineno-7-160 name=__codelineno-7-160></a>
<a id=__codelineno-7-161 name=__codelineno-7-161></a>    <span class=nb>print</span><span class=p>(</span>
<a id=__codelineno-7-162 name=__codelineno-7-162></a>        <span class=sa>f</span><span class=s2>&quot;</span><span class=se>\n</span><span class=s2>Evaluation metrics and plot files saved at </span><span class=si>{</span><span class=n>evaluation_folder</span><span class=o>.</span><span class=n>absolute</span><span class=p>()</span><span class=si>}</span><span class=s2>&quot;</span>
<a id=__codelineno-7-163 name=__codelineno-7-163></a>    <span class=p>)</span>
<a id=__codelineno-7-164 name=__codelineno-7-164></a>
<a id=__codelineno-7-165 name=__codelineno-7-165></a>
<a id=__codelineno-7-166 name=__codelineno-7-166></a><span class=k>if</span> <span class=vm>__name__</span> <span class=o>==</span> <span class=s2>&quot;__main__&quot;</span><span class=p>:</span>
<a id=__codelineno-7-167 name=__codelineno-7-167></a>    <span class=n>main</span><span class=p>()</span>
</code></pre></div></td></tr></table></div> <p>Check the differences with Git to better understand the changes:</p> <div class=highlight><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>Execute the following command(s) in a terminal</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-8-1>1</a></span>
<span class=normal><a href=#__codelineno-8-2>2</a></span></pre></div></td><td class=code><div><pre><span></span><code><a id=__codelineno-8-1 name=__codelineno-8-1></a><span class=c1># Show the differences with Git</span>
<a id=__codelineno-8-2 name=__codelineno-8-2></a>git<span class=w> </span>diff<span class=w> </span>src/evaluate.py
</code></pre></div></td></tr></table></div> <p>The output should be similar to this:</p> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-9-1> 1</a></span>
<span class=normal><a href=#__codelineno-9-2> 2</a></span>
<span class=normal><a href=#__codelineno-9-3> 3</a></span>
<span class=normal><a href=#__codelineno-9-4> 4</a></span>
<span class=normal><a href=#__codelineno-9-5> 5</a></span>
<span class=normal><a href=#__codelineno-9-6> 6</a></span>
<span class=normal><a href=#__codelineno-9-7> 7</a></span>
<span class=normal><a href=#__codelineno-9-8> 8</a></span>
<span class=normal><a href=#__codelineno-9-9> 9</a></span>
<span class=normal><a href=#__codelineno-9-10>10</a></span>
<span class=normal><a href=#__codelineno-9-11>11</a></span>
<span class=normal><a href=#__codelineno-9-12>12</a></span>
<span class=normal><a href=#__codelineno-9-13>13</a></span>
<span class=normal><a href=#__codelineno-9-14>14</a></span>
<span class=normal><a href=#__codelineno-9-15>15</a></span>
<span class=normal><a href=#__codelineno-9-16>16</a></span>
<span class=normal><a href=#__codelineno-9-17>17</a></span>
<span class=normal><a href=#__codelineno-9-18>18</a></span>
<span class=normal><a href=#__codelineno-9-19>19</a></span>
<span class=normal><a href=#__codelineno-9-20>20</a></span>
<span class=normal><a href=#__codelineno-9-21>21</a></span>
<span class=normal><a href=#__codelineno-9-22>22</a></span>
<span class=normal><a href=#__codelineno-9-23>23</a></span>
<span class=normal><a href=#__codelineno-9-24>24</a></span>
<span class=normal><a href=#__codelineno-9-25>25</a></span>
<span class=normal><a href=#__codelineno-9-26>26</a></span>
<span class=normal><a href=#__codelineno-9-27>27</a></span>
<span class=normal><a href=#__codelineno-9-28>28</a></span>
<span class=normal><a href=#__codelineno-9-29>29</a></span></pre></div></td><td class=code><div><pre><span></span><code><a id=__codelineno-9-1 name=__codelineno-9-1></a><span class=gh>diff --git a/src/evaluate.py b/src/evaluate.py</span>
<a id=__codelineno-9-2 name=__codelineno-9-2></a><span class=gh>index 3bca979..11322bd 100644</span>
<a id=__codelineno-9-3 name=__codelineno-9-3></a><span class=gd>--- a/src/evaluate.py</span>
<a id=__codelineno-9-4 name=__codelineno-9-4></a><span class=gi>+++ b/src/evaluate.py</span>
<a id=__codelineno-9-5 name=__codelineno-9-5></a><span class=gu>@@ -6,6 +6,7 @@ from typing import List</span>
<a id=__codelineno-9-6 name=__codelineno-9-6></a><span class=w> </span>import matplotlib.pyplot as plt
<a id=__codelineno-9-7 name=__codelineno-9-7></a><span class=w> </span>import numpy as np
<a id=__codelineno-9-8 name=__codelineno-9-8></a><span class=w> </span>import tensorflow as tf
<a id=__codelineno-9-9 name=__codelineno-9-9></a><span class=gi>+import bentoml</span>
<a id=__codelineno-9-10 name=__codelineno-9-10></a>
<a id=__codelineno-9-11 name=__codelineno-9-11></a>
<a id=__codelineno-9-12 name=__codelineno-9-12></a><span class=w> </span>def get_training_plot(model_history: dict) -&gt; plt.Figure:
<a id=__codelineno-9-13 name=__codelineno-9-13></a><span class=gu>@@ -128,9 +129,14 @@ def main() -&gt; None:</span>
<a id=__codelineno-9-14 name=__codelineno-9-14></a><span class=w> </span>    with open(prepared_dataset_folder / &quot;labels.json&quot;) as f:
<a id=__codelineno-9-15 name=__codelineno-9-15></a><span class=w> </span>        labels = json.load(f)
<a id=__codelineno-9-16 name=__codelineno-9-16></a>
<a id=__codelineno-9-17 name=__codelineno-9-17></a><span class=gi>+    # Import the model to the model store from a local model folder</span>
<a id=__codelineno-9-18 name=__codelineno-9-18></a><span class=gi>+    try:</span>
<a id=__codelineno-9-19 name=__codelineno-9-19></a><span class=gi>+        bentoml.models.import_model(f&quot;{model_folder}/celestial_bodies_classifier_model.bentomodel&quot;)</span>
<a id=__codelineno-9-20 name=__codelineno-9-20></a><span class=gi>+    except bentoml.exceptions.BentoMLException:</span>
<a id=__codelineno-9-21 name=__codelineno-9-21></a><span class=gi>+        print(&quot;Model already exists in the model store - skipping import.&quot;)</span>
<a id=__codelineno-9-22 name=__codelineno-9-22></a><span class=gi>+</span>
<a id=__codelineno-9-23 name=__codelineno-9-23></a><span class=w> </span>    # Load model
<a id=__codelineno-9-24 name=__codelineno-9-24></a><span class=gd>-    model_path = model_folder / &quot;model.keras&quot;</span>
<a id=__codelineno-9-25 name=__codelineno-9-25></a><span class=gd>-    model = tf.keras.models.load_model(model_path)</span>
<a id=__codelineno-9-26 name=__codelineno-9-26></a><span class=gi>+    model = bentoml.keras.load_model(&quot;celestial_bodies_classifier_model&quot;)</span>
<a id=__codelineno-9-27 name=__codelineno-9-27></a><span class=w> </span>    model_history = np.load(model_folder / &quot;history.npy&quot;, allow_pickle=True).item()
<a id=__codelineno-9-28 name=__codelineno-9-28></a>
<a id=__codelineno-9-29 name=__codelineno-9-29></a><span class=w> </span>    # Log metrics
</code></pre></div></td></tr></table></div> <h3 id=run-the-experiment>Run the experiment<a class=headerlink href=#run-the-experiment title="Permanent link">&para;</a></h3> <div class=highlight><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>Execute the following command(s) in a terminal</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-10-1>1</a></span>
<span class=normal><a href=#__codelineno-10-2>2</a></span></pre></div></td><td class=code><div><pre><span></span><code><a id=__codelineno-10-1 name=__codelineno-10-1></a><span class=c1># Run the experiment. DVC will automatically run all required stages</span>
<a id=__codelineno-10-2 name=__codelineno-10-2></a>dvc<span class=w> </span>repro
</code></pre></div></td></tr></table></div> <p>The experiment now uses BentoML to save and load the model. The resulting model is saved in the <code>model</code> folder and is automatically tracked by DVC. The model is then uploaded to the remote storage bucket when pushing the changes to DVC as well.</p> <p>You can check the models stored in the model store with the following command:</p> <div class=highlight><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>Execute the following command(s) in a terminal</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-11-1>1</a></span>
<span class=normal><a href=#__codelineno-11-2>2</a></span></pre></div></td><td class=code><div><pre><span></span><code><a id=__codelineno-11-1 name=__codelineno-11-1></a><span class=c1># List the models in the model store</span>
<a id=__codelineno-11-2 name=__codelineno-11-2></a>bentoml<span class=w> </span>models<span class=w> </span>list
</code></pre></div></td></tr></table></div> <p>The output should look like this:</p> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-12-1>1</a></span>
<span class=normal><a href=#__codelineno-12-2>2</a></span></pre></div></td><td class=code><div><pre><span></span><code><a id=__codelineno-12-1 name=__codelineno-12-1></a> Tag                                                 Module                   Size      Creation Time
<a id=__codelineno-12-2 name=__codelineno-12-2></a> celestial_bodies_classifier_model:o2bgmsfw3cov4aav  bentoml.keras  9.43 MiB  2024-12-10 10:23:48
</code></pre></div></td></tr></table></div> <h3 id=check-the-changes>Check the changes<a class=headerlink href=#check-the-changes title="Permanent link">&para;</a></h3> <p>Check the changes with Git to ensure that all the necessary files are tracked:</p> <div class=highlight><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>Execute the following command(s) in a terminal</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-13-1>1</a></span>
<span class=normal><a href=#__codelineno-13-2>2</a></span>
<span class=normal><a href=#__codelineno-13-3>3</a></span>
<span class=normal><a href=#__codelineno-13-4>4</a></span>
<span class=normal><a href=#__codelineno-13-5>5</a></span></pre></div></td><td class=code><div><pre><span></span><code><a id=__codelineno-13-1 name=__codelineno-13-1></a><span class=c1># Add all the files</span>
<a id=__codelineno-13-2 name=__codelineno-13-2></a>git<span class=w> </span>add<span class=w> </span>.
<a id=__codelineno-13-3 name=__codelineno-13-3></a>
<a id=__codelineno-13-4 name=__codelineno-13-4></a><span class=c1># Check the changes</span>
<a id=__codelineno-13-5 name=__codelineno-13-5></a>git<span class=w> </span>status
</code></pre></div></td></tr></table></div> <p>The output should look like this.</p> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-14-1>1</a></span>
<span class=normal><a href=#__codelineno-14-2>2</a></span>
<span class=normal><a href=#__codelineno-14-3>3</a></span>
<span class=normal><a href=#__codelineno-14-4>4</a></span>
<span class=normal><a href=#__codelineno-14-5>5</a></span>
<span class=normal><a href=#__codelineno-14-6>6</a></span>
<span class=normal><a href=#__codelineno-14-7>7</a></span>
<span class=normal><a href=#__codelineno-14-8>8</a></span></pre></div></td><td class=code><div><pre><span></span><code><a id=__codelineno-14-1 name=__codelineno-14-1></a>On branch main
<a id=__codelineno-14-2 name=__codelineno-14-2></a>Changes to be committed:
<a id=__codelineno-14-3 name=__codelineno-14-3></a>  (use &quot;git restore --staged &lt;file&gt;...&quot; to unstage)
<a id=__codelineno-14-4 name=__codelineno-14-4></a>    modified:   dvc.lock
<a id=__codelineno-14-5 name=__codelineno-14-5></a>    modified:   requirements-freeze.txt
<a id=__codelineno-14-6 name=__codelineno-14-6></a>    modified:   requirements.txt
<a id=__codelineno-14-7 name=__codelineno-14-7></a>    modified:   src/evaluate.py
<a id=__codelineno-14-8 name=__codelineno-14-8></a>    modified:   src/train.py
</code></pre></div></td></tr></table></div> <h3 id=commit-the-changes-to-git>Commit the changes to Git<a class=headerlink href=#commit-the-changes-to-git title="Permanent link">&para;</a></h3> <p>Commit the changes to Git:</p> <div class=highlight><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>Execute the following command(s) in a terminal</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-15-1>1</a></span>
<span class=normal><a href=#__codelineno-15-2>2</a></span></pre></div></td><td class=code><div><pre><span></span><code><a id=__codelineno-15-1 name=__codelineno-15-1></a><span class=c1># Commit the changes</span>
<a id=__codelineno-15-2 name=__codelineno-15-2></a>git<span class=w> </span>commit<span class=w> </span>-m<span class=w> </span><span class=s2>&quot;Use BentoML ton save and load the model&quot;</span>
</code></pre></div></td></tr></table></div> <h2 id=summary>Summary<a class=headerlink href=#summary title="Permanent link">&para;</a></h2> <p>In this chapter, you have successfully:</p> <ol> <li>Installed BentoML</li> <li>Learned about BentoML's model store</li> <li>Updated and ran the experiment to use BentoML to save and load the model to and from the model's store</li> </ol> <p>You did fix some of the previous issues:</p> <ul class=task-list> <li class=task-list-item><label class=task-list-control><input type=checkbox checked><span class=task-list-indicator></span></label> Model can be saved and loaded with all required artifacts for future usage</li> </ul> <p>You can now safely continue to the next chapter.</p> <h2 id=state-of-the-mlops-process>State of the MLOps process<a class=headerlink href=#state-of-the-mlops-process title="Permanent link">&para;</a></h2> <ul class=task-list> <li class=task-list-item><label class=task-list-control><input type=checkbox checked><span class=task-list-indicator></span></label> Notebook has been transformed into scripts for production</li> <li class=task-list-item><label class=task-list-control><input type=checkbox checked><span class=task-list-indicator></span></label> Codebase and dataset are versioned</li> <li class=task-list-item><label class=task-list-control><input type=checkbox checked><span class=task-list-indicator></span></label> Steps used to create the model are documented and can be re-executed</li> <li class=task-list-item><label class=task-list-control><input type=checkbox checked><span class=task-list-indicator></span></label> Changes done to a model can be visualized with parameters, metrics and plots to identify differences between iterations</li> <li class=task-list-item><label class=task-list-control><input type=checkbox checked><span class=task-list-indicator></span></label> Model can be saved and loaded with all required artifacts for future usage</li> <li class=task-list-item><label class=task-list-control><input type=checkbox><span class=task-list-indicator></span></label> Model cannot be easily used from outside of the experiment context</li> </ul> <p>You will address these issues in the next chapters for improved efficiency and collaboration. Continue the guide to learn how.</p> <h2 id=sources>Sources<a class=headerlink href=#sources title="Permanent link">&para;</a></h2> <p>Highly inspired by:</p> <ul> <li><a href=https://docs.bentoml.com/en/latest/get-started/quickstart.html><em>Quickstart</em> - docs.bentoml.com</a></li> <li><a href=https://docs.bentoml.com/en/latest/reference/frameworks/keras.html><em>Keras</em> - docs.bentoml.com</a></li> <li><a href=https://docs.bentoml.com/en/latest/guides/model-store.html><em>Model Store</em> - docs.bentoml.com</a></li> <li><a href=https://docs.bentoml.com/en/latest/reference/stores.html><em>Bento and model APIs</em> - docs.bentoml.com</a></li> <li><a href=https://docs.bentoml.com/en/latest/reference/sdk.html><em>BentoML SDK</em> - docs.bentoml.com</a></li> <li><a href=https://docs.bentoml.com/en/latest/reference/cli.html><em>BentoML CLI</em> - docs.bentoml.com</a></li> </ul> <aside class=md-source-file> <span class=md-source-file__fact> <span class=md-icon title="Last update"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M21 13.1c-.1 0-.3.1-.4.2l-1 1 2.1 2.1 1-1c.2-.2.2-.6 0-.8l-1.3-1.3c-.1-.1-.2-.2-.4-.2m-1.9 1.8-6.1 6V23h2.1l6.1-6.1zM12.5 7v5.2l4 2.4-1 1L11 13V7zM11 21.9c-5.1-.5-9-4.8-9-9.9C2 6.5 6.5 2 12 2c5.3 0 9.6 4.1 10 9.3-.3-.1-.6-.2-1-.2s-.7.1-1 .2C19.6 7.2 16.2 4 12 4c-4.4 0-8 3.6-8 8 0 4.1 3.1 7.5 7.1 7.9l-.1.2z"/></svg> </span> <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-datetime">February 3, 2025 13:43:14</span> </span> </aside> </article> </div> <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var labels=set.querySelector(".tabbed-labels");for(var tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script> <script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script> </div> <button type=button class="md-top md-icon" data-md-component=top hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg> Back to top </button> </main> <footer class=md-footer> <nav class="md-footer__inner md-grid" aria-label=Footer> <a href=../introduction/ class="md-footer__link md-footer__link--prev" aria-label="Previous: Introduction"> <div class="md-footer__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg> </div> <div class=md-footer__title> <span class=md-footer__direction> Previous </span> <div class=md-ellipsis> Introduction </div> </div> </a> <a href=../chapter-32-serve-the-model-locally-with-bentoml/ class="md-footer__link md-footer__link--next" aria-label="Next: Chapter 3.2 - Serve the model locally with BentoML"> <div class=md-footer__title> <span class=md-footer__direction> Next </span> <div class=md-ellipsis> Chapter 3.2 - Serve the model locally with BentoML </div> </div> <div class="md-footer__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11z"/></svg> </div> </a> </nav> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-copyright> <div class=md-copyright__highlight> Copyright &copy; 2025 Swiss AI Center </div> Made with <a href=https://squidfunk.github.io/mkdocs-material/ target=_blank rel=noopener> Material for MkDocs </a> </div> <div class=md-social> <a href=https://swiss-ai-center.ch target=_blank rel=noopener title="Swiss AI Center" class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M17.9 17.39c-.26-.8-1.01-1.39-1.9-1.39h-1v-3a1 1 0 0 0-1-1H8v-2h2a1 1 0 0 0 1-1V7h2a2 2 0 0 0 2-2v-.41a7.984 7.984 0 0 1 2.9 12.8M11 19.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.22.21-1.79L9 15v1a2 2 0 0 0 2 2m1-16A10 10 0 0 0 2 12a10 10 0 0 0 10 10 10 10 0 0 0 10-10A10 10 0 0 0 12 2"/></svg> </a> <a href=https://github.com/swiss-ai-center target=_blank rel=noopener title="Swiss AI Center on GitHub" class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 2A10 10 0 0 0 2 12c0 4.42 2.87 8.17 6.84 9.5.5.08.66-.23.66-.5v-1.69c-2.77.6-3.36-1.34-3.36-1.34-.46-1.16-1.11-1.47-1.11-1.47-.91-.62.07-.6.07-.6 1 .07 1.53 1.03 1.53 1.03.87 1.52 2.34 1.07 2.91.83.09-.65.35-1.09.63-1.34-2.22-.25-4.55-1.11-4.55-4.92 0-1.11.38-2 1.03-2.71-.1-.25-.45-1.29.1-2.64 0 0 .84-.27 2.75 1.02.79-.22 1.65-.33 2.5-.33s1.71.11 2.5.33c1.91-1.29 2.75-1.02 2.75-1.02.55 1.35.2 2.39.1 2.64.65.71 1.03 1.6 1.03 2.71 0 3.82-2.34 4.66-4.57 4.91.36.31.69.92.69 1.85V21c0 .27.16.59.67.5C19.14 20.16 22 16.42 22 12A10 10 0 0 0 12 2"/></svg> </a> </div> </div> </div> </footer> </div> <div class=md-dialog data-md-component=dialog> <div class="md-dialog__inner md-typeset"></div> </div> <script id=__config type=application/json>{"base": "../..", "features": ["announce.dismiss", "content.code.annotate", "content.code.copy", "content.action.edit", "content.action.view", "content.tabs.link", "navigation.indexes", "navigation.instant", "navigation.tabs", "navigation.tabs.sticky", "navigation.top", "navigation.footer", "search.suggest", "search.highlight", "toc.follow"], "search": "../../assets/javascripts/workers/search.6ce7567c.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script> <script src=../../assets/javascripts/bundle.83f73b43.min.js></script> <script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script> <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> <script src=https://unpkg.com/tablesort@5.3.0/dist/tablesort.min.js></script> <script src=../../assets/javascripts/mathjax.js></script> <script src=../../assets/javascripts/tablesort.js></script> <script src=../../assets/javascripts/parallax.js></script> <script src=../../assets/javascripts/scrollAnimations.js></script> <script id=init-glightbox>const lightbox = GLightbox({"touchNavigation": true, "loop": false, "zoomable": true, "draggable": true, "openEffect": "zoom", "closeEffect": "zoom", "slideEffect": "slide"});
document$.subscribe(() => { lightbox.reload() });
</script></body> </html>